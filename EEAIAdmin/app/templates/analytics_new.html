<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Finstack</title>

    <!-- Chart Libraries -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/drilldown.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/heatmap.js"></script>
    <script src="https://code.highcharts.com/modules/treemap.js"></script>
    <script src="https://code.highcharts.com/modules/sankey.js"></script>
    <script src="https://code.highcharts.com/modules/dependency-wheel.js"></script>
    <script src="https://code.highcharts.com/modules/networkgraph.js"></script>
    <script src="https://code.highcharts.com/modules/pattern-fill.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/modules/sunburst.js"></script>
    <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>

    <!-- ApexCharts as secondary option -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- MDI Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Stylesheets -->
    <link href="{{ url_for('static', filename='css/finstack-master.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/global-components.css') }}" rel="stylesheet">

    <style>
        /* Modern Variables */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --glass-bg: rgba(0, 0, 0, 0.1);
                --glass-border: rgba(255, 255, 255, 0.1);
            }
        }

        /* Modern Floating Header */
        .floating-header {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .floating-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Brand Section */
        .brand-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-container {
            position: relative;
        }

        .modern-logo {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: logoFloat 4s ease-in-out infinite;
        }

        .modern-logo:hover {
            transform: scale(1.05) rotate(2deg);
            border-color: rgba(99, 102, 241, 0.3);
            background: rgba(99, 102, 241, 0.1);
        }

        .status-pulse {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.9);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .brand-info h1 {
            font-size: 24px !important;
            font-weight: 800 !important;
            margin: 0 !important;
            background: linear-gradient(135deg, #1e293b, #475569, #64748b);
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            letter-spacing: -0.5px;
        }

        .brand-info p {
            font-size: 13px !important;
            color: rgba(100, 116, 139, 0.8) !important;
            margin: 0 !important;
            font-weight: 500 !important;
        }

        /* Navigation Pills */
        .nav-pills {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 4px;
        }

        .nav-pill {
            display: flex !important;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 12px;
            text-decoration: none !important;
            color: rgba(100, 116, 139, 0.8) !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-pill:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(30, 41, 59, 0.9) !important;
            transform: translateY(-1px);
        }

        .nav-pill.active {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #1e293b !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-pill i {
            font-size: 16px;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-filter-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
        }

        .date-filter-container input[type="date"] {
            background: transparent;
            border: none;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            outline: none;
        }

        .status-indicator-modern {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            color: #059669;
        }

        .pulse-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .action-button {
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            padding: 10px 18px !important;
            border-radius: 12px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            text-decoration: none !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .action-button.primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 70%, #06b6d4 100%) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .action-button.primary:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4) !important;
        }

        .action-button.secondary {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #374151 !important;
            border: 1px solid rgba(229, 231, 235, 0.8) !important;
        }

        .action-button.secondary:hover {
            background: rgba(255, 255, 255, 1) !important;
            color: #1f2937 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }

        /* Animations */
        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-2px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* Adjust main content padding */
        .pt-40 {
            padding-top: 120px !important;
        }

        /* Mobile Responsiveness */
        @media (max-width: 1200px) {
            .nav-pills {
                gap: 4px;
            }

            .nav-pill {
                padding: 6px 12px;
                font-size: 12px;
            }

            .nav-pill span {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .floating-header {
                top: 12px;
                left: 12px;
                right: 12px;
            }

            .floating-header-content {
                padding: 12px 20px;
            }

            .brand-info p {
                display: none !important;
            }

            .nav-pills {
                display: none;
            }

            .header-actions {
                gap: 8px;
            }

            .action-button span {
                display: none !important;
            }

            .action-button {
                padding: 8px 12px !important;
            }

            .pt-40 {
                padding-top: 100px !important;
            }
        }

        @media (max-width: 480px) {
            .status-indicator-modern {
                display: none;
            }

            .brand-info h1 {
                font-size: 20px !important;
            }
        }

        /* Body and content adjustments */
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding-top: 120px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        /* Main content styling */
        .main-content {
            background: transparent;
            min-height: calc(100vh - 80px);
            padding-top: 100px;
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Enhanced glass card styling */
        .glass-card {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 16px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08) !important;
        }

        /* Advanced Filter Section */
        .filter-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }

        .filter-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .filter-section.loading::before {
            opacity: 1;
            animation: shimmer 1.5s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            position: relative;
        }

        .filter-label::before {
            content: '';
            width: 4px;
            height: 4px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 50%;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .filter-select, .filter-input {
            position: relative;
            width: 100%;
            padding: 14px 18px;
            border: 2px solid transparent;
            border-radius: 20px;
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(139, 92, 246, 0.3) 100%) border-box;
            color: #1f2937;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M6 9l6 6 6-6'/%3e%3c/svg%3e"),
                             linear-gradient(white, white) padding-box,
                             linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(139, 92, 246, 0.3) 100%) border-box;
            background-repeat: no-repeat;
            background-position: right 16px center, 0 0, 0 0;
            background-size: 18px, 100% 100%, 100% 100%;
            padding-right: 48px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.08),
                       0 1px 2px rgba(0, 0, 0, 0.05);
            letter-spacing: 0.2px;
        }

        .filter-select:focus, .filter-input:focus {
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(135deg, rgba(99, 102, 241, 0.6) 0%, rgba(139, 92, 246, 0.6) 100%) border-box;
            box-shadow: 0 0 0 5px rgba(99, 102, 241, 0.12),
                       0 8px 24px rgba(99, 102, 241, 0.18),
                       0 2px 8px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px) scale(1.01);
        }

        .filter-select:hover:not(:focus) {
            background: linear-gradient(white, white) padding-box,
                       linear-gradient(135deg, rgba(99, 102, 241, 0.5) 0%, rgba(139, 92, 246, 0.5) 100%) border-box;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.12),
                       0 2px 4px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }

        .filter-select:active {
            transform: translateY(0) scale(0.99);
        }

        /* Animated dropdown arrow */
        .filter-select:focus {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M6 9l6 6 6-6'/%3e%3c/svg%3e"),
                             linear-gradient(white, white) padding-box,
                             linear-gradient(135deg, rgba(99, 102, 241, 0.6) 0%, rgba(139, 92, 246, 0.6) 100%) border-box;
        }

        .filter-select option {
            padding: 16px 20px;
            background: white;
            color: #1f2937;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            line-height: 1.5;
            border-bottom: 1px solid transparent;
        }

        .filter-select option:hover,
        .filter-select option:focus {
            background: #f0f9ff;
            color: #4f46e5;
            box-shadow: inset 3px 0 0 #6366f1;
        }

        .filter-select option:checked {
            background: linear-gradient(90deg, #ede9fe 0%, #f3f4f6 100%);
            color: #4f46e5;
            font-weight: 700;
            box-shadow: inset 4px 0 0 #6366f1;
        }

        .filter-select option:disabled {
            color: #9ca3af;
            cursor: not-allowed;
            font-style: italic;
        }

        /* Better visual separation for option groups */
        .filter-select optgroup {
            font-weight: 700;
            color: #1e293b;
            background: #f8fafc;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 20px;
            border-top: 2px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }

        .filter-select optgroup option {
            font-weight: 500;
            text-transform: none;
            letter-spacing: normal;
            margin-left: 12px;
        }

        /* Enhance the overall select dropdown appearance */
        .filter-select {
            /* For better dropdown appearance in supporting browsers */
            background-color: white;
        }

        /* Firefox specific improvements */
        @-moz-document url-prefix() {
            .filter-select option {
                padding: 14px;
                background-color: white;
            }

            .filter-select option:hover {
                background-color: #f0f9ff;
            }

            .filter-select option:checked {
                background-color: #ede9fe;
            }
        }

        /* Webkit browsers (Chrome, Safari) improvements */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            .filter-select option {
                padding: 14px 16px;
                line-height: 1.6;
            }
        }

        /* KPI Cards with Animation */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 32px;
            transition: var(--transition-smooth);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: var(--primary-gradient);
            transition: left 0.5s ease;
        }

        .kpi-card:hover::before {
            left: 0;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .kpi-icon-container {
            width: 64px;
            height: 64px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .kpi-icon-container.gradient-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .kpi-icon-container.gradient-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .kpi-icon-container.gradient-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .kpi-icon-container.gradient-4 {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 8px;
            line-height: 1;
        }

        .kpi-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .kpi-trend.positive {
            color: #10b981;
        }

        .kpi-trend.negative {
            color: #ef4444;
        }

        /* Chart Container Styles */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 32px;
            margin-bottom: 48px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            transition: var(--transition-smooth);
            position: relative;
            min-height: 400px;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .chart-actions {
            display: flex;
            gap: 8px;
        }

        .chart-action-btn {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 12px;
            color: #6b7280;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .chart-action-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }

        /* Modal for Chart Details */
        .chart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .chart-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #ef4444;
            color: white;
        }

        /* Real-time Update Indicator */
        .realtime-indicator {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 20px;
            font-size: 12px;
            color: #059669;
            font-weight: 600;
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Advanced Chart Types */
        .chart-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 4px;
            background: #f3f4f6;
            border-radius: 12px;
        }

        .chart-type-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .chart-type-btn.active {
            background: white;
            color: #6366f1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced Data Table */
        .data-table-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            position: relative;
            min-height: 500px;
            margin-bottom: 32px;
        }

        .table-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248, 250, 252, 0.8);
        }

        .table-search {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            width: 300px;
        }

        .table-search input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 14px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8fafc;
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
        }

        .data-table th:hover {
            background: #f1f5f9;
        }

        .data-table th i {
            margin-left: 8px;
            font-size: 10px;
            color: #94a3b8;
        }

        .data-table td {
            padding: 16px;
            font-size: 14px;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s ease;
        }

        .data-table tr:hover td {
            background: rgba(99, 102, 241, 0.02);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-badge.status-authorised {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-badge.status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .status-badge.status-released {
            background: rgba(99, 102, 241, 0.1);
            color: #4f46e5;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .status-badge.status-rejected {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Transaction Details Drawer */
        .transaction-drawer {
            position: fixed;
            right: -500px;
            top: 0;
            width: 500px;
            height: 100vh;
            background: white;
            box-shadow: -8px 0 24px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1500;
            overflow-y: auto;
        }

        .transaction-drawer.active {
            right: 0;
        }

        .drawer-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }

        .drawer-content {
            padding: 24px;
        }

        .detail-section {
            margin-bottom: 32px;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .detail-value {
            font-size: 16px;
            color: #1e293b;
            font-weight: 500;
        }

        /* Drill-down Panel */
        .drilldown-panel {
            display: none;
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            z-index: 1600;
            animation: slideUpBounce 0.4s ease;
            max-height: 80vh;
            overflow: auto;
        }

        .drilldown-panel.active {
            display: block;
        }

        @keyframes slideUpBounce {
            0% {
                transform: translate(-50%, 100px);
                opacity: 0;
            }
            60% {
                transform: translate(-50%, -10px);
            }
            100% {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .drilldown-header {
            padding: 32px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 24px 24px 0 0;
        }

        .drilldown-content {
            padding: 32px;
        }

        .drilldown-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        /* Network Node Styles */
        .network-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .network-node:hover {
            filter: brightness(1.2);
            transform: scale(1.1);
        }

        .node-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .node-tooltip.active {
            display: block;
        }

        /* Animations */
        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-2px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* New Animations for Header */
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes iconRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes logoShine {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes statusRing {
            0%, 100% {
                transform: scale(1);
                opacity: 0.4;
            }
            50% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        @keyframes spinOnce {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes settingsSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Loading States */
        .chart-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f4f6;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Enhanced dropdown options styling */
        .filter-select optgroup {
            font-weight: 700;
            color: #1e293b;
            background: #f8fafc;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Custom dropdown container for better styling */
        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15),
                       0 0 0 1px rgba(99, 102, 241, 0.1);
            overflow: hidden;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .custom-dropdown.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        .custom-dropdown-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            color: #475569;
            position: relative;
            overflow: hidden;
        }

        .custom-dropdown-item:last-child {
            border-bottom: none;
        }

        .custom-dropdown-item:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
            color: #4f46e5;
            padding-left: 24px;
        }

        .custom-dropdown-item.selected {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            color: #4f46e5;
            font-weight: 600;
        }

        .custom-dropdown-item.selected::before {
            content: '✓';
            position: absolute;
            left: 20px;
            color: #6366f1;
            font-weight: bold;
        }

        .custom-dropdown-item .item-badge {
            font-size: 11px;
            padding: 2px 8px;
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            border-radius: 12px;
            margin-left: auto;
            font-weight: 600;
        }

        /* Scrollbar styling for dropdown */
        .custom-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .custom-dropdown::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-dropdown::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #6366f1, #8b5cf6);
            border-radius: 3px;
        }

        .custom-dropdown::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #4f46e5, #7c3aed);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }

            .nav-pill span {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .floating-header {
                top: 12px;
                left: 12px;
                right: 12px;
            }

            .floating-header-content {
                padding: 12px 20px;
            }

            .nav-pills {
                display: none;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            body {
                padding-top: 100px;
            }

            .page-container {
                padding: 20px;
            }

            .date-filter-container {
                display: none;
            }

            .transaction-drawer {
                width: 100%;
            }
        }

        /* Export Menu Styles */
        .export-menu {
            position: relative;
        }

        .export-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 8px;
            min-width: 200px;
            display: none;
            z-index: 100;
        }

        .export-dropdown.active {
            display: block;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 14px;
            color: #374151;
        }

        .export-option:hover {
            background: #f3f4f6;
            color: #6366f1;
        }

        .export-option i {
            width: 20px;
            text-align: center;
        }

        /* Interactive Features */
        .interactive-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .interactive-tooltip.active {
            display: block;
        }

        /* Chart Controls */
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .time-range-selector {
            display: flex;
            gap: 8px;
        }

        .time-range-btn {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .time-range-btn.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .time-range-btn:hover:not(.active) {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        /* Date Picker Modal Styles */
        .date-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .date-picker-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
        }

        .date-picker-content h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .date-inputs {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }

        .date-inputs label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #475569;
        }

        .date-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition-smooth);
        }

        .date-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .date-picker-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .date-picker-actions button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .date-picker-actions .btn-primary {
            background: #6366f1;
            color: white;
            border: none;
        }

        .date-picker-actions .btn-primary:hover {
            background: #4f46e5;
        }

        .date-picker-actions .btn-secondary {
            background: white;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .date-picker-actions .btn-secondary:hover {
            background: #f3f4f6;
        }

        /* Comparison Mode */
        .comparison-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .comparison-toggle:hover {
            border-color: #6366f1;
        }

        .comparison-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Advanced Features Panel */
        .advanced-panel {
            position: fixed;
            right: -400px;
            top: 100px;
            width: 400px;
            height: calc(100vh - 120px);
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1500;
            border-radius: 16px 0 0 16px;
            overflow: auto;
        }

        .advanced-panel.active {
            right: 0;
        }

        .panel-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 24px;
        }

        .panel-section {
            margin-bottom: 32px;
        }

        .panel-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        /* Settings Toggle */
        .settings-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 56px;
            height: 56px;
            background: #6366f1;
            color: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            transition: var(--transition-smooth);
            z-index: 1000;
        }

        .settings-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.4);
        }

        /* Module Drill-down Styles */
        .module-detail-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .module-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .module-stat {
            text-align: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .module-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .module-stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #64748b;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .breadcrumb-item:hover {
            color: #6366f1;
        }

        .breadcrumb-separator {
            color: #cbd5e1;
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #6b7280;
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 14px;
            font-weight: 500;
        }

        .pagination-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
        }

        .pagination-btn.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Action Menu */
        .action-menu {
            position: relative;
            display: inline-block;
        }

        .action-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 160px;
            display: none;
            z-index: 100;
        }

        .action-menu-dropdown.active {
            display: block;
        }

        .action-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            color: #374151;
        }

        .action-menu-item:hover {
            background: #f3f4f6;
        }

        .action-menu-item i {
            width: 16px;
            text-align: center;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Modern Floating Header -->
    <div class="floating-header">
        <div class="floating-header-content">
            <!-- Brand Section -->
            <div class="brand-section">
                <button class="toggle-sidebar-btn" onclick="toggleSidebar()" style="margin-right: 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 10px 14px; color: rgba(100, 116, 139, 0.8); cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-bars" style="font-size: 16px;"></i>
                </button>
                <div class="logo-container">
                    <div class="modern-logo">
                        <svg width="28" height="28" viewBox="0 0 48 48">
                            <defs>
                                <linearGradient id="logoGradientHeader" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#6366f1"/>
                                    <stop offset="50%" style="stop-color:#8b5cf6"/>
                                    <stop offset="100%" style="stop-color:#06b6d4"/>
                                </linearGradient>
                            </defs>
                            <g fill="url(#logoGradientHeader)">
                                <rect x="8" y="8" width="8" height="32" rx="3"/>
                                <rect x="8" y="8" width="24" height="8" rx="3"/>
                                <rect x="8" y="20" width="20" height="8" rx="3"/>
                            </g>
                            <g fill="url(#logoGradientHeader)" opacity="0.6">
                                <rect x="20" y="32" width="20" height="2" rx="1"/>
                                <rect x="20" y="36" width="20" height="2" rx="1"/>
                            </g>
                        </svg>
                        <div class="status-pulse"></div>
                    </div>
                </div>
                <div class="brand-info">
                    <h1 class="brand-title"> Finstack </h1>
                    <p class="brand-subtitle"> Analytics Intelligence </p>
                </div>
            </div>

            <!-- Navigation Pills -->
            <nav class="nav-pills">
                <a href="/" class="nav-pill ">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/analytics" class="nav-pill active">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
                <a href="/ai-chat" class="nav-pill ">
                    <i class="fas fa-robot"></i>
                    <span>AI Chat</span>
                </a>
                <a href="/compliance-results" class="nav-pill">
                    <i class="fas fa-shield-check"></i>
                    <span>Vetting</span>
                </a>
                <a href="/document-classification" class="nav-pill">
                    <i class="fas fa-file-document"></i>
                    <span>Documents</span>
                </a>
            </nav>

            <!-- Actions -->
            <div class="header-actions">
                <div class="status-indicator-modern">
                    <div class="pulse-dot"></div>
                    <span>Online</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pt-40 pb-12 px-6">
        <div class="page-container">
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;">
                <div class="breadcrumb-item" onclick="navigateToOverview()">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics Overview</span>
                </div>
                <span class="breadcrumb-separator">/</span>
                <div class="breadcrumb-item" id="breadcrumbModule">
                    <span>Module Details</span>
                </div>
            </div>

            <!-- Advanced Filter Section -->
            <div class="filter-section">
                <div class="filter-grid">
                    <div class="filter-item">
                        <label class="filter-label">Date Range</label>
                        <select class="filter-select" id="dateRangeFilter" onchange="applyDateRangeFilter()">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="3months">Last 3 Months</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Repository</label>
                        <select class="filter-select" id="repositoryFilter" onchange="applyFilters()">
                            <option value="">All Repositories</option>
                            <option value="Trade Finance">Trade Finance</option>
                            <option value="Treasury">Treasury</option>
                            <option value="Cash Management">Cash Management</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Module</label>
                        <select class="filter-select" id="moduleFilter" onchange="applyFilters()">
                            <option value="">All Modules</option>
                            <option value="IMCO">Import Collections (IMCO)</option>
                            <option value="INFI">Inward Finance (INFI)</option>
                            <option value="IMLC">Import LC (IMLC)</option>
                            <option value="MESG">Messages (MESG)</option>
                            <option value="SHGT">Shipping Guarantee (SHGT)</option>
                            <option value="OWGT">Outward Guarantee (OWGT)</option>
                            <option value="FXHD">FX Hedging (FXHD)</option>
                            <option value="SWAP">Interest Rate Swaps</option>
                            <option value="MKTD">Money Market (MKTD)</option>
                            <option value="CASH">Cash Management</option>
                            <option value="POOL">Cash Pooling</option>
                            <option value="PAYM">Payment Processing</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                            <option value="">All Status</option>
                            <option value="authorised">Authorised</option>
                            <option value="pending">Pending</option>
                            <option value="released">Released</option>
                            <option value="rejected">Rejected</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Amount Range</label>
                        <select class="filter-select" id="amountFilter" onchange="applyFilters()">
                            <option value="">All Amounts</option>
                            <option value="0-50000">AED 0 - 50K</option>
                            <option value="50000-200000">AED 50K - 200K</option>
                            <option value="200000-500000">AED 200K - 500K</option>
                            <option value="500000-1000000">AED 500K - 1M</option>
                            <option value="1000000-5000000">AED 1M - 5M</option>
                            <option value="5000000+">AED 5M+</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                    <div id="filterResultsCount" style="font-size: 14px; color: #64748b; font-weight: 500; opacity: 0; transition: opacity 0.3s ease;">
                        <i class="fas fa-filter" style="margin-right: 6px; font-size: 12px;"></i>
                        <span id="resultsText">Showing all transactions</span>
                    </div>
                    <button class="action-button" style="background: #f3f4f6; color: #374151;" onclick="resetFilters()">
                        <i class="fas fa-redo"></i>
                        Reset
                    </button>
                </div>
            </div>

            <!-- Main Dashboard View -->
            <div id="mainDashboard">
                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card" onclick="showDetailedMetrics('transactions')">
                        <div class="kpi-icon-container gradient-1">
                            <i class="fas fa-exchange-alt" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div class="kpi-value">0</div>
                        <div class="kpi-label">Total Transactions</div>
                        <div class="kpi-trend" id="transactionsTrend">
                            <i class="fas fa-info-circle"></i>
                            <span>Loading trend data...</span>
                        </div>
                    </div>

                    <div class="kpi-card" onclick="showDetailedMetrics('value')">
                        <div class="kpi-icon-container gradient-2">
                            <i class="fas fa-dollar-sign" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div class="kpi-value">AED 0.0M</div>
                        <div class="kpi-label">Total Value</div>
                        <div class="kpi-trend" id="valueTrend">
                            <i class="fas fa-info-circle"></i>
                            <span>Loading trend data...</span>
                        </div>
                    </div>

                    <div class="kpi-card" onclick="showDetailedMetrics('pending')">
                        <div class="kpi-icon-container gradient-3">
                            <i class="fas fa-clock" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div class="kpi-value">0</div>
                        <div class="kpi-label">Pending Approval</div>
                        <div class="kpi-trend" id="pendingTrend">
                            <i class="fas fa-info-circle"></i>
                            <span>Loading trend data...</span>
                        </div>
                    </div>

                    <div class="kpi-card" onclick="showDetailedMetrics('approved')">
                        <div class="kpi-icon-container gradient-4">
                            <i class="fas fa-check-circle" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div class="kpi-value">0</div>
                        <div class="kpi-label">Approved</div>
                        <div class="kpi-trend" id="approvedTrend">
                            <i class="fas fa-info-circle"></i>
                            <span>Loading trend data...</span>
                        </div>
                    </div>
                </div>

                <!-- Main Chart Grid -->
                <div class="chart-grid">
                    <!-- Transaction Volume Chart -->
                    <div class="chart-container" id="volumeChartContainer">
                        <!--div class="realtime-indicator">
                            <div class="realtime-dot"></div>
                            <span>Real-time</span>
                        </div-->
                        <div class="chart-header">
                            <h3 class="chart-title">Transaction Volume Analysis</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="toggleChartType('volume')">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                <button class="chart-action-btn" onclick="expandChart('volume')">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <div class="export-menu">
                                    <button class="chart-action-btn" onclick="toggleExportMenu('volume')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <div class="export-dropdown" id="volumeExportMenu">
                                        <div class="export-option" onclick="exportChart('volume', 'png')">
                                            <i class="fas fa-image"></i>
                                            <span>Export as PNG</span>
                                        </div>
                                        <div class="export-option" onclick="exportChart('volume', 'pdf')">
                                            <i class="fas fa-file-pdf"></i>
                                            <span>Export as PDF</span>
                                        </div>
                                        <div class="export-option" onclick="exportChart('volume', 'csv')">
                                            <i class="fas fa-file-csv"></i>
                                            <span>Export as CSV</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-controls" style="display: none;">
                            <div class="time-range-selector">
                                <button class="time-range-btn" onclick="changeTimeRange('volume', '1D', event)">1D</button>
                                <button class="time-range-btn" onclick="changeTimeRange('volume', '1W', event)">1W</button>
                                <button class="time-range-btn active" onclick="changeTimeRange('volume', '1M', event)">1M</button>
                                <button class="time-range-btn" onclick="changeTimeRange('volume', '3M', event)">3M</button>
                                <button class="time-range-btn" onclick="changeTimeRange('volume', '1Y', event)">1Y</button>
                                <button class="time-range-btn custom-date-btn" onclick="showCustomDatePicker('volume', event)">
                                    <i class="fas fa-calendar-alt"></i> Custom
                                </button>
                            </div>
                            <div class="comparison-toggle">
                                <input type="checkbox" id="compareVolume" onchange="toggleComparison('volume')">
                                <label for="compareVolume">Compare with previous period</label>
                            </div>
                        </div>
                        <div id="volumeChart" style="height: 350px;"></div>
                        <div class="chart-loading" id="volumeLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>

                    <!-- Status Distribution Chart -->
                    <div class="chart-container" id="statusChartContainer">
                        <div class="chart-header">
                            <h3 class="chart-title">Status Distribution</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="toggleChartType('status')">
                                    <i class="fas fa-chart-pie"></i>
                                </button>
                                <button class="chart-action-btn" onclick="expandChart('status')">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <div class="export-menu">
                                    <button class="chart-action-btn" onclick="toggleExportMenu('status')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <div class="export-dropdown" id="statusExportMenu">
                                        <div class="export-option" onclick="exportChart('status', 'png')">
                                            <i class="fas fa-image"></i>
                                            <span>Export as PNG</span>
                                        </div>
                                        <div class="export-option" onclick="exportChart('status', 'pdf')">
                                            <i class="fas fa-file-pdf"></i>
                                            <span>Export as PDF</span>
                                        </div>
                                        <div class="export-option" onclick="exportChart('status', 'csv')">
                                            <i class="fas fa-file-csv"></i>
                                            <span>Export as CSV</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-type-selector">
                            <button class="chart-type-btn active" onclick="changeStatusChartType('pie')">Pie Chart</button>
                            <button class="chart-type-btn" onclick="changeStatusChartType('donut')">Donut Chart</button>
                            <button class="chart-type-btn" onclick="changeStatusChartType('3d')">3D Pie</button>
                            <button class="chart-type-btn" onclick="changeStatusChartType('treemap')">Treemap</button>
                        </div>
                        <div id="statusChart" style="height: 350px;"></div>
                        <div class="chart-loading" id="statusLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Additional Charts Row -->
                <div class="chart-grid">
                    <!-- Trend Analysis Chart -->
                    <div class="chart-container" id="trendChartContainer">
                        <div class="chart-header">
                            <h3 class="chart-title">Trend Analysis & Forecasting</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="toggleForecast()">
                                    <i class="fas fa-chart-area"></i> Forecast
                                </button>
                                <button class="chart-action-btn" onclick="expandChart('trend')">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div id="trendChart" style="height: 350px;"></div>
                    </div>

                    <!-- Heatmap Chart -->
                    <div class="chart-container" id="heatmapChartContainer">
                        <div class="chart-header">
                            <h3 class="chart-title">Activity Heatmap</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="changeHeatmapView()">
                                    <i class="fas fa-th"></i> Change View
                                </button>
                                <button class="chart-action-btn" onclick="expandChart('heatmap')">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div id="heatmapChart" style="height: 350px;"></div>
                    </div>
                </div>


                <!-- Data Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">Recent Transactions</h3>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div class="table-search">
                                <i class="fas fa-search" style="color: #6b7280;"></i>
                                <input type="text" placeholder="Search transactions..." id="transactionSearch" onkeyup="searchTransactions()">
                            </div>
                            <button class="action-button" style="background: #f3f4f6; color: #374151;" onclick="refreshTransactions()">
                                <i class="fas fa-sync"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable('id')">
                                    Transaction ID
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('module')">
                                    Module
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('entity')">
                                    Entity
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('amount')">
                                    Amount
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('status')">
                                    Status
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('date')">
                                    Date
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                    <div class="pagination">
                        <button class="pagination-btn" onclick="previousPage()" id="prevBtn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="pageInfo">Page 1 of 5</span>
                        <button class="pagination-btn" onclick="nextPage()" id="nextBtn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Module Detail View (Hidden by default) -->
            <div id="moduleDetailView" style="display: none;">
                <!-- Module detail content will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="chart-modal" id="chartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" style="font-size: 24px; font-weight: 700; color: #1e293b;">Chart Details</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalChart" style="height: 500px;"></div>
        </div>
    </div>

    <!-- Transaction Details Drawer -->
    <div class="transaction-drawer" id="transactionDrawer">
        <div class="drawer-header">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">Transaction Details</h3>
            <button class="modal-close" onclick="closeTransactionDrawer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="drawer-content" id="transactionDetails">
            <!-- Transaction details will be loaded here -->
        </div>
    </div>

    <!-- Drill-down Panel -->
    <div class="drilldown-panel" id="drilldownPanel">
        <div class="drilldown-header">
            <div>
                <h2 id="drilldownTitle" style="font-size: 24px; font-weight: 700; color: #1e293b;">Module Analysis</h2>
                <p id="drilldownSubtitle" style="color: #64748b; margin-top: 4px;">Detailed breakdown and insights</p>
            </div>
            <button class="modal-close" onclick="closeDrilldownPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="drilldown-content" id="drilldownContent">
            <!-- Drill-down content will be loaded here -->
        </div>
    </div>

    <!-- Advanced Features Panel -->
    <div class="advanced-panel" id="advancedPanel">
        <div class="panel-header">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">Advanced Settings</h3>
            <button class="modal-close" onclick="toggleAdvancedPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="panel-section">
                <h4 class="panel-section-title">Chart Settings</h4>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableAnimations" checked>
                        <span>Enable Animations</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableTooltips" checked>
                        <span>Enable Tooltips</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableDataLabels">
                        <span>Show Data Labels</span>
                    </label>
                </div>
            </div>

            <div class="panel-section">
                <h4 class="panel-section-title">Data Refresh</h4>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <label style="display: flex; flex-direction: column; gap: 8px;">
                        <span>Refresh Interval (seconds)</span>
                        <input type="range" min="5" max="60" value="30" id="refreshInterval">
                        <span id="refreshValue" style="font-size: 12px; color: #6b7280;">30s</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autoRefresh" checked>
                        <span>Auto Refresh</span>
                    </label>
                </div>
            </div>

            <div class="panel-section">
                <h4 class="panel-section-title">Export Settings</h4>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <label style="display: flex; flex-direction: column; gap: 8px;">
                        <span>Default Export Format</span>
                        <select class="filter-select">
                            <option value="png">PNG Image</option>
                            <option value="pdf">PDF Document</option>
                            <option value="csv">CSV Data</option>
                            <option value="xlsx">Excel Workbook</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Toggle Button -->
    <div class="settings-toggle" onclick="toggleAdvancedPanel()">
        <i class="fas fa-cog"></i>
    </div>

    <!-- Node Tooltip -->
    <div class="node-tooltip" id="nodeTooltip"></div>

    <!-- Scripts -->
    <script>
        // Initialize Highcharts default options
        Highcharts.setOptions({
            chart: {
                style: {
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                }
            },
            colors: ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6'],
            credits: { enabled: false },
            exporting: {
                buttons: {
                    contextButton: {
                        enabled: false
                    }
                }
            }
        });

        // Global variables
        let currentPage = 1;
        const itemsPerPage = 10;
        let allTransactions = [];
        let filteredTransactions = [];
        let sortColumn = 'date';
        let sortDirection = 'desc';
        let currentModule = null;
        
        // Module specific variables
        let moduleTransactions = [];
        let filteredModuleTransactions = [];
        let moduleCurrentPage = 1;
        let moduleSortColumn = 'date';
        let moduleSortDirection = 'desc';

        // Enhanced sample data generation with more comprehensive data
        // NOTE: This generates SAMPLE DATA for demonstration purposes
        // In production, this should be replaced with actual API calls to fetch real transaction data
        function generateSampleData() {
            const repositories = [
                {
                    name: 'Trade Finance',
                    modules: ['IMCO', 'INFI', 'IMLC', 'MESG', 'SHGT', 'OWGT'],
                    products: ['LC', 'BG', 'Collections', 'Documentary Credit', 'SBLC'],
                    statusWeights: { 'Authorised': 45, 'Pending': 25, 'Released': 20, 'Rejected': 8, 'Processing': 2 },
                    amountRange: [50000, 2000000]
                },
                {
                    name: 'Treasury',
                    modules: ['FXHD', 'SWAP', 'MKTD', 'DERV', 'BOND'],
                    products: ['FX Forward', 'IRS', 'Money Market', 'Currency Option', 'Bond'],
                    statusWeights: { 'Authorised': 60, 'Pending': 15, 'Released': 18, 'Rejected': 5, 'Completed': 2 },
                    amountRange: [100000, 5000000]
                },
                {
                    name: 'Cash Management',
                    modules: ['CASH', 'POOL', 'PAYM', 'LIQU', 'INVS'],
                    products: ['Cash Pooling', 'Payment Order', 'Liquidity Line', 'Investment', 'Sweep'],
                    statusWeights: { 'Authorised': 70, 'Pending': 20, 'Released': 8, 'Rejected': 1, 'Cancelled': 1 },
                    amountRange: [25000, 1000000]
                }
            ];

            const entities = [
                'ADCB Corporate Banking', 'Emirates NBD Business', 'FAB International',
                'HSBC UAE Corporate', 'Standard Chartered', 'Mashreq Bank',
                'ADIB Commercial', 'RAK Bank Business'
            ];

            const customerTiers = ['Platinum', 'Gold', 'Silver', 'Bronze'];
            const banks = ['ADCB', 'ENBD', 'FAB', 'HSBC', 'SCB', 'MASHREQ', 'ADIB', 'RAKBANK'];

            const transactions = [];
            const currentDate = new Date();

            // Generate 500 transactions for better analytics
            for (let i = 0; i < 500; i++) {
                const repo = repositories[Math.floor(Math.random() * repositories.length)];
                const module = repo.modules[Math.floor(Math.random() * repo.modules.length)];
                const product = repo.products[Math.floor(Math.random() * repo.products.length)];

                // Weighted status selection
                const statusRand = Math.random() * 100;
                let status = 'Pending';
                let cumulative = 0;
                for (const [statusName, weight] of Object.entries(repo.statusWeights)) {
                    cumulative += weight;
                    if (statusRand <= cumulative) {
                        status = statusName;
                        break;
                    }
                }

                // Realistic amount generation
                const [minAmount, maxAmount] = repo.amountRange;
                const amount = Math.floor(Math.random() * (maxAmount - minAmount) + minAmount);

                // Date distribution (more recent transactions weighted)
                const daysBack = Math.floor(Math.pow(Math.random(), 1.5) * 365); // Last year with recent bias
                const transactionDate = new Date(currentDate - daysBack * 24 * 60 * 60 * 1000);

                // Customer tier based on amount
                let tier = 'Bronze';
                if (amount > 1000000) tier = 'Platinum';
                else if (amount > 500000) tier = 'Gold';
                else if (amount > 200000) tier = 'Silver';

                transactions.push({
                    id: `${repo.name.substring(0, 2).toUpperCase()}${String(i + 1001).padStart(6, '0')}`,
                    repository: repo.name,
                    module: module,
                    entity: entities[Math.floor(Math.random() * entities.length)],
                    amount: amount,
                    status: status,
                    date: transactionDate.toISOString().split('T')[0],
                    timestamp: transactionDate.getTime(),
                    product: product,
                    bank: banks[Math.floor(Math.random() * banks.length)],
                    customer: `Customer ${Math.floor(Math.random() * 200) + 1}`,
                    tier: tier,
                    processingTime: Math.floor(Math.random() * 72) + 1, // Hours
                    riskScore: Math.floor(Math.random() * 100) + 1,
                    priority: ['High', 'Medium', 'Low'][Math.floor(Math.random() * 3)],
                    channel: ['Online', 'Branch', 'Mobile', 'API'][Math.floor(Math.random() * 4)],
                    currency: ['AED', 'USD', 'EUR', 'GBP'][Math.floor(Math.random() * 4)],
                    country: ['UAE', 'USA', 'UK', 'Germany', 'Singapore'][Math.floor(Math.random() * 5)]
                });
            }

            // Sort by date (most recent first)
            transactions.sort((a, b) => b.timestamp - a.timestamp);
            return transactions;
        }

        // Initialize charts
        let volumeChart, statusChart, trendChart, heatmapChart;
        let chartInstances = {};

        function initializeCharts() {
            // First, generate the data
            allTransactions = generateSampleData();
            filteredTransactions = [...allTransactions];
            
            console.log('Total transactions generated:', allTransactions.length);
            
            // Calculate volume data from generated transactions
            const volumeData = {};
            filteredTransactions.forEach(transaction => {
                volumeData[transaction.module] = (volumeData[transaction.module] || 0) + 1;
            });

            console.log('Volume data by module:', volumeData);

            const volumeSeriesData = Object.entries(volumeData).map(([module, count]) => ({
                name: module,
                y: count,
                drilldown: module
            }));
            
            console.log('Volume series data:', volumeSeriesData);

            // Volume Chart with drill-down capability
            try {
                volumeChart = Highcharts.chart('volumeChart', {
                chart: {
                    type: 'column',
                    backgroundColor: 'transparent',
                    events: {
                        drilldown: function(e) {
                            if (!e.seriesOptions) {
                                showModuleDrilldown(e.point.name);
                            }
                        }
                    }
                },
                title: { text: null },
                xAxis: {
                    type: 'category',
                    crosshair: true
                },
                yAxis: {
                    title: { text: 'Number of Transactions' }
                },
                legend: {
                    enabled: false
                },
                tooltip: {
                    headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                    pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y}</b> transactions<br/>'
                },
                plotOptions: {
                    column: {
                        borderRadius: 8,
                        dataLabels: {
                            enabled: true,
                            style: {
                                fontSize: '11px',
                                fontWeight: 'bold'
                            }
                        },
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function() {
                                    showModuleDrilldown(this.name);
                                }
                            }
                        }
                    }
                },
                series: [{
                    name: 'Transactions',
                    colorByPoint: true,
                    data: volumeSeriesData
                }]
            });
                chartInstances.volume = volumeChart;
                console.log('Volume chart initialized successfully');
            } catch (error) {
                console.error('Error initializing volume chart:', error);
            }

            // Calculate status data from generated transactions
            const statusData = {};
            filteredTransactions.forEach(transaction => {
                statusData[transaction.status] = (statusData[transaction.status] || 0) + 1;
            });

            const statusSeriesData = Object.entries(statusData).map(([status, count]) => ({
                name: status,
                y: count,
                color: status === 'Authorised' ? '#10b981' :
                       status === 'Pending' ? '#f59e0b' :
                       status === 'Released' ? '#6366f1' :
                       status === 'Rejected' ? '#ef4444' :
                       status === 'Processing' ? '#8b5cf6' :
                       status === 'Completed' ? '#06b6d4' :
                       status === 'Cancelled' ? '#64748b' : '#94a3b8'
            }));

            // Status Chart
            statusChart = Highcharts.chart('statusChart', {
                chart: {
                    type: 'pie',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                accessibility: {
                    point: {
                        valueSuffix: '%'
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Status',
                    colorByPoint: true,
                    data: statusSeriesData
                }]
            });
            chartInstances.status = statusChart;

            // Calculate trend data from generated transactions
            const monthlyData = {};
            const currentYear = new Date().getFullYear();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Initialize monthly data
            months.forEach((month, index) => {
                monthlyData[index] = 0;
            });
            
            // Count transactions by month
            filteredTransactions.forEach(transaction => {
                const date = new Date(transaction.date);
                if (date.getFullYear() === currentYear) {
                    monthlyData[date.getMonth()]++;
                }
            });
            
            const trendData = months.map((month, index) => monthlyData[index]);
            const currentMonth = new Date().getMonth();
            
            // Create forecast data (simple linear projection)
            const forecastData = new Array(months.length).fill(null);
            if (currentMonth < 11) {
                const avgGrowth = trendData.slice(0, currentMonth + 1).reduce((a, b, i, arr) => {
                    if (i === 0) return 0;
                    return a + (b - arr[i - 1]) / i;
                }, 0);
                
                for (let i = currentMonth + 1; i < months.length; i++) {
                    forecastData[i] = Math.round(trendData[currentMonth] + (avgGrowth * (i - currentMonth)));
                }
            }

            // Trend Chart
            trendChart = Highcharts.chart('trendChart', {
                chart: {
                    type: 'areaspline',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                xAxis: {
                    categories: months
                },
                yAxis: {
                    title: { text: 'Transaction Volume' }
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' transactions'
                },
                plotOptions: {
                    areaspline: {
                        fillOpacity: 0.1
                    }
                },
                series: [{
                    name: 'Actual',
                    data: trendData,
                    color: '#6366f1'
                }, {
                    name: 'Forecast',
                    data: forecastData,
                    color: '#f59e0b',
                    dashStyle: 'ShortDash'
                }]
            });
            chartInstances.trend = trendChart;

            // Heatmap Chart
            heatmapChart = Highcharts.chart('heatmapChart', {
                chart: {
                    type: 'heatmap',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                xAxis: {
                    categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                },
                yAxis: {
                    categories: ['00:00', '06:00', '12:00', '18:00'],
                    title: null,
                    reversed: true
                },
                accessibility: {
                    point: {
                        descriptionFormatter: function (point) {
                            var ix = point.index + 1,
                                xName = point.series.xAxis.categories[point.x] || point.x,
                                yName = point.series.yAxis.categories[point.y] || point.y,
                                val = point.value;
                            return ix + '. ' + xName + ' ' + yName + ', ' + val + '.';
                        }
                    }
                },
                colorAxis: {
                    min: 0,
                    minColor: '#FFFFFF',
                    maxColor: '#6366f1'
                },
                legend: {
                    align: 'right',
                    layout: 'vertical',
                    margin: 0,
                    verticalAlign: 'top',
                    y: 25,
                    symbolHeight: 280
                },
                series: [{
                    name: 'Activity',
                    borderWidth: 1,
                    borderColor: '#f3f4f6',
                    data: generateHeatmapData(),
                    dataLabels: {
                        enabled: false
                    }
                }]
            });
            chartInstances.heatmap = heatmapChart;


            // Initialize transactions (already done at the beginning of initializeCharts)
            console.log('Generated transactions:', allTransactions.length);
            loadTransactionTable();
            updateKPIMetrics();
        }

        // Update charts based on filtered data
        function updateChartsWithFilteredData() {
            // Update KPI metrics
            updateKPIMetrics();

            // Update Volume Chart
            const volumeData = {};
            filteredTransactions.forEach(transaction => {
                volumeData[transaction.module] = (volumeData[transaction.module] || 0) + 1;
            });

            const volumeSeriesData = Object.entries(volumeData).map(([module, count]) => ({
                name: module,
                y: count,
                drilldown: module
            }));

            if (chartInstances.volume) {
                chartInstances.volume.series[0].setData(volumeSeriesData);
            }

            // Update Status Chart
            const statusData = {};
            filteredTransactions.forEach(transaction => {
                statusData[transaction.status] = (statusData[transaction.status] || 0) + 1;
            });

            const statusSeriesData = Object.entries(statusData).map(([status, count]) => ({
                name: status,
                y: count,
                color: status === 'Authorised' ? '#10b981' :
                       status === 'Pending' ? '#f59e0b' :
                       status === 'Released' ? '#6366f1' : '#ef4444'
            }));

            if (chartInstances.status) {
                chartInstances.status.series[0].setData(statusSeriesData);
            }

            // Update Trend Chart with monthly data
            const monthlyData = {};
            const currentYear = new Date().getFullYear();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            months.forEach((month, index) => {
                monthlyData[index] = 0;
            });

            filteredTransactions.forEach(transaction => {
                const date = new Date(transaction.date);
                if (date.getFullYear() === currentYear) {
                    monthlyData[date.getMonth()]++;
                }
            });

            const trendSeriesData = months.map((month, index) => monthlyData[index]);

            if (chartInstances.trend) {
                chartInstances.trend.series[0].setData(trendSeriesData);
            }

            // Update Heatmap with hourly activity
            const heatmapData = generateFilteredHeatmapData(filteredTransactions);
            if (chartInstances.heatmap) {
                chartInstances.heatmap.series[0].setData(heatmapData);
            }

            // Update Network Chart
            const networkData = generateFilteredNetworkData(filteredTransactions);
            if (chartInstances.network) {
                chartInstances.network.series[0].setData(networkData);
            }
        }

        // Helper functions for data generation
        function generateHeatmapData() {
            const data = [];
            for (let i = 0; i < 7; i++) {
                for (let j = 0; j < 4; j++) {
                    data.push([i, j, Math.floor(Math.random() * 100)]);
                }
            }
            return data;
        }

        function generateFilteredHeatmapData(transactions) {
            const data = [];
            const activity = {};

            // Initialize activity matrix
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 4; hour++) {
                    activity[`${day}-${hour}`] = 0;
                }
            }

            // Count transactions by day and time period
            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                const day = date.getDay();
                const hourGroup = Math.floor(date.getHours() / 6); // 0-5:0, 6-11:1, 12-17:2, 18-23:3
                activity[`${day}-${hourGroup}`]++;
            });

            // Convert to heatmap data format
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 4; hour++) {
                    data.push([day, hour, activity[`${day}-${hour}`]]);
                }
            }

            return data;
        }

        function generateNetworkData() {
            const nodes = ['IMCO', 'INFI', 'IMLC', 'MESG', 'SHGT', 'OWGT', 'Bank A', 'Bank B', 'Entity 1', 'Entity 2'];
            const data = [];
            for (let i = 0; i < 30; i++) {
                const from = nodes[Math.floor(Math.random() * nodes.length)];
                let to = nodes[Math.floor(Math.random() * nodes.length)];
                while (to === from) {
                    to = nodes[Math.floor(Math.random() * nodes.length)];
                }
                const weight = Math.floor(Math.random() * 10) + 1;
                data.push([from, to, weight]);
            }
            return data;
        }

        function generateFilteredNetworkData(transactions) {
            const flowMap = {};

            // Count flows between modules and entities
            transactions.forEach(transaction => {
                const key = `${transaction.module}-${transaction.entity}`;
                flowMap[key] = (flowMap[key] || 0) + 1;
            });

            // Convert to network data format
            const data = Object.entries(flowMap).map(([flow, count]) => {
                const [from, to] = flow.split('-');
                return [from, to, count];
            });

            // Add some bank connections if data is sparse
            if (data.length < 5) {
                const modules = [...new Set(transactions.map(t => t.module))];
                const entities = [...new Set(transactions.map(t => t.entity))];
                const banks = ['Bank A', 'Bank B'];

                modules.forEach(module => {
                    banks.forEach(bank => {
                        data.push([module, bank, Math.floor(Math.random() * 5) + 1]);
                    });
                });

                entities.forEach(entity => {
                    banks.forEach(bank => {
                        data.push([entity, bank, Math.floor(Math.random() * 5) + 1]);
                    });
                });
            }

            return data;
        }

        // Update KPI metrics based on filtered data
        function updateKPIMetrics() {
            // Calculate metrics from filtered transactions
            const totalTransactions = filteredTransactions.length || 0;
            const pendingCount = filteredTransactions.filter(t => t.status === 'Pending').length || 0;
            const totalValue = filteredTransactions.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            const approvedCount = filteredTransactions.filter(t => t.status === 'Authorised').length || 0;
            
            // Calculate trends based on actual data
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            // Filter transactions for previous periods
            const lastMonthTransactions = allTransactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= lastMonth && tDate < now;
            });
            
            const lastWeekTransactions = allTransactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= lastWeek && tDate < now;
            });
            
            // Calculate previous period metrics
            const prevMonthTotal = lastMonthTransactions.length;
            const prevMonthValue = lastMonthTransactions.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            const prevMonthPending = lastMonthTransactions.filter(t => t.status === 'Pending').length;
            const prevWeekApproved = lastWeekTransactions.filter(t => t.status === 'Authorised').length;
            
            // Calculate percentage changes
            const transactionsTrend = prevMonthTotal > 0 ? ((totalTransactions - prevMonthTotal) / prevMonthTotal * 100).toFixed(1) : 0;
            const valueTrend = prevMonthValue > 0 ? ((totalValue - prevMonthValue) / prevMonthValue * 100).toFixed(1) : 0;
            const pendingTrend = prevMonthPending > 0 ? ((pendingCount - prevMonthPending) / prevMonthPending * 100).toFixed(1) : 0;
            const approvedTrend = prevWeekApproved > 0 ? ((approvedCount - prevWeekApproved) / prevWeekApproved * 100).toFixed(1) : 0;
            
            console.log('Updating KPI Metrics:');
            console.log(`Total Transactions: ${totalTransactions}`);
            console.log(`Pending Count: ${pendingCount}`);
            console.log(`Total Value: ${totalValue}`);
            console.log(`Approved Count: ${approvedCount}`);

            // Format values with validation
            const formattedTotal = isNaN(totalTransactions) ? '0' : totalTransactions.toLocaleString();
            const formattedValue = isNaN(totalValue) ? 'AED 0.0M' : 'AED ' + (totalValue / 1000000).toFixed(1) + 'M';
            const formattedPending = isNaN(pendingCount) ? '0' : pendingCount.toLocaleString();
            const formattedApproved = isNaN(approvedCount) ? '0' : approvedCount.toLocaleString();

            // Update KPI cards
            const kpiCards = document.querySelectorAll('.kpi-card');
            if (kpiCards[0]) {
                kpiCards[0].querySelector('.kpi-value').textContent = formattedTotal;
                updateTrendDisplay('transactionsTrend', transactionsTrend, 'vs last month');
            }
            if (kpiCards[1]) {
                kpiCards[1].querySelector('.kpi-value').textContent = formattedValue;
                updateTrendDisplay('valueTrend', valueTrend, 'vs last month');
            }
            if (kpiCards[2]) {
                kpiCards[2].querySelector('.kpi-value').textContent = formattedPending;
                updateTrendDisplay('pendingTrend', pendingTrend, 'vs last month');
            }
            if (kpiCards[3]) {
                kpiCards[3].querySelector('.kpi-value').textContent = formattedApproved;
                updateTrendDisplay('approvedTrend', approvedTrend, 'vs last week');
            }
        }
        
        function updateTrendDisplay(elementId, trendValue, periodText) {
            const trendElement = document.getElementById(elementId);
            if (trendElement) {
                const trend = parseFloat(trendValue);
                const isPositive = trend > 0;
                const isNegative = trend < 0;
                
                trendElement.className = 'kpi-trend ' + (isPositive ? 'positive' : isNegative ? 'negative' : '');
                trendElement.innerHTML = `
                    <i class="fas fa-${isPositive ? 'arrow-up' : isNegative ? 'arrow-down' : 'minus'}"></i>
                    <span>${Math.abs(trend)}% ${periodText}</span>
                `;
            }
        }

        function updateTrendIndicators() {
            // This is a simplified version - in production, you would calculate actual trends
            const trends = document.querySelectorAll('.kpi-trend');
            trends.forEach(trend => {
                const change = (Math.random() * 20 - 10).toFixed(1);
                const isPositive = change > 0;
                trend.className = `kpi-trend ${isPositive ? 'positive' : 'negative'}`;
                trend.innerHTML = `
                    <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i>
                    <span>${Math.abs(change)}% from last month</span>
                `;
            });
        }

        // Enhanced transaction table with pagination and search
        function loadTransactionTable() {
            const tbody = document.getElementById('transactionTableBody');
            if (!tbody) {
                console.error('Transaction table body not found');
                return;
            }
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

            pageTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td style="cursor: pointer; color: #6366f1;" onclick="showModuleDrilldown('${transaction.module}')">${transaction.module}</td>
                    <td>${transaction.entity}</td>
                    <td>$${transaction.amount.toLocaleString()}</td>
                    <td><span class="status-badge status-${transaction.status.toLowerCase()}">${transaction.status}</span></td>
                    <td>${transaction.date}</td>
                    <td>
                        <div class="action-menu">
                            <button class="chart-action-btn" onclick="viewTransaction('${transaction.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="chart-action-btn" onclick="toggleActionMenu('${transaction.id}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="action-menu-dropdown" id="menu-${transaction.id}">
                                <div class="action-menu-item" onclick="exportTransaction('${transaction.id}')">
                                    <i class="fas fa-download"></i>
                                    <span>Export</span>
                                </div>
                                <div class="action-menu-item" onclick="shareTransaction('${transaction.id}')">
                                    <i class="fas fa-share"></i>
                                    <span>Share</span>
                                </div>
                                <div class="action-menu-item" onclick="auditTransaction('${transaction.id}')">
                                    <i class="fas fa-history"></i>
                                    <span>Audit Trail</span>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // Pagination functions
        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadTransactionTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                loadTransactionTable();
            }
        }

        // Search functionality
        function searchTransactions() {
            const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();

            if (searchTerm === '') {
                filteredTransactions = [...allTransactions];
            } else {
                filteredTransactions = allTransactions.filter(transaction =>
                    transaction.id.toLowerCase().includes(searchTerm) ||
                    transaction.module.toLowerCase().includes(searchTerm) ||
                    transaction.entity.toLowerCase().includes(searchTerm) ||
                    transaction.status.toLowerCase().includes(searchTerm) ||
                    transaction.customer.toLowerCase().includes(searchTerm)
                );
            }

            currentPage = 1;
            loadTransactionTable();
        }

        // Sort functionality
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredTransactions.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (column === 'amount') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            loadTransactionTable();
        }

        // Module drill-down functionality
        function showModuleDrilldown(moduleName) {
            currentModule = moduleName;

            // Show breadcrumb
            document.getElementById('breadcrumb').style.display = 'flex';
            document.getElementById('breadcrumbModule').innerHTML = `<span>${moduleName} Details</span>`;

            // Hide main dashboard
            document.getElementById('mainDashboard').style.display = 'none';

            // Show module detail view
            const moduleDetailView = document.getElementById('moduleDetailView');
            moduleDetailView.style.display = 'block';

            // Generate module-specific content using currently filtered transactions
            const moduleData = generateModuleDataFromFiltered(moduleName);
            moduleDetailView.innerHTML = `
                <div class="module-detail-card">
                    <h2 style="font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 24px;">
                        ${moduleName} - ${getModuleFullName(moduleName)}
                    </h2>

                    <div class="module-stats-grid">
                        <div class="module-stat">
                            <div class="module-stat-value">${moduleData.totalTransactions}</div>
                            <div class="module-stat-label">Total Transactions</div>
                        </div>
                        <div class="module-stat">
                            <div class="module-stat-value">$${moduleData.totalValue}M</div>
                            <div class="module-stat-label">Total Value</div>
                        </div>
                        <div class="module-stat">
                            <div class="module-stat-value">${moduleData.avgProcessingTime}h</div>
                            <div class="module-stat-label">Avg Processing Time</div>
                        </div>
                        <div class="module-stat">
                            <div class="module-stat-value">${moduleData.successRate}%</div>
                            <div class="module-stat-label">Success Rate</div>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">${moduleName} Status Breakdown</h3>
                        </div>
                        <div id="moduleStatusChart" style="height: 350px;"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">${moduleName} Daily Trend</h3>
                        </div>
                        <div id="moduleTrendChart" style="height: 350px;"></div>
                    </div>
                </div>

                <!-- Entity Distribution Chart Hidden -->
                <!--
                <div class="chart-container" style="margin-top: 24px;">
                    <div class="chart-header">
                        <h3 class="chart-title">${moduleName} Entity Distribution</h3>
                    </div>
                    <div id="moduleEntityChart" style="height: 400px;"></div>
                </div>
                -->

                <!-- Recent Transactions Table for Module -->
                <div class="data-table-container" style="margin-top: 32px;">
                    <div class="table-header">
                        <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">
                            Recent ${moduleName} Transactions 
                            <span style="font-size: 14px; font-weight: 400; color: #6b7280;">(${moduleData.totalTransactions} total)</span>
                        </h3>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div class="table-search">
                                <i class="fas fa-search" style="color: #6b7280;"></i>
                                <input type="text" placeholder="Search ${moduleName} transactions..." id="moduleTransactionSearch" onkeyup="searchModuleTransactions()">
                            </div>
                            <button class="action-button" style="background: #f3f4f6; color: #374151;" onclick="exportModuleTransactions('${moduleName}')">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th onclick="sortModuleTable('id')">
                                    Transaction ID
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortModuleTable('entity')">
                                    Entity
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortModuleTable('product')">
                                    Product
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortModuleTable('amount')">
                                    Amount
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortModuleTable('status')">
                                    Status
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortModuleTable('date')">
                                    Date
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="moduleTransactionTableBody">
                            <!-- Module transactions will be loaded here -->
                        </tbody>
                    </table>
                    <div class="pagination">
                        <button class="pagination-btn" onclick="previousModulePage()" id="modulePrevBtn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="modulePageInfo">Page 1 of 1</span>
                        <button class="pagination-btn" onclick="nextModulePage()" id="moduleNextBtn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            `;

            // Initialize module-specific charts with actual data
            initializeModuleCharts(moduleName, moduleData);
            
            // Load module transactions table
            console.log(`Loading transactions for ${moduleName}:`, moduleData.totalTransactions);
            console.log('Module transactions array length:', moduleData.moduleTransactions.length);
            loadModuleTransactions(moduleData.moduleTransactions);
        }

        function getModuleFullName(module) {
            const names = {
                // Trade Finance
                'IMCO': 'Import Collections',
                'INFI': 'Inward Finance',
                'IMLC': 'Import LC',
                'MESG': 'Messages',
                'SHGT': 'Shipping Guarantee',
                'OWGT': 'Outward Guarantee',
                // Treasury
                'FXHD': 'FX Hedging',
                'SWAP': 'Interest Rate Swaps',
                'MKTD': 'Money Market',
                'DERV': 'Derivatives',
                'BOND': 'Bonds',
                // Cash Management
                'CASH': 'Cash Management',
                'POOL': 'Cash Pooling',
                'PAYM': 'Payment Processing',
                'LIQU': 'Liquidity Management',
                'INVS': 'Investments'
            };
            return names[module] || module;
        }

        function generateModuleData(module) {
            // Filter transactions for this specific module
            const moduleTransactions = allTransactions.filter(t => t.module === module);
            
            console.log(`Filtering transactions for module: ${module}`);
            console.log(`Total transactions in system: ${allTransactions.length}`);
            console.log(`Transactions for ${module}: ${moduleTransactions.length}`);
            console.log(`Sample transactions:`, moduleTransactions.slice(0, 5));
            
            // Calculate actual metrics from filtered data
            const totalTransactions = moduleTransactions.length;
            const totalValue = moduleTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            // Calculate average processing time
            const avgProcessingTime = moduleTransactions.length > 0 
                ? (moduleTransactions.reduce((sum, t) => sum + t.processingTime, 0) / moduleTransactions.length).toFixed(1)
                : 0;
            
            // Calculate success rate (Authorised + Released / Total)
            const successfulTransactions = moduleTransactions.filter(t => 
                t.status === 'Authorised' || t.status === 'Released' || t.status === 'Completed'
            ).length;
            const successRate = moduleTransactions.length > 0 
                ? ((successfulTransactions / moduleTransactions.length) * 100).toFixed(1)
                : 0;
            
            return {
                totalTransactions: totalTransactions,
                totalValue: (totalValue / 1000000).toFixed(1), // Convert to millions
                avgProcessingTime: avgProcessingTime,
                successRate: successRate,
                moduleTransactions: moduleTransactions // Pass the filtered data for charts
            };
        }

        function generateModuleDataFromFiltered(module) {
            // Filter transactions for this specific module from currently filtered data
            const moduleTransactions = filteredTransactions.filter(t => t.module === module);
            
            console.log(`Filtering transactions for module: ${module} from filtered data`);
            console.log(`Total filtered transactions: ${filteredTransactions.length}`);
            console.log(`Transactions for ${module}: ${moduleTransactions.length}`);
            console.log(`First 5 ${module} transactions:`, moduleTransactions.slice(0, 5));
            
            // Double-check the filtering
            const doubleCheck = moduleTransactions.filter(t => t.module !== module);
            if (doubleCheck.length > 0) {
                console.error(`ERROR: Found ${doubleCheck.length} transactions with wrong module!`, doubleCheck);
            }
            
            // Calculate actual metrics from filtered data
            const totalTransactions = moduleTransactions.length;
            const totalValue = moduleTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            // Calculate average processing time
            const avgProcessingTime = moduleTransactions.length > 0 
                ? (moduleTransactions.reduce((sum, t) => sum + t.processingTime, 0) / moduleTransactions.length).toFixed(1)
                : 0;
            
            // Calculate success rate (Authorised + Released / Total)
            const successfulTransactions = moduleTransactions.filter(t => 
                t.status === 'Authorised' || t.status === 'Released' || t.status === 'Completed'
            ).length;
            const successRate = moduleTransactions.length > 0 
                ? ((successfulTransactions / moduleTransactions.length) * 100).toFixed(1)
                : 0;
            
            return {
                totalTransactions: totalTransactions,
                totalValue: (totalValue / 1000000).toFixed(1), // Convert to millions
                avgProcessingTime: avgProcessingTime,
                successRate: successRate,
                moduleTransactions: moduleTransactions // Pass the filtered data for charts
            };
        }

        function initializeModuleCharts(moduleName, moduleData) {
            // Get the filtered transactions for this module
            const moduleTransactions = moduleData.moduleTransactions;
            
            // Calculate status distribution
            const statusCounts = {};
            moduleTransactions.forEach(transaction => {
                statusCounts[transaction.status] = (statusCounts[transaction.status] || 0) + 1;
            });
            
            // Prepare data for status chart
            const statuses = ['Authorised', 'Pending', 'Released', 'Rejected', 'Processing', 'Completed', 'Cancelled'];
            const statusData = statuses.map(status => ({
                name: status,
                y: statusCounts[status] || 0,
                color: status === 'Authorised' ? '#10b981' :
                       status === 'Pending' ? '#f59e0b' :
                       status === 'Released' ? '#6366f1' :
                       status === 'Rejected' ? '#ef4444' :
                       status === 'Processing' ? '#8b5cf6' :
                       status === 'Completed' ? '#06b6d4' :
                       '#64748b'
            })).filter(item => item.y > 0); // Only show statuses with data
            
            // Module Status Chart
            Highcharts.chart('moduleStatusChart', {
                chart: {
                    type: 'column',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                xAxis: {
                    type: 'category'
                },
                yAxis: {
                    title: { text: 'Number of Transactions' }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                    pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y}</b> transactions<br/>'
                },
                plotOptions: {
                    column: {
                        borderRadius: 8,
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: [{
                    name: moduleName,
                    colorByPoint: true,
                    data: statusData
                }]
            });

            // Module Trend Chart - Calculate daily transaction counts
            const dailyData = {};
            const today = new Date();
            
            // Initialize last 30 days
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                dailyData[dateKey] = 0;
            }
            
            // Count transactions by day
            moduleTransactions.forEach(transaction => {
                const dateKey = transaction.date;
                if (dailyData.hasOwnProperty(dateKey)) {
                    dailyData[dateKey]++;
                }
            });
            
            // Prepare chart data
            const days = [];
            const data = [];
            Object.entries(dailyData).forEach(([date, count]) => {
                const dateObj = new Date(date);
                days.push(dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                data.push(count);
            });

            Highcharts.chart('moduleTrendChart', {
                chart: {
                    type: 'spline',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                xAxis: {
                    categories: days
                },
                yAxis: {
                    title: { text: 'Transactions' }
                },
                series: [{
                    name: moduleName,
                    data: data,
                    color: '#6366f1'
                }]
            });

            // Entity Distribution Chart - HIDDEN per user request
            /*
            // Module Entity Chart (Sunburst) - Using actual entity distribution
            const entityDistribution = {};
            const productDistribution = {};
            
            // Count transactions by entity and product
            moduleTransactions.forEach(transaction => {
                entityDistribution[transaction.entity] = (entityDistribution[transaction.entity] || 0) + 1;
                
                // Group by entity and product
                const key = `${transaction.entity}|${transaction.product}`;
                productDistribution[key] = (productDistribution[key] || 0) + 1;
            });
            
            // Generate sunburst data from actual distribution
            const sunburstData = [{
                id: '0.0',
                parent: '',
                name: moduleName,
                value: moduleTransactions.length
            }];
            
            let nodeId = 1;
            Object.entries(entityDistribution).forEach(([entity, count], i) => {
                const entityId = `1.${i}`;
                sunburstData.push({
                    id: entityId,
                    parent: '0.0',
                    name: entity,
                    value: count
                });
                
                // Add products for this entity
                Object.entries(productDistribution).forEach(([key, productCount]) => {
                    const [productEntity, product] = key.split('|');
                    if (productEntity === entity) {
                        sunburstData.push({
                            id: `2.${nodeId}`,
                            parent: entityId,
                            name: product,
                            value: productCount
                        });
                        nodeId++;
                    }
                });
            });
            
            // Module Entity Chart (Sunburst)
            Highcharts.chart('moduleEntityChart', {
                chart: {
                    type: 'sunburst',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                series: [{
                    type: 'sunburst',
                    data: sunburstData,
                    allowDrillToNode: true,
                    cursor: 'pointer',
                    dataLabels: {
                        format: '{point.name}',
                        filter: {
                            property: 'innerArcLength',
                            operator: '>',
                            value: 16
                        }
                    },
                    levels: [{
                        level: 1,
                        levelIsConstant: false,
                        dataLabels: {
                            filter: {
                                property: 'outerArcLength',
                                operator: '>',
                                value: 64
                            }
                        }
                    }, {
                        level: 2,
                        colorByPoint: true
                    }, {
                        level: 3,
                        colorVariation: {
                            key: 'brightness',
                            to: -0.5
                        }
                    }, {
                        level: 4,
                        colorVariation: {
                            key: 'brightness',
                            to: 0.5
                        }
                    }]
                }]
            });
            */
        }

        function generateSunburstData(module) {
            const entities = ['Entity 1', 'Entity 2', 'Entity 3', 'Entity 4'];
            const products = ['LC', 'BG', 'Collections'];
            const data = [{
                id: '0.0',
                parent: '',
                name: module
            }];

            let id = 1;
            entities.forEach((entity, i) => {
                const entityId = `1.${i}`;
                data.push({
                    id: entityId,
                    parent: '0.0',
                    name: entity,
                    value: Math.floor(Math.random() * 100) + 20
                });

                products.forEach((product, j) => {
                    data.push({
                        id: `2.${id}`,
                        parent: entityId,
                        name: product,
                        value: Math.floor(Math.random() * 50) + 10
                    });
                    id++;
                });
            });

            return data;
        }

        function navigateToOverview() {
            document.getElementById('breadcrumb').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('moduleDetailView').style.display = 'none';
            currentModule = null;
        }

        // Transaction detail functions
        function viewTransaction(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (!transaction) return;

            const drawer = document.getElementById('transactionDrawer');
            const details = document.getElementById('transactionDetails');

            details.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">Transaction ID</div>
                    <div class="detail-value">${transaction.id}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Module</div>
                    <div class="detail-value">${transaction.module} - ${getModuleFullName(transaction.module)}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge status-${transaction.status.toLowerCase()}">${transaction.status}</span>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Amount</div>
                    <div class="detail-value" style="font-size: 24px; font-weight: 700; color: #6366f1;">
                        $${transaction.amount.toLocaleString()}
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Entity</div>
                    <div class="detail-value">${transaction.entity}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Product Type</div>
                    <div class="detail-value">${transaction.product}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Bank</div>
                    <div class="detail-value">${transaction.bank}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Customer</div>
                    <div class="detail-value">${transaction.customer}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Date</div>
                    <div class="detail-value">${new Date(transaction.date).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}</div>
                </div>

                <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid #e5e7eb;">
                    <h4 style="font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 16px;">Transaction Timeline</h4>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        ${generateTimeline()}
                    </div>
                </div>
            `;

            drawer.classList.add('active');
        }

        function generateTimeline() {
            const events = [
                { time: '09:00 AM', event: 'Transaction Initiated', status: 'completed' },
                { time: '09:15 AM', event: 'Document Verification', status: 'completed' },
                { time: '10:30 AM', event: 'Compliance Check', status: 'completed' },
                { time: '11:00 AM', event: 'Approval Process', status: 'in-progress' },
                { time: 'Pending', event: 'Final Authorization', status: 'pending' }
            ];

            return events.map(item => `
                <div style="display: flex; align-items: flex-start; gap: 16px;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background: ${
                        item.status === 'completed' ? '#10b981' :
                        item.status === 'in-progress' ? '#f59e0b' : '#e5e7eb'
                    }; margin-top: 2px;"></div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">${item.time}</div>
                        <div style="font-size: 14px; color: #1e293b; font-weight: 500;">${item.event}</div>
                    </div>
                </div>
            `).join('');
        }

        function closeTransactionDrawer() {
            document.getElementById('transactionDrawer').classList.remove('active');
        }

        // Action menu functions
        function toggleActionMenu(transactionId) {
            const menu = document.getElementById(`menu-${transactionId}`);
            const isActive = menu.classList.contains('active');

            // Close all menus
            document.querySelectorAll('.action-menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('active');
            });

            // Toggle current menu
            if (!isActive) {
                menu.classList.add('active');
            }
        }

        function exportTransaction(transactionId) {
            showNotification(`Exporting transaction ${transactionId}...`);
            // Implement export logic
        }

        function shareTransaction(transactionId) {
            showNotification(`Sharing transaction ${transactionId}...`);
            // Implement share logic
        }

        function auditTransaction(transactionId) {
            showNotification(`Loading audit trail for ${transactionId}...`);
            // Implement audit trail logic
        }

        // Network node details
        function showNodeDetails(node) {
            const tooltip = document.getElementById('nodeTooltip');
            const nodeData = {
                connections: Math.floor(Math.random() * 20) + 5,
                transactions: Math.floor(Math.random() * 100) + 20,
                value: '$' + (Math.random() * 5 + 0.5).toFixed(1) + 'M'
            };

            tooltip.innerHTML = `
                <strong>${node.name}</strong><br>
                Connections: ${nodeData.connections}<br>
                Transactions: ${nodeData.transactions}<br>
                Total Value: ${nodeData.value}
            `;

            // Position tooltip
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.classList.add('active');

            // Hide tooltip after delay
            setTimeout(() => {
                tooltip.classList.remove('active');
            }, 3000);
        }

        // Refresh functions
        function refreshTransactions() {
            showNotification('Refreshing transactions...');
            setTimeout(() => {
                allTransactions = generateSampleData();
                filteredTransactions = [...allTransactions];
                loadTransactionTable();
                showNotification('Transactions refreshed successfully');
            }, 1000);
        }

        function refreshData() {
            showNotification('Refreshing all data...');
            // Refresh charts
            initializeCharts();
            // Refresh transactions
            refreshTransactions();
        }

        // Chart interaction functions
        function toggleChartType(chartId) {
            if (chartId === 'volume') {
                const currentType = volumeChart.options.chart.type;
                const newType = currentType === 'column' ? 'line' : 'column';
                volumeChart.update({
                    chart: { type: newType }
                });
            }
        }

        function changeStatusChartType(type) {
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            let chartType = 'pie';
            let options3d = {};

            if (type === '3d') {
                chartType = 'pie';
                options3d = {
                    enabled: true,
                    alpha: 45,
                    beta: 0
                };
            } else if (type === 'donut') {
                chartType = 'pie';
            } else if (type === 'treemap') {
                chartType = 'treemap';
            }

            statusChart.update({
                chart: {
                    type: chartType,
                    options3d: options3d
                },
                plotOptions: {
                    pie: {
                        innerSize: type === 'donut' ? '50%' : '0%'
                    }
                }
            });
        }

        function expandChart(chartId) {
            const modal = document.getElementById('chartModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalChart = document.getElementById('modalChart');

            // Set title based on chart
            const titles = {
                'volume': 'Transaction Volume Analysis',
                'status': 'Status Distribution',
                'trend': 'Trend Analysis & Forecasting',
                'heatmap': 'Activity Heatmap',
                'network': 'Transaction Flow Network'
            };

            modalTitle.textContent = titles[chartId] || 'Chart Details';
            modal.classList.add('active');

            // Clone the chart to modal
            setTimeout(() => {
                const originalChart = chartInstances[chartId];
                if (originalChart) {
                    Highcharts.chart('modalChart', originalChart.options);
                }
            }, 100);
        }

        function closeModal() {
            document.getElementById('chartModal').classList.remove('active');
        }

        function closeDrilldownPanel() {
            document.getElementById('drilldownPanel').classList.remove('active');
        }
        
        function calculateDailyBreakdown(metric) {
            const dailyData = {};
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Initialize all days in the range
            for (let d = new Date(thirtyDaysAgo); d <= now; d.setDate(d.getDate() + 1)) {
                const dateKey = d.toISOString().split('T')[0];
                dailyData[dateKey] = 0;
            }
            
            // Count transactions by day based on metric
            filteredTransactions.forEach(transaction => {
                const transDate = new Date(transaction.date);
                if (transDate >= thirtyDaysAgo && transDate <= now) {
                    const dateKey = transaction.date;
                    
                    switch(metric) {
                        case 'transactions':
                            dailyData[dateKey] = (dailyData[dateKey] || 0) + 1;
                            break;
                        case 'value':
                            dailyData[dateKey] = (dailyData[dateKey] || 0) + transaction.amount;
                            break;
                        case 'pending':
                            if (transaction.status === 'Pending') {
                                dailyData[dateKey] = (dailyData[dateKey] || 0) + 1;
                            }
                            break;
                        case 'approved':
                            if (transaction.status === 'Authorised') {
                                dailyData[dateKey] = (dailyData[dateKey] || 0) + 1;
                            }
                            break;
                    }
                }
            });
            
            // Convert to Highcharts format
            return Object.entries(dailyData)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([date, value]) => [new Date(date).getTime(), value]);
        }
        
        function calculateCategoryDistribution(metric) {
            const categoryData = {};
            
            filteredTransactions.forEach(transaction => {
                let category;
                
                switch(metric) {
                    case 'transactions':
                    case 'value':
                        category = transaction.repository;
                        break;
                    case 'pending':
                    case 'approved':
                        category = transaction.module;
                        break;
                }
                
                if (metric === 'value') {
                    categoryData[category] = (categoryData[category] || 0) + transaction.amount;
                } else if (metric === 'pending' && transaction.status === 'Pending') {
                    categoryData[category] = (categoryData[category] || 0) + 1;
                } else if (metric === 'approved' && transaction.status === 'Authorised') {
                    categoryData[category] = (categoryData[category] || 0) + 1;
                } else if (metric === 'transactions') {
                    categoryData[category] = (categoryData[category] || 0) + 1;
                }
            });
            
            // Convert to Highcharts format
            return Object.entries(categoryData)
                .map(([name, value]) => ({ name, y: value }))
                .sort((a, b) => b.y - a.y)
                .slice(0, 10); // Top 10 categories
        }

        function toggleExportMenu(chartId) {
            const menu = document.getElementById(chartId + 'ExportMenu');
            menu.classList.toggle('active');

            // Close other menus
            document.querySelectorAll('.export-dropdown').forEach(dropdown => {
                if (dropdown.id !== chartId + 'ExportMenu') {
                    dropdown.classList.remove('active');
                }
            });
        }

        function exportChart(chartId, format) {
            const chart = chartInstances[chartId];
            if (!chart) return;

            if (format === 'png' || format === 'pdf') {
                chart.exportChart({
                    type: format === 'png' ? 'image/png' : 'application/pdf',
                    filename: `${chartId}-chart-${new Date().toISOString().split('T')[0]}`
                });
            } else if (format === 'csv') {
                chart.downloadCSV();
            }

            // Close export menu
            document.getElementById(chartId + 'ExportMenu').classList.remove('active');
            showNotification(`Exporting chart as ${format.toUpperCase()}...`);
        }

        function changeTimeRange(chartId, range, event) {
            // Prevent default if event exists
            if (event) {
                event.preventDefault();
            }
            
            // Get the clicked button - handle both direct call and event scenarios
            const clickedButton = event ? event.target : document.querySelector('.time-range-selector .time-range-btn.active');
            
            // Find all time-range buttons in the same container
            const container = clickedButton.closest('.time-range-selector');
            if (container) {
                container.querySelectorAll('.time-range-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                clickedButton.classList.add('active');
            }

            // Update chart data based on range
            showNotification(`Updating to ${range} view...`);
            
            // Implement actual data loading based on time range
            updateChartData(chartId, range);
        }

        function updateChartData(chartId, range) {
            // Calculate date range based on selection
            const endDate = new Date();
            let startDate = new Date();
            
            switch(range) {
                case '1D':
                    startDate.setDate(endDate.getDate() - 1);
                    break;
                case '1W':
                    startDate.setDate(endDate.getDate() - 7);
                    break;
                case '1M':
                    startDate.setMonth(endDate.getMonth() - 1);
                    break;
                case '3M':
                    startDate.setMonth(endDate.getMonth() - 3);
                    break;
                case '1Y':
                    startDate.setFullYear(endDate.getFullYear() - 1);
                    break;
            }
            
            // Filter data based on date range
            // This is a placeholder - you would fetch actual data from your backend
            console.log(`Updating ${chartId} chart with data from ${startDate.toISOString()} to ${endDate.toISOString()}`);
            
            // Update the appropriate chart
            if (chartId === 'volume' && window.volumeChart) {
                // Example: Update volume chart with new data
                // You would replace this with actual data fetching
                const newData = generateChartDataForRange(startDate, endDate);
                window.volumeChart.series[0].setData(newData);
            }
        }

        function showCustomDatePicker(chartId, event) {
            if (event) {
                event.preventDefault();
            }
            
            // Create a simple date range picker
            const modal = document.createElement('div');
            modal.className = 'date-picker-modal';
            modal.innerHTML = `
                <div class="date-picker-content">
                    <h3>Select Date Range</h3>
                    <div class="date-inputs">
                        <div>
                            <label>Start Date:</label>
                            <input type="date" id="startDate" class="date-input">
                        </div>
                        <div>
                            <label>End Date:</label>
                            <input type="date" id="endDate" class="date-input" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <div class="date-picker-actions">
                        <button onclick="applyCustomDateRange('${chartId}')" class="btn-primary">Apply</button>
                        <button onclick="closeDatePicker()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function applyCustomDateRange(chartId) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                showNotification(`Applying custom date range...`);
                // Update chart with custom date range
                console.log(`Custom range for ${chartId}: ${startDate} to ${endDate}`);
                closeDatePicker();
            } else {
                showNotification('Please select both start and end dates');
            }
        }

        function closeDatePicker() {
            const modal = document.querySelector('.date-picker-modal');
            if (modal) {
                modal.remove();
            }
        }

        function generateChartDataForRange(startDate, endDate) {
            // Generate sample data for the date range
            const data = [];
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            for (let i = 0; i < days; i++) {
                data.push(Math.floor(Math.random() * 100) + 50);
            }
            
            return data;
        }

        function toggleComparison(chartId) {
            const isChecked = document.getElementById('compare' + chartId.charAt(0).toUpperCase() + chartId.slice(1)).checked;

            if (isChecked && chartId === 'volume') {
                volumeChart.addSeries({
                    name: 'Previous Period',
                    data: [165, 85, 140, 210, 125, 78],
                    color: '#94a3b8'
                });
            } else if (!isChecked && chartId === 'volume') {
                if (volumeChart.series.length > 1) {
                    volumeChart.series[1].remove();
                }
            }
        }

        function toggleForecast() {
            const forecastSeries = trendChart.series[1];
            if (forecastSeries) {
                forecastSeries.setVisible(!forecastSeries.visible);
                showNotification(forecastSeries.visible ? 'Forecast enabled' : 'Forecast disabled');
            }
        }

        function changeHeatmapView() {
            showNotification('Switching heatmap view...');
            // Implement view change logic
        }

        function resetNetwork() {
            networkChart.series[0].setData(generateNetworkData());
            showNotification('Network chart reset');
        }

        function showDetailedMetrics(metric) {
            const panel = document.getElementById('drilldownPanel');
            const title = document.getElementById('drilldownTitle');
            const subtitle = document.getElementById('drilldownSubtitle');
            const content = document.getElementById('drilldownContent');

            // Set title based on metric
            const titles = {
                'transactions': 'Transaction Analytics',
                'value': 'Value Distribution Analysis',
                'pending': 'Pending Transaction Details',
                'approved': 'Approval Metrics'
            };

            title.textContent = titles[metric] || 'Detailed Analysis';
            subtitle.textContent = 'Click on any element for more details';

            // Generate content based on metric
            content.innerHTML = `
                <div class="drilldown-charts">
                    <div class="chart-container">
                        <h3 class="chart-title">Daily Breakdown</h3>
                        <div id="drilldown-chart-1" style="height: 300px;"></div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Category Distribution</h3>
                        <div id="drilldown-chart-2" style="height: 300px;"></div>
                    </div>
                </div>
            `;

            panel.classList.add('active');

            // Initialize drill-down charts with actual data
            setTimeout(() => {
                // Calculate daily breakdown from actual transactions
                const dailyData = calculateDailyBreakdown(metric);
                
                Highcharts.chart('drilldown-chart-1', {
                    chart: { type: 'spline', backgroundColor: 'transparent' },
                    title: { text: null },
                    xAxis: {
                        type: 'datetime',
                        labels: {
                            format: '{value:%b %d}'
                        }
                    },
                    yAxis: {
                        title: { text: 'Count' }
                    },
                    series: [{
                        name: 'Daily ' + metric,
                        data: dailyData
                    }]
                });

                // Calculate category distribution from actual data
                const categoryData = calculateCategoryDistribution(metric);
                
                Highcharts.chart('drilldown-chart-2', {
                    chart: { type: 'pie', backgroundColor: 'transparent' },
                    title: { text: null },
                    plotOptions: {
                        pie: {
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: {point.percentage:.1f}%'
                            }
                        }
                    },
                    series: [{
                        name: 'Distribution',
                        data: categoryData
                    }]
                });
            }, 100);
        }

        // Filter functions
        function applyFilters() {
            // Show loading state
            showLoadingState();

            const module = document.getElementById('moduleFilter').value;
            const status = document.getElementById('statusFilter').value;
            const entity = document.getElementById('entityFilter').value;

            // Update active filter visual indicators
            updateFilterIndicators();

            setTimeout(() => {
                filteredTransactions = allTransactions.filter(transaction => {
                    return (!module || transaction.module === module) &&
                           (!status || transaction.status.toLowerCase() === status) &&
                           (!entity || transaction.entity.toLowerCase() === entity.toLowerCase());
                });

                currentPage = 1;
                loadTransactionTable();
                updateChartsWithFilteredData();
                updateKPIMetrics();

                // Hide loading state
                hideLoadingState();

                // Show filter count and results
                const activeFilters = [module, status, entity].filter(f => f).length;
                const resultsCount = filteredTransactions.length;
                const totalCount = allTransactions.length;

                // Update results count display
                const resultsCountDiv = document.getElementById('filterResultsCount');
                const resultsText = document.getElementById('resultsText');

                if (resultsCountDiv && resultsText) {
                    resultsCountDiv.style.opacity = '1';

                    if (activeFilters > 0) {
                        resultsText.textContent = `Showing ${resultsCount} of ${totalCount} transactions`;
                        resultsText.style.color = '#4f46e5';

                        // Animate the count
                        resultsCountDiv.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            resultsCountDiv.style.transform = 'scale(1)';
                        }, 200);
                    } else {
                        resultsText.textContent = `Showing all ${totalCount} transactions`;
                        resultsText.style.color = '#64748b';
                    }
                }
            }, 300);
        }

        function updateFilterIndicators() {
            // Update visual state of dropdowns based on their values
            document.querySelectorAll('.filter-select').forEach(select => {
                if (select.value) {
                    select.style.background = 'linear-gradient(rgba(249, 250, 255, 1), rgba(249, 250, 255, 1)) padding-box, linear-gradient(135deg, rgba(99, 102, 241, 0.5) 0%, rgba(139, 92, 246, 0.5) 100%) border-box';
                    select.style.color = '#4f46e5';
                } else {
                    select.style.background = '';
                    select.style.color = '';
                }
            });
        }

        function resetFilters() {
            // Show loading briefly
            showLoadingState();

            setTimeout(() => {
                document.querySelectorAll('.filter-select').forEach(select => {
                    select.value = '';
                    select.style.background = '';
                    select.style.color = '';
                });

                filteredTransactions = [...allTransactions];
                currentPage = 1;
                loadTransactionTable();
                updateChartsWithFilteredData();
                updateKPIMetrics();

                // Update results count
                const resultsText = document.getElementById('resultsText');
                if (resultsText) {
                    resultsText.textContent = `Showing all ${allTransactions.length} transactions`;
                    resultsText.style.color = '#64748b';
                }

                hideLoadingState();
                showNotification('All filters cleared');
            }, 300);
        }

        // Advanced panel functions
        function toggleAdvancedPanel() {
            const panel = document.getElementById('advancedPanel');
            panel.classList.toggle('active');
        }

        // Settings handlers
        document.getElementById('refreshInterval').addEventListener('input', function(e) {
            document.getElementById('refreshValue').textContent = e.target.value + 's';
        });

        // Notification function
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #1e293b;
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                z-index: 3000;
                animation: slideUp 0.3s ease;
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        // Auto-refresh functionality
        let refreshInterval;
        function startAutoRefresh() {
            const interval = document.getElementById('refreshInterval').value * 1000;
            refreshInterval = setInterval(() => {
                if (document.getElementById('autoRefresh').checked) {
                    console.log('Refreshing data...');
                    // Implement data refresh logic
                }
            }, interval);
        }

        // Loading state functions
        function showLoadingState() {
            // Add loading class to filter section for shimmer
            const filterSection = document.querySelector('.filter-section');
            if (filterSection) {
                filterSection.classList.add('loading');
            }

            // Show loading spinners for all charts
            document.querySelectorAll('.chart-loading').forEach(loader => {
                loader.style.display = 'flex';
            });
        }

        function hideLoadingState() {
            // Remove loading class from filter section
            const filterSection = document.querySelector('.filter-section');
            if (filterSection) {
                filterSection.classList.remove('loading');
            }

            // Hide loading spinners for all charts
            document.querySelectorAll('.chart-loading').forEach(loader => {
                loader.style.display = 'none';
            });
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Show initial loading state
            showLoadingState();

            // Initialize charts with a slight delay for better UX
            setTimeout(() => {
                initializeCharts();
                
                // Set default date range to month and apply filters
                document.getElementById('dateRangeFilter').value = 'month';
                applyDateRangeFilter();
                
                // Try to load saved filter preset
                loadFilterPreset();
                
                startAutoRefresh();

                // Hide loading state after initialization
                setTimeout(() => {
                    hideLoadingState();
                }, 500);
            }, 300);

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.export-menu')) {
                    document.querySelectorAll('.export-dropdown').forEach(dropdown => {
                        dropdown.classList.remove('active');
                    });
                }

                if (!e.target.closest('.action-menu')) {
                    document.querySelectorAll('.action-menu-dropdown').forEach(dropdown => {
                        dropdown.classList.remove('active');
                    });
                }
            });

            // Hide node tooltip when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.network-node')) {
                    document.getElementById('nodeTooltip').classList.remove('active');
                }
            });
        });

        // Simplified Date Range Filtering
        function applyDateRangeFilter() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            let startDate, endDate;
            const now = new Date();
            
            switch(dateRange) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    endDate = new Date(now.setHours(23, 59, 59, 999));
                    break;
                case 'week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startDate = new Date(startOfWeek.setHours(0, 0, 0, 0));
                    endDate = new Date();
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date();
                    break;
                case '3months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                    endDate = new Date();
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date();
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date();
            }
            
            // Apply date filter to transactions
            filteredTransactions = allTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            // Apply other active filters
            applyAllFilters();
        }

        // Enhanced filtering with all new filter options
        function applyFilters() {
            applyAllFilters();
        }

        function applyAllFilters() {
            showLoadingState();

            const repository = document.getElementById('repositoryFilter').value;
            const module = document.getElementById('moduleFilter').value;
            const status = document.getElementById('statusFilter').value;
            const amountRange = document.getElementById('amountFilter').value;

            setTimeout(() => {
                // Start with date-filtered transactions
                let filtered = [...filteredTransactions];
                
                // Apply repository filter
                if (repository) {
                    filtered = filtered.filter(t => t.repository === repository);
                }
                
                // Apply module filter
                if (module) {
                    filtered = filtered.filter(t => t.module === module);
                }
                
                // Apply status filter
                if (status) {
                    filtered = filtered.filter(t => t.status.toLowerCase() === status);
                }
                
                // Apply amount range filter
                if (amountRange) {
                    const [min, max] = amountRange.includes('+') 
                        ? [parseInt(amountRange.replace('+', '')), Infinity]
                        : amountRange.split('-').map(v => parseInt(v));
                    
                    filtered = filtered.filter(t => t.amount >= min && t.amount <= max);
                }

                // Update filteredTransactions for display
                filteredTransactions = filtered;

                currentPage = 1;
                loadTransactionTable();
                updateChartsWithFilteredData();
                updateKPIMetrics();

                hideLoadingState();

                // Update results count
                updateFilterResultsCount(filtered.length);
            }, 500);
        }

        function updateFilterResultsCount(count) {
            const resultsCountDiv = document.getElementById('filterResultsCount');
            const resultsText = document.getElementById('resultsText');
            
            if (resultsCountDiv && resultsText) {
                resultsCountDiv.style.opacity = '1';
                resultsText.textContent = `Showing ${count.toLocaleString()} of ${allTransactions.length.toLocaleString()} transactions`;
            }
        }

        function clearAllFilters() {
            // Reset all filter selects
            document.querySelectorAll('.filter-select').forEach(select => {
                if (select.id === 'dateRangeFilter') {
                    select.value = 'month'; // Set date range back to month
                } else {
                    select.value = '';
                }
            });
            
            // Apply filters (which will show all data for the month)
            applyDateRangeFilter();
            
            // Update results text
            const resultsText = document.getElementById('resultsText');
            if (resultsText) {
                resultsText.textContent = 'Showing all transactions';
                resultsText.style.color = '#64748b';
            }
        }

        function saveFilterPreset() {
            const filters = {
                dateRange: document.getElementById('dateRangeFilter').value,
                repository: document.getElementById('repositoryFilter').value,
                module: document.getElementById('moduleFilter').value,
                status: document.getElementById('statusFilter').value,
                amount: document.getElementById('amountFilter').value
            };
            
            localStorage.setItem('analyticsFilterPreset', JSON.stringify(filters));
            showNotification('Filter preset saved successfully!');
        }

        function loadFilterPreset() {
            const saved = localStorage.getItem('analyticsFilterPreset');
            if (saved) {
                const filters = JSON.parse(saved);
                
                // Apply saved filters
                if (filters.dateRange) document.getElementById('dateRangeFilter').value = filters.dateRange;
                if (filters.repository) document.getElementById('repositoryFilter').value = filters.repository;
                if (filters.module) document.getElementById('moduleFilter').value = filters.module;
                if (filters.status) document.getElementById('statusFilter').value = filters.status;
                if (filters.amount) document.getElementById('amountFilter').value = filters.amount;
                
                // Apply the date range filter
                applyDateRangeFilter();
                
                showNotification('Filter preset loaded successfully!');
            }
        }

        function exportFilteredData() {
            const csv = convertToCSV(filteredTransactions);
            downloadCSV(csv, 'filtered_analytics_data.csv');
            showNotification('Data exported successfully!');
        }

        function convertToCSV(data) {
            const headers = ['ID', 'Repository', 'Module', 'Entity', 'Amount', 'Status', 'Date', 'Product', 'Tier', 'Priority', 'Channel'];
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = [
                    row.id, row.repository, row.module, row.entity, row.amount, 
                    row.status, row.date, row.product, row.tier, row.priority, row.channel
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: rgba(16, 185, 129, 0.9); color: white;
                padding: 12px 20px; border-radius: 8px; font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                transform: translateX(400px); transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Second DOMContentLoaded listener removed - consolidated with the first one

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // Module Transaction Table Functions
        function loadModuleTransactions(transactions) {
            console.log('Loading module transactions:', transactions.length);
            console.log('First 5 module transactions:', transactions.slice(0, 5));
            
            moduleTransactions = transactions;
            filteredModuleTransactions = [...moduleTransactions];
            moduleCurrentPage = 1;
            
            // Sort by date by default (most recent first)
            filteredModuleTransactions.sort((a, b) => 
                new Date(b.date).getTime() - new Date(a.date).getTime()
            );
            
            displayModuleTransactions();
        }

        function displayModuleTransactions() {
            const tbody = document.getElementById('moduleTransactionTableBody');
            if (!tbody) {
                console.error('Module transaction table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            const startIndex = (moduleCurrentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredModuleTransactions.slice(startIndex, endIndex);
            
            console.log(`Displaying module transactions: ${pageTransactions.length} transactions on page ${moduleCurrentPage}`);
            console.log(`Total module transactions: ${filteredModuleTransactions.length}`);
            console.log(`Showing items ${startIndex + 1} to ${endIndex}`);
            console.log('Transactions to display:', pageTransactions);
            
            // Verify all transactions belong to the current module
            const wrongModuleCount = pageTransactions.filter(t => t.module !== currentModule).length;
            if (wrongModuleCount > 0) {
                console.error(`ERROR: ${wrongModuleCount} transactions don't belong to module ${currentModule}!`);
            }
            
            pageTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td>${transaction.entity}</td>
                    <td>${transaction.product}</td>
                    <td>$${transaction.amount.toLocaleString()}</td>
                    <td><span class="status-badge status-${transaction.status.toLowerCase()}">${transaction.status}</span></td>
                    <td>${transaction.date}</td>
                    <td>
                        <div class="action-menu">
                            <button class="chart-action-btn" onclick="viewTransaction('${transaction.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="chart-action-btn" onclick="toggleActionMenu('${transaction.id}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="action-menu-dropdown" id="menu-${transaction.id}">
                                <div class="action-menu-item" onclick="exportTransaction('${transaction.id}')">
                                    <i class="fas fa-download"></i>
                                    <span>Export</span>
                                </div>
                                <div class="action-menu-item" onclick="shareTransaction('${transaction.id}')">
                                    <i class="fas fa-share"></i>
                                    <span>Share</span>
                                </div>
                                <div class="action-menu-item" onclick="auditTransaction('${transaction.id}')">
                                    <i class="fas fa-history"></i>
                                    <span>Audit Trail</span>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateModulePagination();
        }

        function updateModulePagination() {
            const totalPages = Math.ceil(filteredModuleTransactions.length / itemsPerPage);
            const pageInfo = document.getElementById('modulePageInfo');
            if (pageInfo) {
                // Show page info with transaction count
                const startItem = ((moduleCurrentPage - 1) * itemsPerPage) + 1;
                const endItem = Math.min(moduleCurrentPage * itemsPerPage, filteredModuleTransactions.length);
                pageInfo.textContent = `Showing ${startItem}-${endItem} of ${filteredModuleTransactions.length} | Page ${moduleCurrentPage} of ${totalPages || 1}`;
            }
            
            const prevBtn = document.getElementById('modulePrevBtn');
            const nextBtn = document.getElementById('moduleNextBtn');
            if (prevBtn) prevBtn.disabled = moduleCurrentPage === 1;
            if (nextBtn) nextBtn.disabled = moduleCurrentPage === totalPages || totalPages === 0;
        }

        function previousModulePage() {
            if (moduleCurrentPage > 1) {
                moduleCurrentPage--;
                displayModuleTransactions();
            }
        }

        function nextModulePage() {
            const totalPages = Math.ceil(filteredModuleTransactions.length / itemsPerPage);
            if (moduleCurrentPage < totalPages) {
                moduleCurrentPage++;
                displayModuleTransactions();
            }
        }

        function searchModuleTransactions() {
            const searchTerm = document.getElementById('moduleTransactionSearch').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredModuleTransactions = [...moduleTransactions];
            } else {
                filteredModuleTransactions = moduleTransactions.filter(transaction =>
                    transaction.id.toLowerCase().includes(searchTerm) ||
                    transaction.entity.toLowerCase().includes(searchTerm) ||
                    transaction.product.toLowerCase().includes(searchTerm) ||
                    transaction.status.toLowerCase().includes(searchTerm) ||
                    transaction.customer.toLowerCase().includes(searchTerm)
                );
            }
            
            moduleCurrentPage = 1;
            displayModuleTransactions();
        }

        function sortModuleTable(column) {
            if (moduleSortColumn === column) {
                moduleSortDirection = moduleSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                moduleSortColumn = column;
                moduleSortDirection = 'asc';
            }
            
            filteredModuleTransactions.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (column === 'amount') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                } else if (column === 'date') {
                    aVal = new Date(aVal).getTime();
                    bVal = new Date(bVal).getTime();
                }
                
                if (moduleSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            displayModuleTransactions();
        }

        function exportModuleTransactions(moduleName) {
            const csv = convertToCSV(filteredModuleTransactions);
            downloadCSV(csv, `${moduleName}_transactions_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification(`Exporting ${moduleName} transactions...`);
        }
    </script>
</body>
</html>