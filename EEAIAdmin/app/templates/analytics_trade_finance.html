<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Finance Analytics Dashboard - Finstack</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/floating-header.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        :root {
            --primary-color: #f093fb;
            --secondary-color: #f5576c;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --bg-color: #f0f2f5;
            --text-color: #1a202c;
            --card-bg: white;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            padding-top: 120px; /* Space for floating header */
        }

        .status-pulse {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.9);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .brand-info h1 {
            font-size: 24px !important;
            font-weight: 800 !important;
            margin: 0 !important;
            color: #1e293b !important;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
        }

        .brand-info p {
            font-size: 13px !important;
            color: #64748b !important;
            margin: 0 !important;
            font-weight: 500 !important;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-button {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            padding: 10px 18px !important;
            border-radius: 12px !important;
            font-size: 13px !important;
            font-weight: 600 !important;
            text-decoration: none !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .action-button.primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 70%, #06b6d4 100%) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .action-button.primary:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4) !important;
        }

        .action-button.secondary {
            background: #f8fafc !important;
            color: #374151 !important;
            border: 1px solid #e2e8f0 !important;
        }

        .action-button.secondary:hover {
            background: #f1f5f9 !important;
            color: #1f2937 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }

        /* Back Button Special Style */
        .back-button {
            background: #f1f5f9 !important;
            color: #475569 !important;
            border: 1px solid #cbd5e1 !important;
        }

        .back-button:hover {
            background: #e2e8f0 !important;
            color: #334155 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }

        /* Animations */
        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes logoFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-2px);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 120px 25px 25px 25px;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 180px;
        }

        .filter-label {
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-input {
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #ffffff;
            color: #1e293b;
        }

        .filter-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: #ffffff;
        }

        .filter-input option {
            background: #ffffff;
            color: #1e293b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 22px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 1);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 22px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 1);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .chart-actions {
            display: flex;
            gap: 8px;
        }

        .chart-action-btn {
            padding: 6px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #64748b;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .chart-action-btn:hover {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            transform: translateY(-1px);
            border-color: transparent;
        }

        .chart-action-btn.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-color: transparent;
        }

        .chart-container {
            position: relative;
            height: 350px !important;
            max-height: 350px;
            overflow: hidden;
        }

        .chart-container canvas {
            max-height: 100% !important;
            height: 100% !important;
        }

        .table-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 22px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            border-bottom: 1px solid #e2e8f0;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #1e293b;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.pending {
            background: #fed7aa;
            color: #92400e;
        }

        .status-badge.completed {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.expired {
            background: #fee2e2;
            color: #991b1b;
        }

        .amount-cell {
            font-weight: 600;
            color: #10b981;
        }

        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 1200px) {
            .brand-info p {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .floating-header {
                top: 12px;
                left: 12px;
                right: 12px;
            }
            
            .floating-header-content {
                padding: 12px 20px;
            }
            
            .brand-info h1 {
                font-size: 20px !important;
            }
            
            .header-actions {
                gap: 8px;
            }
            
            .action-button span {
                display: none !important;
            }
            
            .action-button {
                padding: 8px 12px !important;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
            }

            .chart-container {
                height: 300px !important;
                max-height: 300px;
            }

            .container {
                padding: 100px 15px 25px 15px;
            }
        }

        @media (max-width: 480px) {
            .brand-info h1 {
                font-size: 18px !important;
            }
            
            .modern-logo {
                width: 40px;
                height: 40px;
            }
        }

        /* Chart Interaction Styles */
        .chart-clickable {
            cursor: pointer;
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }

        /* Modal Styles for Detailed Charts */
        .chart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.3s ease-out;
        }

        .chart-modal.active {
            display: flex;
        }

        .chart-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 24px;
            padding: 30px;
            max-width: 95vw;
            max-height: 95vh;
            width: 1200px;
            height: 800px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .chart-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        .chart-modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: #f1f5f9;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
            font-size: 18px;
        }

        .chart-modal-close:hover {
            background: #e2e8f0;
            color: #1e293b;
            transform: scale(1.05);
        }

        .chart-modal-body {
            height: calc(100% - 80px);
            display: flex;
            flex-direction: column;
        }

        .chart-modal-chart-container {
            flex: 1;
            position: relative;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
        }

        .primary-chart-container {
            flex: 1;
            position: relative;
            min-height: 300px;
        }

        .secondary-chart-container {
            flex: 1;
            position: relative;
            min-height: 300px;
            border-left: 2px solid #e2e8f0;
            padding-left: 20px;
            display: none;
        }

        .secondary-chart-container.active {
            display: block;
        }

        .chart-container-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
        }

        .chart-container-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .chart-nav-buttons {
            display: flex;
            gap: 8px;
        }

        .chart-nav-btn {
            padding: 6px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #64748b;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .chart-nav-btn:hover {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .chart-nav-btn.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .nested-chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 15px;
            border: 1px solid #f1f5f9;
            border-radius: 8px;
            padding: 15px;
            background: #fafbfc;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }

        .chart-grid.single {
            grid-template-columns: 1fr;
        }

        .chart-drill-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .chart-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-overlay.hover {
            display: flex;
            background: rgba(99, 102, 241, 0.1);
        }

        .chart-overlay-text {
            background: white;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            font-weight: 600;
            color: #6366f1;
        }

        .chart-modal-details {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #374151;
        }

        .detail-value {
            color: #6366f1;
            font-weight: 700;
        }

        /* Chart Highlight Effects */
        .chart-segment-hover {
            filter: brightness(1.1);
            transform: scale(1.05);
            transition: all 0.2s ease;
        }

        /* Breadcrumb Navigation */
        .chart-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #64748b;
        }

        .breadcrumb-item {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .breadcrumb-item:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .breadcrumb-separator {
            color: #cbd5e1;
        }

        @keyframes modalFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes modalSlideIn {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Chart Loading State */
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: #64748b;
        }

        .chart-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Interactive Chart Indicators */
        .chart-interactive-hint {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Global Floating Header -->
    {% include 'components/floating_header.html' %}

    <div class="container">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <select class="filter-input" id="dateRange" onchange="applyFilters()">
                        <option value="1d">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d" selected>Last 30 Days</option>
                        <option value="3m">Last 3 Months</option>
                        <option value="6m">Last 6 Months</option>
                        <option value="1y">Last Year</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Product Type</label>
                    <select class="filter-input" id="productType" onchange="applyFilters()">
                        <option value="all">All Products</option>
                        <option value="lc">Letter of Credit</option>
                        <option value="bg">Bank Guarantee</option>
                        <option value="sblc">Standby LC</option>
                        <option value="collection">Documentary Collection</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-input" id="status" onchange="applyFilters()">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Region</label>
                    <select class="filter-input" id="region" onchange="applyFilters()">
                        <option value="all">All Regions</option>
                        <option value="mena">MENA</option>
                        <option value="asia">Asia Pacific</option>
                        <option value="europe">Europe</option>
                        <option value="americas">Americas</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <div class="stat-value" id="totalLCs">327</div>
                <div class="stat-label">Active LCs</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> 12.4% from last month
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-value" id="totalValue">$84.3M</div>
                <div class="stat-label">Total Portfolio Value</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> 18.7% from last month
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="stat-value" id="totalGuarantees">142</div>
                <div class="stat-label">Bank Guarantees</div>
                <div class="stat-change negative">
                    <i class="fas fa-arrow-down"></i> 3.2% from last month
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-value" id="utilizationRate">78.5%</div>
                <div class="stat-label">Utilization Rate</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> 5.3% from last month
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value" id="avgProcessing">2.4 days</div>
                <div class="stat-label">Avg Processing Time</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-down"></i> 15% improvement
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value" id="complianceRate">98.7%</div>
                <div class="stat-label">Compliance Rate</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> 0.8% from last month
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- LC Volume Trend -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">LC Volume Trend</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn active" onclick="changeChartPeriod('lcTrend', 'daily')">Daily</button>
                        <button class="chart-action-btn" onclick="changeChartPeriod('lcTrend', 'weekly')">Weekly</button>
                        <button class="chart-action-btn" onclick="changeChartPeriod('lcTrend', 'monthly')">Monthly</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="lcTrendChart"></canvas>
                </div>
            </div>

            <!-- Product Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Product Distribution</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" onclick="exportChart('productDist')">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="chart-container" style="position: relative;">
                    <canvas id="productDistChart"></canvas>
                    <div class="chart-interactive-hint">Click segments for details</div>
                </div>
            </div>

            <!-- Regional Performance -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Regional Performance</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" onclick="toggleChartType('regional')">
                            <i class="fas fa-chart-bar"></i> Switch View
                        </button>
                    </div>
                </div>
                <div class="chart-container" style="position: relative;">
                    <canvas id="regionalChart"></canvas>
                    <div class="chart-interactive-hint">Click bars for breakdown</div>
                </div>
            </div>

            <!-- Bank-wise Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Top Issuing Banks</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" onclick="showDetails('banks')">Details</button>
                    </div>
                </div>
                <div class="chart-container" style="position: relative;">
                    <canvas id="bankDistChart"></canvas>
                    <div class="chart-interactive-hint">Click banks for details</div>
                </div>
            </div>

            <!-- Processing Time Analysis -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <h3 class="chart-title">Processing Time Analysis by Product Type</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" onclick="refreshChart('processing')">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="processingTimeChart"></canvas>
                </div>
            </div>

            <!-- Risk Assessment -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Risk Assessment Matrix</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" onclick="showRiskDetails()">
                            <i class="fas fa-info-circle"></i> Info
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>

            <!-- Currency Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Currency Distribution</h3>
                    <div class="chart-actions">
                        <button class="chart-action-btn" onclick="toggleCurrencyView()">Toggle %</button>
                    </div>
                </div>
                <div class="chart-container" style="position: relative;">
                    <canvas id="currencyChart"></canvas>
                    <div class="chart-interactive-hint">Click currencies for breakdown</div>
                </div>
            </div>
        </div>

        <!-- Recent Transactions Table -->
        <div class="table-card">
            <div class="chart-header">
                <h3 class="chart-title">Recent Trade Finance Transactions</h3>
                <div class="chart-actions">
                    <button class="chart-action-btn" onclick="exportTableData()">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button class="chart-action-btn" onclick="refreshTable()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="loading-spinner" id="tableLoader"></div>
            <table class="data-table" id="transactionTable">
                <thead>
                    <tr>
                        <th>Reference</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Beneficiary</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Expiry</th>
                        <th>Status</th>
                        <th>Bank</th>
                    </tr>
                </thead>
                <tbody id="transactionTableBody">
                    <!-- Dynamic content will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Chart Detail Modal -->
    <div id="chartModal" class="chart-modal">
        <div class="chart-modal-content">
            <div class="chart-modal-header">
                <h3 id="modalTitle" class="chart-modal-title">Chart Details</h3>
                <button class="chart-modal-close" onclick="closeChartModal()">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="chart-modal-body">
                <div id="modalBreadcrumb" class="chart-breadcrumb"></div>
                <div class="chart-modal-chart-container">
                    <div class="primary-chart-container">
                        <div class="chart-container-header">
                            <h4 id="primaryChartTitle" class="chart-container-title">Main Analysis</h4>
                            <div class="chart-nav-buttons">
                                <button class="chart-nav-btn active" onclick="showChartView('single')">Single View</button>
                                <button class="chart-nav-btn" onclick="showChartView('split')">Split View</button>
                                <button class="chart-nav-btn" onclick="showChartView('nested')">Nested View</button>
                            </div>
                        </div>
                        <div class="nested-chart-container" id="primaryChartArea">
                            <canvas id="modalChart"></canvas>
                            <div class="chart-drill-indicator" id="drillIndicator">Click segments for sub-analysis</div>
                        </div>
                        <div id="modalChartLoading" class="chart-loading" style="display: none;">
                            <div class="chart-loading-spinner"></div>
                            <span>Loading chart data...</span>
                        </div>
                    </div>
                    <div class="secondary-chart-container" id="secondaryChartContainer">
                        <div class="chart-container-header">
                            <h4 id="secondaryChartTitle" class="chart-container-title">Sub Analysis</h4>
                            <div class="chart-nav-buttons">
                                <button class="chart-nav-btn" onclick="switchSecondaryChart('trend')">Trend</button>
                                <button class="chart-nav-btn" onclick="switchSecondaryChart('breakdown')">Breakdown</button>
                                <button class="chart-nav-btn" onclick="switchSecondaryChart('comparison')">Compare</button>
                            </div>
                        </div>
                        <div class="nested-chart-container" id="secondaryChartArea">
                            <canvas id="secondaryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Nested Charts Grid for Multiple Sub-Charts -->
                <div id="nestedChartsGrid" class="chart-grid" style="display: none; height: 300px; margin-bottom: 20px;">
                    <div class="nested-chart-container">
                        <h5 style="margin: 0 0 10px 0; font-size: 14px; color: #374151;">Sub-Chart 1</h5>
                        <canvas id="nestedChart1"></canvas>
                        <div class="chart-overlay" onclick="expandNestedChart(1)">
                            <div class="chart-overlay-text">Click to expand</div>
                        </div>
                    </div>
                    <div class="nested-chart-container">
                        <h5 style="margin: 0 0 10px 0; font-size: 14px; color: #374151;">Sub-Chart 2</h5>
                        <canvas id="nestedChart2"></canvas>
                        <div class="chart-overlay" onclick="expandNestedChart(2)">
                            <div class="chart-overlay-text">Click to expand</div>
                        </div>
                    </div>
                    <div class="nested-chart-container">
                        <h5 style="margin: 0 0 10px 0; font-size: 14px; color: #374151;">Sub-Chart 3</h5>
                        <canvas id="nestedChart3"></canvas>
                        <div class="chart-overlay" onclick="expandNestedChart(3)">
                            <div class="chart-overlay-text">Click to expand</div>
                        </div>
                    </div>
                    <div class="nested-chart-container">
                        <h5 style="margin: 0 0 10px 0; font-size: 14px; color: #374151;">Sub-Chart 4</h5>
                        <canvas id="nestedChart4"></canvas>
                        <div class="chart-overlay" onclick="expandNestedChart(4)">
                            <div class="chart-overlay-text">Click to expand</div>
                        </div>
                    </div>
                </div>
                <div id="modalDetails" class="chart-modal-details"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for charts and data
        let charts = {};
        let modalChart = null;
        let secondaryChart = null;
        let nestedCharts = {};
        let allTransactions = [];
        let filteredData = [];
        let currentFilters = {
            dateRange: '30d',
            productType: 'all',
            status: 'all',
            region: 'all'
        };
        let chartDrillDown = {
            active: false,
            parentChart: null,
            breadcrumb: [],
            level: 0,
            currentView: 'single', // single, split, nested
            selectedData: null
        };

        // Regional mappings for banks
        const bankRegions = {
            'HSBC': 'europe',
            'Standard Chartered': 'europe', 
            'Citi': 'americas',
            'JP Morgan': 'americas',
            'Bank of America': 'americas',
            'Emirates NBD': 'mena',
            'ADCB': 'mena',
            'FAB': 'mena',
            'DBS': 'asia',
            'OCBC': 'asia',
            'UBS': 'europe',
            'Credit Suisse': 'europe'
        };

        // Product type mappings
        const productTypeMap = {
            'lc': ['Import LC', 'Export LC'],
            'bg': ['Bank Guarantee'],
            'sblc': ['SBLC'],
            'collection': ['Collection']
        };

        // Generate comprehensive realistic data
        function generateRealisticData() {
            const banks = ['HSBC', 'Standard Chartered', 'Citi', 'JP Morgan', 'Bank of America', 'Emirates NBD', 'ADCB', 'FAB', 'DBS', 'OCBC', 'UBS', 'Credit Suisse'];
            const beneficiaries = ['ABC Trading LLC', 'Global Exports Inc', 'Prime Industries', 'Tech Solutions Ltd', 'Maritime Logistics', 'Energy Corp', 'Construction Co', 'Textile Mills', 'Manufacturing Corp', 'Import Export Ltd'];
            const types = ['Import LC', 'Export LC', 'Bank Guarantee', 'SBLC', 'Collection'];
            const currencies = ['USD', 'EUR', 'AED', 'GBP', 'JPY', 'CNY'];
            const statuses = ['Active', 'Pending', 'Completed', 'Expired'];

            const transactions = [];
            const today = new Date();

            for (let i = 0; i < 500; i++) {
                const daysAgo = Math.floor(Math.random() * 365); // Full year of data
                const date = new Date(today - daysAgo * 24 * 60 * 60 * 1000);
                const expiryDays = Math.floor(Math.random() * 180) + 30;
                const expiryDate = new Date(date.getTime() + expiryDays * 24 * 60 * 60 * 1000);
                const bank = banks[Math.floor(Math.random() * banks.length)];
                const type = types[Math.floor(Math.random() * types.length)];

                transactions.push({
                    reference: `TF${String(2024000 + i).padStart(7, '0')}`,
                    date: date.toISOString().split('T')[0],
                    type: type,
                    beneficiary: beneficiaries[Math.floor(Math.random() * beneficiaries.length)],
                    amount: Math.floor(Math.random() * 5000000) + 100000,
                    currency: currencies[Math.floor(Math.random() * currencies.length)],
                    expiry: expiryDate.toISOString().split('T')[0],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    bank: bank,
                    region: bankRegions[bank] || 'mena'
                });
            }

            return transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Filter data based on current filter settings
        function filterData() {
            const { dateRange, productType, status, region } = currentFilters;
            
            // Calculate date range
            const today = new Date();
            let startDate = new Date();
            
            switch(dateRange) {
                case '1d':
                    startDate.setDate(today.getDate() - 1);
                    break;
                case '7d':
                    startDate.setDate(today.getDate() - 7);
                    break;
                case '30d':
                    startDate.setDate(today.getDate() - 30);
                    break;
                case '3m':
                    startDate.setMonth(today.getMonth() - 3);
                    break;
                case '6m':
                    startDate.setMonth(today.getMonth() - 6);
                    break;
                case '1y':
                    startDate.setFullYear(today.getFullYear() - 1);
                    break;
            }

            filteredData = allTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                
                // Date filter
                if (transactionDate < startDate) return false;
                
                // Product type filter
                if (productType !== 'all') {
                    const allowedTypes = productTypeMap[productType];
                    if (!allowedTypes.includes(transaction.type)) return false;
                }
                
                // Status filter
                if (status !== 'all' && transaction.status.toLowerCase() !== status.toLowerCase()) {
                    return false;
                }
                
                // Region filter
                if (region !== 'all' && transaction.region !== region) {
                    return false;
                }
                
                return true;
            });
        }

        // Initialize LC Trend Chart
        function initLCTrendChart() {
            const ctx = document.getElementById('lcTrendChart').getContext('2d');
            const labels = [];
            const lcData = [];
            const bgData = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en', { month: 'short', day: 'numeric' }));
                lcData.push(Math.floor(Math.random() * 20) + 10);
                bgData.push(Math.floor(Math.random() * 15) + 5);
            }

            charts.lcTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Letters of Credit',
                        data: lcData,
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Bank Guarantees',
                        data: bgData,
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Initialize Product Distribution Chart with Click Handling
        function initProductDistChart() {
            const ctx = document.getElementById('productDistChart').getContext('2d');
            charts.productDist = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Import LC', 'Export LC', 'Bank Guarantee', 'SBLC', 'Documentary Collection'],
                    datasets: [{
                        data: [145, 98, 142, 67, 45],
                        backgroundColor: [
                            '#6366f1',
                            '#8b5cf6',
                            '#10b981',
                            '#f59e0b',
                            '#3b82f6'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 5,
                        hoverBorderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            },
                            onClick: (e, legendItem, legend) => {
                                const chart = legend.chart;
                                const index = legendItem.index;
                                const productType = chart.data.labels[index];
                                openProductDetailModal(productType, index);
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                },
                                afterLabel: function(context) {
                                    return 'Click for detailed breakdown';
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const index = element.index;
                            const productType = charts.productDist.data.labels[index];
                            openProductDetailModal(productType, index);
                        }
                    }
                }
            });
        }

        // Initialize Regional Chart with Click Handling
        function initRegionalChart() {
            const ctx = document.getElementById('regionalChart').getContext('2d');
            charts.regional = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['MENA', 'Asia Pacific', 'Europe', 'Americas', 'Africa'],
                    datasets: [{
                        label: 'Transaction Volume',
                        data: [245, 189, 156, 98, 67],
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        hoverBackgroundColor: 'rgba(99, 102, 241, 0.9)',
                        hoverBorderWidth: 3
                    }, {
                        label: 'Value (Millions USD)',
                        data: [34.5, 28.9, 22.1, 15.6, 8.9],
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: '#8b5cf6',
                        borderWidth: 2,
                        hoverBackgroundColor: 'rgba(139, 92, 246, 0.9)',
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'rect'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function() {
                                    return 'Click for regional breakdown';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const index = element.index;
                            const region = charts.regional.data.labels[index];
                            openRegionalDetailModal(region, index);
                        }
                    }
                }
            });
        }

        // Initialize Bank Distribution Chart with Click Handling
        function initBankDistChart() {
            const ctx = document.getElementById('bankDistChart').getContext('2d');
            charts.bankDist = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['HSBC', 'Standard Chartered', 'Citi', 'JP Morgan', 'Emirates NBD'],
                    datasets: [{
                        label: 'Number of Transactions',
                        data: [87, 76, 65, 54, 43],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: [
                            '#6366f1',
                            '#8b5cf6',
                            '#10b981',
                            '#f59e0b',
                            '#3b82f6'
                        ],
                        hoverBackgroundColor: [
                            'rgba(99, 102, 241, 0.9)',
                            'rgba(139, 92, 246, 0.9)',
                            'rgba(16, 185, 129, 0.9)',
                            'rgba(245, 158, 11, 0.9)',
                            'rgba(59, 130, 246, 0.9)'
                        ]
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function() {
                                    return 'Click for bank details and trends';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const index = element.index;
                            const bank = charts.bankDist.data.labels[index];
                            openBankDetailModal(bank, index);
                        }
                    }
                }
            });
        }

        // Initialize Processing Time Chart
        function initProcessingTimeChart() {
            const ctx = document.getElementById('processingTimeChart').getContext('2d');
            charts.processingTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Import LC', 'Export LC', 'Bank Guarantee', 'SBLC', 'Documentary Collection'],
                    datasets: [{
                        label: 'Average Days',
                        data: [3.2, 2.8, 2.1, 4.5, 1.8],
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.2)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#f093fb',
                        pointBorderWidth: 3
                    }, {
                        label: 'Target Days',
                        data: [3, 3, 2, 4, 2],
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Days'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Initialize Risk Chart
        function initRiskChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            charts.risk = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Credit Risk', 'Country Risk', 'Currency Risk', 'Compliance Risk', 'Operational Risk'],
                    datasets: [{
                        label: 'Current Level',
                        data: [25, 35, 45, 15, 20],
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.2)',
                        pointBackgroundColor: '#f093fb',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#f093fb'
                    }, {
                        label: 'Threshold',
                        data: [50, 50, 50, 50, 50],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        // Initialize Currency Chart with Click Handling
        function initCurrencyChart() {
            const ctx = document.getElementById('currencyChart').getContext('2d');
            charts.currency = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['USD', 'EUR', 'AED', 'GBP', 'JPY', 'Others'],
                    datasets: [{
                        data: [45.2, 22.3, 15.8, 8.7, 5.1, 2.9],
                        backgroundColor: [
                            '#6366f1',
                            '#8b5cf6',
                            '#10b981',
                            '#f59e0b',
                            '#3b82f6',
                            '#ec4899'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 5,
                        hoverBorderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            return {
                                                text: `${label}: ${value}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            },
                            onClick: (e, legendItem, legend) => {
                                const chart = legend.chart;
                                const index = legendItem.index;
                                const currency = chart.data.labels[index];
                                openCurrencyDetailModal(currency, index);
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function() {
                                    return 'Click for currency breakdown and trends';
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const element = elements[0];
                            const index = element.index;
                            const currency = charts.currency.data.labels[index];
                            openCurrencyDetailModal(currency, index);
                        }
                    }
                }
            });
        }

        // Load transaction table with filtered data
        function loadTransactionTable() {
            const tbody = document.getElementById('transactionTableBody');
            tbody.innerHTML = '';

            const transactionsToShow = filteredData.slice(0, 20);
            
            if (transactionsToShow.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="9" style="text-align: center; padding: 20px; color: #64748b;">
                        No transactions found for the selected filters.
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            transactionsToShow.forEach(transaction => {
                const row = document.createElement('tr');
                const statusClass = transaction.status.toLowerCase();
                row.innerHTML = `
                    <td><strong>${transaction.reference}</strong></td>
                    <td>${transaction.date}</td>
                    <td>${transaction.type}</td>
                    <td>${transaction.beneficiary}</td>
                    <td class="amount-cell">${transaction.currency} ${transaction.amount.toLocaleString()}</td>
                    <td>${transaction.currency}</td>
                    <td>${transaction.expiry}</td>
                    <td><span class="status-badge ${statusClass}">${transaction.status}</span></td>
                    <td>${transaction.bank}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Apply filters with automatic refresh
        function applyFilters() {
            // Update current filters
            currentFilters = {
                dateRange: document.getElementById('dateRange').value,
                productType: document.getElementById('productType').value,
                status: document.getElementById('status').value,
                region: document.getElementById('region').value
            };
            
            // Show loading state
            document.getElementById('tableLoader').style.display = 'block';

            // Simulate data loading
            setTimeout(() => {
                // Filter the data
                filterData();
                
                // Update statistics based on filtered data
                updateStatistics();

                // Refresh all charts with filtered data
                updateAllCharts();

                // Reload table with filtered data
                loadTransactionTable();

                // Hide loading state
                document.getElementById('tableLoader').style.display = 'none';
            }, 300);
        }

        // Update statistics based on filtered data
        function updateStatistics() {
            const lcTransactions = filteredData.filter(t => t.type.includes('LC'));
            const bgTransactions = filteredData.filter(t => t.type === 'Bank Guarantee');
            const activeTransactions = filteredData.filter(t => t.status === 'Active');
            
            const totalValue = filteredData.reduce((sum, t) => sum + t.amount, 0) / 1000000;
            const avgProcessing = filteredData.length > 0 ? 
                (Math.random() * 2 + 1.5).toFixed(1) : '0';
            const complianceRate = filteredData.length > 0 ? 
                (95 + Math.random() * 4).toFixed(1) : '100';
            const utilizationRate = filteredData.length > 0 ? 
                (70 + Math.random() * 20).toFixed(1) : '0';

            document.getElementById('totalLCs').textContent = lcTransactions.length;
            document.getElementById('totalValue').textContent = `$${totalValue.toFixed(1)}M`;
            document.getElementById('totalGuarantees').textContent = bgTransactions.length;
            document.getElementById('utilizationRate').textContent = `${utilizationRate}%`;
            document.getElementById('avgProcessing').textContent = `${avgProcessing} days`;
            document.getElementById('complianceRate').textContent = `${complianceRate}%`;
        }

        // Update all charts with filtered data
        function updateAllCharts() {
            updateLCTrendChart();
            updateProductDistChart();
            updateRegionalChart();
            updateBankDistChart();
            updateProcessingTimeChart();
            updateRiskChart();
            updateCurrencyChart();
        }

        // Update LC Trend Chart with filtered data
        function updateLCTrendChart() {
            if (!charts.lcTrend) return;
            
            const { dateRange } = currentFilters;
            const days = dateRange === '1d' ? 1 : dateRange === '7d' ? 7 : dateRange === '30d' ? 30 : 
                        dateRange === '3m' ? 90 : dateRange === '6m' ? 180 : 365;
            
            const labels = [];
            const lcData = [];
            const bgData = [];
            
            for (let i = Math.min(days - 1, 29); i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                labels.push(date.toLocaleDateString('en', { month: 'short', day: 'numeric' }));
                
                const dayLCs = filteredData.filter(t => 
                    t.date === dateStr && t.type.includes('LC')
                ).length;
                const dayBGs = filteredData.filter(t => 
                    t.date === dateStr && t.type === 'Bank Guarantee'
                ).length;
                
                lcData.push(dayLCs);
                bgData.push(dayBGs);
            }
            
            charts.lcTrend.data.labels = labels;
            charts.lcTrend.data.datasets[0].data = lcData;
            charts.lcTrend.data.datasets[1].data = bgData;
            charts.lcTrend.update();
        }

        // Update Product Distribution Chart
        function updateProductDistChart() {
            if (!charts.productDist) return;
            
            const productCounts = {
                'Import LC': 0,
                'Export LC': 0,
                'Bank Guarantee': 0,
                'SBLC': 0,
                'Collection': 0
            };
            
            filteredData.forEach(t => {
                if (productCounts.hasOwnProperty(t.type)) {
                    productCounts[t.type]++;
                }
            });
            
            charts.productDist.data.datasets[0].data = Object.values(productCounts);
            charts.productDist.update();
        }

        // Update Regional Chart
        function updateRegionalChart() {
            if (!charts.regional) return;
            
            const regionCounts = { mena: 0, asia: 0, europe: 0, americas: 0, africa: 0 };
            const regionValues = { mena: 0, asia: 0, europe: 0, americas: 0, africa: 0 };
            
            filteredData.forEach(t => {
                const region = t.region || 'mena';
                if (regionCounts.hasOwnProperty(region)) {
                    regionCounts[region]++;
                    regionValues[region] += t.amount / 1000000;
                }
            });
            
            charts.regional.data.datasets[0].data = [
                regionCounts.mena, regionCounts.asia, regionCounts.europe, 
                regionCounts.americas, regionCounts.africa
            ];
            charts.regional.data.datasets[1].data = [
                regionValues.mena.toFixed(1), regionValues.asia.toFixed(1), 
                regionValues.europe.toFixed(1), regionValues.americas.toFixed(1), 
                regionValues.africa.toFixed(1)
            ];
            charts.regional.update();
        }

        // Update Bank Distribution Chart
        function updateBankDistChart() {
            if (!charts.bankDist) return;
            
            const bankCounts = {};
            filteredData.forEach(t => {
                bankCounts[t.bank] = (bankCounts[t.bank] || 0) + 1;
            });
            
            const sortedBanks = Object.entries(bankCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            charts.bankDist.data.labels = sortedBanks.map(([bank]) => bank);
            charts.bankDist.data.datasets[0].data = sortedBanks.map(([,count]) => count);
            charts.bankDist.update();
        }

        // Update Processing Time Chart
        function updateProcessingTimeChart() {
            if (!charts.processingTime) return;
            
            const productTypes = ['Import LC', 'Export LC', 'Bank Guarantee', 'SBLC', 'Collection'];
            const processingTimes = productTypes.map(() => (Math.random() * 3 + 1).toFixed(1));
            const targetTimes = [3, 3, 2, 4, 2];
            
            charts.processingTime.data.datasets[0].data = processingTimes;
            charts.processingTime.data.datasets[1].data = targetTimes;
            charts.processingTime.update();
        }

        // Update Risk Chart
        function updateRiskChart() {
            if (!charts.risk) return;
            
            const riskLevels = [
                Math.random() * 40 + 10,
                Math.random() * 40 + 10, 
                Math.random() * 40 + 10,
                Math.random() * 30 + 5,
                Math.random() * 30 + 10
            ];
            
            charts.risk.data.datasets[0].data = riskLevels;
            charts.risk.update();
        }

        // Update Currency Chart
        function updateCurrencyChart() {
            if (!charts.currency) return;
            
            const currencyCounts = {};
            filteredData.forEach(t => {
                currencyCounts[t.currency] = (currencyCounts[t.currency] || 0) + 1;
            });
            
            const total = filteredData.length;
            const currencyPercentages = {};
            
            Object.entries(currencyCounts).forEach(([currency, count]) => {
                currencyPercentages[currency] = ((count / total) * 100).toFixed(1);
            });
            
            const currencies = ['USD', 'EUR', 'AED', 'GBP', 'JPY', 'Others'];
            const percentages = currencies.map(curr => {
                if (curr === 'Others') {
                    const mainCurrencies = ['USD', 'EUR', 'AED', 'GBP', 'JPY'];
                    const othersTotal = Object.entries(currencyPercentages)
                        .filter(([c]) => !mainCurrencies.includes(c))
                        .reduce((sum, [,p]) => sum + parseFloat(p), 0);
                    return othersTotal.toFixed(1);
                }
                return currencyPercentages[curr] || '0';
            });
            
            charts.currency.data.datasets[0].data = percentages;
            charts.currency.update();
        }

        // Export functions
        function exportChart(chartName) {
            const chart = charts[chartName];
            if (chart) {
                const url = chart.toBase64Image();
                const link = document.createElement('a');
                link.download = `${chartName}_chart.png`;
                link.href = url;
                link.click();
            }
        }

        function exportTableData() {
            // Export filtered data as CSV
            const headers = ['Reference', 'Date', 'Type', 'Beneficiary', 'Amount', 'Currency', 'Expiry', 'Status', 'Bank'];
            let csv = [headers.join(',')];
            
            filteredData.forEach(transaction => {
                const row = [
                    transaction.reference,
                    transaction.date,
                    transaction.type,
                    transaction.beneficiary,
                    transaction.amount,
                    transaction.currency,
                    transaction.expiry,
                    transaction.status,
                    transaction.bank
                ];
                csv.push(row.join(','));
            });

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trade_finance_filtered_data_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function refreshTable() {
            applyFilters();
        }
        
        // Enhanced helper functions for chart interactions
        function showDetails(type) {
            if (type === 'banks') {
                // Show aggregated bank performance
                const modal = document.getElementById('chartModal');
                const title = document.getElementById('modalTitle');
                const breadcrumb = document.getElementById('modalBreadcrumb');
                const details = document.getElementById('modalDetails');
                
                title.textContent = 'All Banks - Performance Overview';
                
                breadcrumb.innerHTML = `
                    <span class="breadcrumb-item" onclick="closeChartModal()">Analytics</span>
                    <span class="breadcrumb-separator"></span>
                    <span style="color: #1e293b; font-weight: 600;">Bank Performance Details</span>
                `;
                
                const bankStats = {};
                filteredData.forEach(t => {
                    if (!bankStats[t.bank]) {
                        bankStats[t.bank] = { count: 0, value: 0, products: new Set() };
                    }
                    bankStats[t.bank].count++;
                    bankStats[t.bank].value += t.amount;
                    bankStats[t.bank].products.add(t.type);
                });
                
                const sortedBanks = Object.entries(bankStats)
                    .sort(([,a], [,b]) => b.count - a.count)
                    .slice(0, 10);
                
                details.innerHTML = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f1f5f9;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0;">Bank</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">Transactions</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">Value (M)</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">Products</th>
                                    <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e2e8f0;">Avg Deal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedBanks.map(([bank, stats]) => `
                                    <tr style="cursor: pointer;" onclick="openBankDetailModal('${bank}', 0)">
                                        <td style="padding: 8px; border-bottom: 1px solid #f1f5f9; font-weight: 600; color: #1e293b;">${bank}</td>
                                        <td style="padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">${stats.count}</td>
                                        <td style="padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: right; color: #10b981;">$${(stats.value/1000000).toFixed(1)}M</td>
                                        <td style="padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">${stats.products.size}</td>
                                        <td style="padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: right;">$${((stats.value/stats.count)/1000).toFixed(0)}K</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Create overview chart
                createBankOverviewChart();
                modal.classList.add('active');
            }
        }
        
        function showRiskDetails() {
            const modal = document.getElementById('chartModal');
            const title = document.getElementById('modalTitle');
            const breadcrumb = document.getElementById('modalBreadcrumb');
            const details = document.getElementById('modalDetails');
            
            title.textContent = 'Risk Assessment Matrix - Detailed Analysis';
            
            breadcrumb.innerHTML = `
                <span class="breadcrumb-item" onclick="closeChartModal()">Analytics</span>
                <span class="breadcrumb-separator"></span>
                <span style="color: #1e293b; font-weight: 600;">Risk Assessment Details</span>
            `;
            
            // Calculate risk metrics based on filtered data
            const riskMetrics = {
                'Credit Risk': {
                    value: Math.min(50, (filteredData.filter(t => ['Expired', 'Pending'].includes(t.status)).length / filteredData.length * 100)),
                    description: 'Risk of counterparty default based on transaction status',
                    factors: ['Transaction status distribution', 'Historical default rates', 'Credit ratings']
                },
                'Country Risk': {
                    value: Math.min(60, Object.keys(bankRegions).length * 8),
                    description: 'Geopolitical and economic risks by region',
                    factors: ['Regional diversification', 'Political stability', 'Economic indicators']
                },
                'Currency Risk': {
                    value: Math.min(70, (filteredData.filter(t => t.currency !== 'USD').length / filteredData.length * 60)),
                    description: 'Foreign exchange risk exposure',
                    factors: ['Currency diversification', 'Volatility measures', 'Hedging strategies']
                },
                'Compliance Risk': {
                    value: Math.max(5, Math.min(30, Math.random() * 25 + 5)),
                    description: 'Regulatory and compliance adherence risk',
                    factors: ['Regulatory changes', 'Documentation completeness', 'Audit findings']
                },
                'Operational Risk': {
                    value: Math.max(10, Math.min(40, Math.random() * 30 + 10)),
                    description: 'Process and system failure risks',
                    factors: ['System uptime', 'Process efficiency', 'Human error rates']
                }
            };
            
            details.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; max-height: 400px; overflow-y: auto;">
                    ${Object.entries(riskMetrics).map(([risk, data]) => `
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                <h4 style="margin: 0; color: #1e293b;">${risk}</h4>
                                <span style="font-size: 24px; font-weight: 700; color: ${data.value > 40 ? '#ef4444' : data.value > 25 ? '#f59e0b' : '#10b981'};">%${data.value.toFixed(1)}</span>
                            </div>
                            <p style="margin: 0 0 10px 0; font-size: 13px; color: #64748b;">${data.description}</p>
                            <div style="background: #f8fafc; padding: 8px; border-radius: 4px;">
                                <strong style="font-size: 12px; color: #374151;">Key Factors:</strong>
                                <ul style="margin: 5px 0 0 15px; font-size: 12px; color: #64748b;">
                                    ${data.factors.map(factor => `<li>${factor}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            createRiskDetailChart(riskMetrics);
            modal.classList.add('active');
        }
        
        function createBankOverviewChart() {
            const ctx = document.getElementById('modalChart').getContext('2d');
            
            if (modalChart) {
                modalChart.destroy();
            }
            
            const bankData = {};
            filteredData.forEach(t => {
                if (!bankData[t.bank]) bankData[t.bank] = 0;
                bankData[t.bank] += t.amount;
            });
            
            const sortedBanks = Object.entries(bankData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);
            
            modalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedBanks.map(([bank]) => bank),
                    datasets: [{
                        data: sortedBanks.map(([,value]) => value / 1000000),
                        backgroundColor: [
                            '#6366f1', '#8b5cf6', '#10b981', '#f59e0b',
                            '#3b82f6', '#ec4899', '#14b8a6', '#f97316'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Bank Performance by Total Value'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function createRiskDetailChart(riskMetrics) {
            const ctx = document.getElementById('modalChart').getContext('2d');
            
            if (modalChart) {
                modalChart.destroy();
            }
            
            const riskNames = Object.keys(riskMetrics);
            const riskValues = Object.values(riskMetrics).map(r => r.value);
            const thresholds = [50, 50, 50, 50, 50]; // Red line thresholds
            
            modalChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: riskNames,
                    datasets: [{
                        label: 'Current Risk Level',
                        data: riskValues,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 6
                    }, {
                        label: 'Risk Threshold',
                        data: thresholds,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Risk Assessment Radar Chart'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });
        }
        
        function toggleCurrencyView() {
            // Toggle between percentage and absolute values in currency chart
            if (charts.currency) {
                const currentData = charts.currency.data.datasets[0].data;
                const isPercentage = charts.currency.options.plugins.tooltip.callbacks.label.toString().includes('%');
                
                if (isPercentage) {
                    // Switch to absolute values
                    const currencyTotals = {};
                    filteredData.forEach(t => {
                        currencyTotals[t.currency] = (currencyTotals[t.currency] || 0) + 1;
                    });
                    
                    const currencies = ['USD', 'EUR', 'AED', 'GBP', 'JPY', 'Others'];
                    const absoluteValues = currencies.map(curr => {
                        if (curr === 'Others') {
                            const mainCurrencies = ['USD', 'EUR', 'AED', 'GBP', 'JPY'];
                            return Object.entries(currencyTotals)
                                .filter(([c]) => !mainCurrencies.includes(c))
                                .reduce((sum, [,count]) => sum + count, 0);
                        }
                        return currencyTotals[curr] || 0;
                    });
                    
                    charts.currency.data.datasets[0].data = absoluteValues;
                } else {
                    // Switch back to percentages
                    updateCurrencyChart();
                }
                
                charts.currency.update();
            }
        }
        
        // ============== NESTED CHART HELPER FUNCTIONS ==============
        
        // Setup hover effects for nested charts
        function setupNestedChartHovers() {
            const nestedContainers = document.querySelectorAll('.nested-chart-container');
            
            nestedContainers.forEach((container, index) => {
                const overlay = container.querySelector('.chart-overlay');
                
                if (overlay) {
                    container.addEventListener('mouseenter', () => {
                        overlay.classList.add('hover');
                    });
                    
                    container.addEventListener('mouseleave', () => {
                        overlay.classList.remove('hover');
                    });
                }
            });
        }
        
        // Enhanced keyboard navigation for nested charts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeChartModal();
                return;
            }
            
            if (chartDrillDown.active && document.getElementById('chartModal').classList.contains('active')) {
                switch(event.key) {
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                        event.preventDefault();
                        const chartIndex = parseInt(event.key);
                        if (nestedCharts[chartIndex]) {
                            expandNestedChart(chartIndex);
                        }
                        break;
                        
                    case 's':
                    case 'S':
                        event.preventDefault();
                        showChartView('single');
                        break;
                        
                    case 'p':
                    case 'P':
                        event.preventDefault();
                        showChartView('split');
                        break;
                        
                    case 'n':
                    case 'N':
                        event.preventDefault();
                        showChartView('nested');
                        break;
                        
                    case 'ArrowLeft':
                        // Navigate back in drill-down
                        if (chartDrillDown.level > 0) {
                            event.preventDefault();
                            chartDrillDown.level--;
                            chartDrillDown.breadcrumb.pop();
                            createNestedCharts();
                        }
                        break;
                }
            }
        });
        
        function refreshChart(chartType) {
            applyFilters();
        }

        // ============== MODAL AND INTERACTIVE CHART FUNCTIONS ==============

        // Open Product Detail Modal with Nested Chart Support
        function openProductDetailModal(productType, index) {
            const modal = document.getElementById('chartModal');
            const title = document.getElementById('modalTitle');
            const breadcrumb = document.getElementById('modalBreadcrumb');
            const details = document.getElementById('modalDetails');
            
            title.textContent = `${productType} - Multi-Level Analysis`;
            
            // Set breadcrumb
            breadcrumb.innerHTML = `
                <span class="breadcrumb-item" onclick="closeChartModal()">Analytics</span>
                <span class="breadcrumb-separator"></span>
                <span class="breadcrumb-item">Product Distribution</span>
                <span class="breadcrumb-separator"></span>
                <span style="color: #1e293b; font-weight: 600;">${productType}</span>
            `;
            
            // Filter data for this product type
            const productData = filteredData.filter(t => t.type === productType);
            
            // Store selected data for nested analysis
            chartDrillDown.selectedData = {
                type: 'product',
                data: productData,
                label: productType
            };
            const totalValue = productData.reduce((sum, t) => sum + t.amount, 0);
            const avgAmount = productData.length > 0 ? totalValue / productData.length : 0;
            
            // Status breakdown
            const statusBreakdown = {};
            productData.forEach(t => {
                statusBreakdown[t.status] = (statusBreakdown[t.status] || 0) + 1;
            });
            
            // Region breakdown
            const regionBreakdown = {};
            productData.forEach(t => {
                regionBreakdown[t.region] = (regionBreakdown[t.region] || 0) + 1;
            });
            
            // Currency breakdown
            const currencyBreakdown = {};
            productData.forEach(t => {
                currencyBreakdown[t.currency] = (currencyBreakdown[t.currency] || 0) + 1;
            });
            
            // Create details
            details.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="detail-item">
                        <span class="detail-label">Total Transactions:</span>
                        <span class="detail-value">${productData.length}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Value:</span>
                        <span class="detail-value">$${(totalValue/1000000).toFixed(1)}M</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Average Amount:</span>
                        <span class="detail-value">$${(avgAmount/1000).toFixed(0)}K</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Market Share:</span>
                        <span class="detail-value">${((productData.length/filteredData.length)*100).toFixed(1)}%</span>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">By Status</h4>
                        ${Object.entries(statusBreakdown).map(([status, count]) => 
                            `<div class="detail-item"><span>${status}:</span><span>${count}</span></div>`
                        ).join('')}
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">By Region</h4>
                        ${Object.entries(regionBreakdown).map(([region, count]) => 
                            `<div class="detail-item"><span>${region.toUpperCase()}:</span><span>${count}</span></div>`
                        ).join('')}
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">By Currency</h4>
                        ${Object.entries(currencyBreakdown).map(([currency, count]) => 
                            `<div class="detail-item"><span>${currency}:</span><span>${count}</span></div>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            // Create detailed chart showing trends
            createProductTrendChart(productType, productData);
            
            // Enable drill-down indicator
            document.getElementById('drillIndicator').style.display = 'block';
            
            // Set up nested view if needed
            if (chartDrillDown.currentView === 'nested') {
                setTimeout(() => createNestedCharts(), 100);
            }
            
            modal.classList.add('active');
        }

        // Open Regional Detail Modal with Nested Chart Support
        function openRegionalDetailModal(region, index) {
            const modal = document.getElementById('chartModal');
            const title = document.getElementById('modalTitle');
            const breadcrumb = document.getElementById('modalBreadcrumb');
            const details = document.getElementById('modalDetails');
            
            title.textContent = `${region} - Multi-Dimensional Regional Analysis`;
            
            breadcrumb.innerHTML = `
                <span class="breadcrumb-item" onclick="closeChartModal()">Analytics</span>
                <span class="breadcrumb-separator"></span>
                <span class="breadcrumb-item">Regional Performance</span>
                <span class="breadcrumb-separator"></span>
                <span style="color: #1e293b; font-weight: 600;">${region}</span>
            `;
            
            const regionKey = region.toLowerCase().replace(' ', '').replace('pacific', '');
            const regionData = filteredData.filter(t => t.region === regionKey);
            
            // Store selected data for nested analysis
            chartDrillDown.selectedData = {
                type: 'region',
                data: regionData,
                label: region
            };
            const totalValue = regionData.reduce((sum, t) => sum + t.amount, 0);
            
            // Product breakdown for this region
            const productBreakdown = {};
            regionData.forEach(t => {
                productBreakdown[t.type] = (productBreakdown[t.type] || 0) + 1;
            });
            
            // Bank breakdown for this region
            const bankBreakdown = {};
            regionData.forEach(t => {
                bankBreakdown[t.bank] = (bankBreakdown[t.bank] || 0) + 1;
            });
            
            details.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="detail-item">
                        <span class="detail-label">Total Transactions:</span>
                        <span class="detail-value">${regionData.length}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Value:</span>
                        <span class="detail-value">$${(totalValue/1000000).toFixed(1)}M</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Market Share:</span>
                        <span class="detail-value">${((regionData.length/filteredData.length)*100).toFixed(1)}%</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Avg Deal Size:</span>
                        <span class="detail-value">$${((totalValue/regionData.length)/1000).toFixed(0)}K</span>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Top Products</h4>
                        ${Object.entries(productBreakdown)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5)
                            .map(([product, count]) => 
                                `<div class="detail-item"><span>${product}:</span><span>${count}</span></div>`
                            ).join('')}
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Top Banks</h4>
                        ${Object.entries(bankBreakdown)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5)
                            .map(([bank, count]) => 
                                `<div class="detail-item"><span>${bank}:</span><span>${count}</span></div>`
                            ).join('')}
                    </div>
                </div>
            `;
            
            createRegionalTrendChart(region, regionData);
            
            // Enable drill-down features
            document.getElementById('drillIndicator').style.display = 'block';
            
            // Set up nested view if needed
            if (chartDrillDown.currentView === 'nested') {
                setTimeout(() => createNestedCharts(), 100);
            }
            
            modal.classList.add('active');
        }

        // Open Bank Detail Modal with Nested Chart Support
        function openBankDetailModal(bank, index) {
            const modal = document.getElementById('chartModal');
            const title = document.getElementById('modalTitle');
            const breadcrumb = document.getElementById('modalBreadcrumb');
            const details = document.getElementById('modalDetails');
            
            title.textContent = `${bank} - Comprehensive Bank Analysis`;
            
            breadcrumb.innerHTML = `
                <span class="breadcrumb-item" onclick="closeChartModal()">Analytics</span>
                <span class="breadcrumb-separator"></span>
                <span class="breadcrumb-item">Bank Distribution</span>
                <span class="breadcrumb-separator"></span>
                <span style="color: #1e293b; font-weight: 600;">${bank}</span>
            `;
            
            const bankData = filteredData.filter(t => t.bank === bank);
            
            // Store selected data for nested analysis
            chartDrillDown.selectedData = {
                type: 'bank',
                data: bankData,
                label: bank
            };
            const totalValue = bankData.reduce((sum, t) => sum + t.amount, 0);
            
            // Product breakdown for this bank
            const productBreakdown = {};
            bankData.forEach(t => {
                productBreakdown[t.type] = (productBreakdown[t.type] || 0) + 1;
            });
            
            // Status breakdown
            const statusBreakdown = {};
            bankData.forEach(t => {
                statusBreakdown[t.status] = (statusBreakdown[t.status] || 0) + 1;
            });
            
            details.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="detail-item">
                        <span class="detail-label">Total Transactions:</span>
                        <span class="detail-value">${bankData.length}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Value:</span>
                        <span class="detail-value">$${(totalValue/1000000).toFixed(1)}M</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Market Share:</span>
                        <span class="detail-value">${((bankData.length/filteredData.length)*100).toFixed(1)}%</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Success Rate:</span>
                        <span class="detail-value">${(((statusBreakdown.Completed || 0)/bankData.length)*100).toFixed(1)}%</span>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Product Portfolio</h4>
                        ${Object.entries(productBreakdown)
                            .sort(([,a], [,b]) => b - a)
                            .map(([product, count]) => 
                                `<div class="detail-item"><span>${product}:</span><span>${count}</span></div>`
                            ).join('')}
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Transaction Status</h4>
                        ${Object.entries(statusBreakdown)
                            .map(([status, count]) => 
                                `<div class="detail-item"><span>${status}:</span><span>${count}</span></div>`
                            ).join('')}
                    </div>
                </div>
            `;
            
            createBankTrendChart(bank, bankData);
            
            // Enable nested chart features
            document.getElementById('drillIndicator').style.display = 'block';
            
            // Set up nested view if needed
            if (chartDrillDown.currentView === 'nested') {
                setTimeout(() => createNestedCharts(), 100);
            }
            
            modal.classList.add('active');
        }

        // Open Currency Detail Modal with Nested Chart Support
        function openCurrencyDetailModal(currency, index) {
            const modal = document.getElementById('chartModal');
            const title = document.getElementById('modalTitle');
            const breadcrumb = document.getElementById('modalBreadcrumb');
            const details = document.getElementById('modalDetails');
            
            title.textContent = `${currency} - Multi-Faceted Currency Analysis`;
            
            breadcrumb.innerHTML = `
                <span class="breadcrumb-item" onclick="closeChartModal()">Analytics</span>
                <span class="breadcrumb-separator"></span>
                <span class="breadcrumb-item">Currency Distribution</span>
                <span class="breadcrumb-separator"></span>
                <span style="color: #1e293b; font-weight: 600;">${currency}</span>
            `;
            
            const currencyData = currency === 'Others' ? 
                filteredData.filter(t => !['USD', 'EUR', 'AED', 'GBP', 'JPY'].includes(t.currency)) :
                filteredData.filter(t => t.currency === currency);
                
            // Store selected data for nested analysis
            chartDrillDown.selectedData = {
                type: 'currency',
                data: currencyData,
                label: currency
            };
            
            const totalValue = currencyData.reduce((sum, t) => sum + t.amount, 0);
            
            // Product breakdown
            const productBreakdown = {};
            currencyData.forEach(t => {
                productBreakdown[t.type] = (productBreakdown[t.type] || 0) + 1;
            });
            
            // Region breakdown
            const regionBreakdown = {};
            currencyData.forEach(t => {
                regionBreakdown[t.region] = (regionBreakdown[t.region] || 0) + 1;
            });
            
            details.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="detail-item">
                        <span class="detail-label">Total Transactions:</span>
                        <span class="detail-value">${currencyData.length}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Value:</span>
                        <span class="detail-value">${currency} ${(totalValue/1000000).toFixed(1)}M</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Market Share:</span>
                        <span class="detail-value">${((currencyData.length/filteredData.length)*100).toFixed(1)}%</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Avg Deal Size:</span>
                        <span class="detail-value">${currency} ${((totalValue/currencyData.length)/1000).toFixed(0)}K</span>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Product Breakdown</h4>
                        ${Object.entries(productBreakdown)
                            .sort(([,a], [,b]) => b - a)
                            .map(([product, count]) => 
                                `<div class="detail-item"><span>${product}:</span><span>${count}</span></div>`
                            ).join('')}
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #374151;">Regional Usage</h4>
                        ${Object.entries(regionBreakdown)
                            .sort(([,a], [,b]) => b - a)
                            .map(([region, count]) => 
                                `<div class="detail-item"><span>${region.toUpperCase()}:</span><span>${count}</span></div>`
                            ).join('')}
                    </div>
                </div>
            `;
            
            createCurrencyTrendChart(currency, currencyData);
            
            // Enable interactive features
            document.getElementById('drillIndicator').style.display = 'block';
            
            // Set up nested view if needed
            if (chartDrillDown.currentView === 'nested') {
                setTimeout(() => createNestedCharts(), 100);
            }
            
            modal.classList.add('active');
        }

        // Create Product Trend Chart
        function createProductTrendChart(productType, data) {
            const ctx = document.getElementById('modalChart').getContext('2d');
            
            if (modalChart) {
                modalChart.destroy();
            }
            
            // Group data by month
            const monthlyData = {};
            data.forEach(t => {
                const month = t.date.substring(0, 7); // YYYY-MM
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const counts = sortedMonths.map(month => monthlyData[month]);
            const labels = sortedMonths.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en', { month: 'short', year: '2-digit' });
            });
            
            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${productType} Volume`,
                        data: counts,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${productType} - Monthly Trend Analysis`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Transactions'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        // Create Regional Trend Chart
        function createRegionalTrendChart(region, data) {
            const ctx = document.getElementById('modalChart').getContext('2d');
            
            if (modalChart) {
                modalChart.destroy();
            }
            
            // Product breakdown over time
            const productTypes = [...new Set(data.map(t => t.type))];
            const months = [...new Set(data.map(t => t.date.substring(0, 7)))].sort();
            
            const datasets = productTypes.map((product, index) => {
                const productData = months.map(month => {
                    return data.filter(t => t.date.startsWith(month) && t.type === product).length;
                });
                
                const colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#3b82f6'];
                
                return {
                    label: product,
                    data: productData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    fill: false
                };
            });
            
            const labels = months.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en', { month: 'short', year: '2-digit' });
            });
            
            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${region} - Product Distribution Over Time`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Transactions'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        // Create Bank Trend Chart
        function createBankTrendChart(bank, data) {
            const ctx = document.getElementById('modalChart').getContext('2d');
            
            if (modalChart) {
                modalChart.destroy();
            }
            
            // Monthly value trends
            const monthlyValue = {};
            const monthlyCount = {};
            
            data.forEach(t => {
                const month = t.date.substring(0, 7);
                monthlyValue[month] = (monthlyValue[month] || 0) + t.amount;
                monthlyCount[month] = (monthlyCount[month] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyValue).sort();
            const values = sortedMonths.map(month => monthlyValue[month] / 1000000);
            const counts = sortedMonths.map(month => monthlyCount[month]);
            const labels = sortedMonths.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en', { month: 'short', year: '2-digit' });
            });
            
            modalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Transaction Value (Millions)',
                        data: values,
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Transaction Count',
                        data: counts,
                        type: 'line',
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${bank} - Monthly Performance Analysis`
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Value (Millions USD)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Transaction Count'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        // Create Currency Trend Chart
        function createCurrencyTrendChart(currency, data) {
            const ctx = document.getElementById('modalChart').getContext('2d');
            
            if (modalChart) {
                modalChart.destroy();
            }
            
            // Monthly trends with value
            const monthlyData = {};
            data.forEach(t => {
                const month = t.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { count: 0, value: 0 };
                }
                monthlyData[month].count++;
                monthlyData[month].value += t.amount;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const counts = sortedMonths.map(month => monthlyData[month].count);
            const values = sortedMonths.map(month => monthlyData[month].value / 1000000);
            const labels = sortedMonths.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en', { month: 'short', year: '2-digit' });
            });
            
            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Transaction Count',
                        data: counts,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Total Value (Millions)',
                        data: values,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${currency} - Transaction Trends Analysis`
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Transaction Count'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Value (Millions)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        // Close Chart Modal
        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.remove('active');
            
            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
            
            if (secondaryChart) {
                secondaryChart.destroy();
                secondaryChart = null;
            }
            
            // Destroy nested charts
            Object.values(nestedCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            nestedCharts = {};
            
            // Reset drill-down state
            chartDrillDown = {
                active: false,
                parentChart: null,
                breadcrumb: [],
                level: 0,
                currentView: 'single',
                selectedData: null
            };
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('chartModal');
            if (event.target === modal) {
                closeChartModal();
            }
        });

        // Escape key functionality is handled in the enhanced keyboard navigation above

        // ============== NESTED CHART AND MULTI-VIEW FUNCTIONS ==============

        // Show different chart view modes
        function showChartView(viewType) {
            const secondaryContainer = document.getElementById('secondaryChartContainer');
            const nestedGrid = document.getElementById('nestedChartsGrid');
            const primaryArea = document.getElementById('primaryChartArea');
            const navButtons = document.querySelectorAll('.chart-nav-btn');
            
            // Update active button
            navButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            chartDrillDown.currentView = viewType;
            
            switch(viewType) {
                case 'single':
                    secondaryContainer.classList.remove('active');
                    nestedGrid.style.display = 'none';
                    primaryArea.style.height = '400px';
                    break;
                    
                case 'split':
                    secondaryContainer.classList.add('active');
                    nestedGrid.style.display = 'none';
                    primaryArea.style.height = '300px';
                    
                    // Create secondary chart based on current selection
                    if (chartDrillDown.selectedData) {
                        createSecondaryChart('trend');
                    }
                    break;
                    
                case 'nested':
                    secondaryContainer.classList.remove('active');
                    nestedGrid.style.display = 'grid';
                    primaryArea.style.height = '200px';
                    
                    // Create multiple nested charts
                    createNestedCharts();
                    break;
            }
        }

        // Switch secondary chart type
        function switchSecondaryChart(chartType) {
            const buttons = document.querySelectorAll('#secondaryChartContainer .chart-nav-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            createSecondaryChart(chartType);
        }

        // Create secondary chart
        function createSecondaryChart(chartType) {
            if (!chartDrillDown.selectedData) return;
            
            const ctx = document.getElementById('secondaryChart').getContext('2d');
            const titleElement = document.getElementById('secondaryChartTitle');
            
            if (secondaryChart) {
                secondaryChart.destroy();
            }
            
            const { type, data, label } = chartDrillDown.selectedData;
            
            switch(chartType) {
                case 'trend':
                    titleElement.textContent = `${label} - Trend Analysis`;
                    secondaryChart = createTrendChart(ctx, data, label);
                    break;
                    
                case 'breakdown':
                    titleElement.textContent = `${label} - Detailed Breakdown`;
                    secondaryChart = createBreakdownChart(ctx, data, label);
                    break;
                    
                case 'comparison':
                    titleElement.textContent = `${label} - Comparative Analysis`;
                    secondaryChart = createComparisonChart(ctx, data, label);
                    break;
            }
        }

        // Create nested charts for comprehensive analysis
        function createNestedCharts() {
            if (!chartDrillDown.selectedData) return;
            
            const { data, label, type } = chartDrillDown.selectedData;
            
            // Chart 1: Time series
            createNestedTimeSeriesChart(1, data, `${label} - Volume Over Time`);
            
            // Chart 2: Status breakdown
            createNestedStatusChart(2, data, `${label} - Status Distribution`);
            
            // Chart 3: Regional breakdown
            createNestedRegionalChart(3, data, `${label} - Regional Analysis`);
            
            // Chart 4: Currency breakdown
            createNestedCurrencyChart(4, data, `${label} - Currency Mix`);
        }

        // Create nested time series chart
        function createNestedTimeSeriesChart(index, data, title) {
            const canvas = document.getElementById(`nestedChart${index}`);
            const ctx = canvas.getContext('2d');
            
            // Update title
            const titleElement = canvas.parentElement.querySelector('h5');
            titleElement.textContent = title;
            
            if (nestedCharts[index]) {
                nestedCharts[index].destroy();
            }
            
            // Group by month
            const monthlyData = {};
            data.forEach(t => {
                const month = t.date.substring(0, 7);
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const counts = sortedMonths.map(month => monthlyData[month]);
            const labels = sortedMonths.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en', { month: 'short' });
            });
            
            nestedCharts[index] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, display: false },
                        x: { display: true }
                    },
                    onClick: () => expandNestedChart(index)
                }
            });
        }

        // Create nested status chart
        function createNestedStatusChart(index, data, title) {
            const canvas = document.getElementById(`nestedChart${index}`);
            const ctx = canvas.getContext('2d');
            
            const titleElement = canvas.parentElement.querySelector('h5');
            titleElement.textContent = title;
            
            if (nestedCharts[index]) {
                nestedCharts[index].destroy();
            }
            
            const statusCount = {};
            data.forEach(t => {
                statusCount[t.status] = (statusCount[t.status] || 0) + 1;
            });
            
            nestedCharts[index] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCount),
                    datasets: [{
                        data: Object.values(statusCount),
                        backgroundColor: ['#10b981', '#f59e0b', '#6366f1', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    onClick: () => expandNestedChart(index)
                }
            });
        }

        // Create nested regional chart
        function createNestedRegionalChart(index, data, title) {
            const canvas = document.getElementById(`nestedChart${index}`);
            const ctx = canvas.getContext('2d');
            
            const titleElement = canvas.parentElement.querySelector('h5');
            titleElement.textContent = title;
            
            if (nestedCharts[index]) {
                nestedCharts[index].destroy();
            }
            
            const regionCount = {};
            data.forEach(t => {
                regionCount[t.region] = (regionCount[t.region] || 0) + 1;
            });
            
            nestedCharts[index] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(regionCount),
                    datasets: [{
                        data: Object.values(regionCount),
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, display: false },
                        x: { display: true }
                    },
                    onClick: () => expandNestedChart(index)
                }
            });
        }

        // Create nested currency chart
        function createNestedCurrencyChart(index, data, title) {
            const canvas = document.getElementById(`nestedChart${index}`);
            const ctx = canvas.getContext('2d');
            
            const titleElement = canvas.parentElement.querySelector('h5');
            titleElement.textContent = title;
            
            if (nestedCharts[index]) {
                nestedCharts[index].destroy();
            }
            
            const currencyCount = {};
            data.forEach(t => {
                currencyCount[t.currency] = (currencyCount[t.currency] || 0) + 1;
            });
            
            const sortedCurrencies = Object.entries(currencyCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            nestedCharts[index] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: sortedCurrencies.map(([curr]) => curr),
                    datasets: [{
                        data: sortedCurrencies.map(([,count]) => count),
                        backgroundColor: ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#3b82f6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    onClick: () => expandNestedChart(index)
                }
            });
        }

        // Expand nested chart to full view
        function expandNestedChart(index) {
            // Switch to single view and show the selected nested chart in main area
            showChartView('single');
            
            // Copy the nested chart to main chart
            const nestedChart = nestedCharts[index];
            if (nestedChart && modalChart) {
                modalChart.destroy();
                modalChart = Chart.getChart(document.getElementById('modalChart'));
                
                // Create expanded version of the nested chart
                const ctx = document.getElementById('modalChart').getContext('2d');
                modalChart = new Chart(ctx, {
                    type: nestedChart.config.type,
                    data: JSON.parse(JSON.stringify(nestedChart.data)),
                    options: {
                        ...nestedChart.config.options,
                        plugins: {
                            ...nestedChart.config.options.plugins,
                            legend: { display: true, position: 'bottom' },
                            title: {
                                display: true,
                                text: `Expanded: ${nestedChart.canvas.parentElement.querySelector('h5').textContent}`
                            }
                        },
                        scales: {
                            ...nestedChart.config.options.scales,
                            y: { ...nestedChart.config.options.scales?.y, display: true },
                            x: { ...nestedChart.config.options.scales?.x, display: true }
                        }
                    }
                });
            }
            
            // Update primary chart title
            document.getElementById('primaryChartTitle').textContent = `Expanded Analysis`;
        }

        // Helper functions for secondary charts
        function createTrendChart(ctx, data, label) {
            const monthlyValue = {};
            data.forEach(t => {
                const month = t.date.substring(0, 7);
                monthlyValue[month] = (monthlyValue[month] || 0) + t.amount;
            });
            
            const sortedMonths = Object.keys(monthlyValue).sort();
            const values = sortedMonths.map(month => monthlyValue[month] / 1000000);
            const labels = sortedMonths.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en', { month: 'short', year: '2-digit' });
            });
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Value (Millions)',
                        data: values,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createBreakdownChart(ctx, data, label) {
            const productCount = {};
            data.forEach(t => {
                productCount[t.type] = (productCount[t.type] || 0) + 1;
            });
            
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(productCount),
                    datasets: [{
                        data: Object.values(productCount),
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: '#f59e0b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createComparisonChart(ctx, data, label) {
            // Compare current selection vs overall data
            const selectionStats = {
                avgAmount: data.reduce((sum, t) => sum + t.amount, 0) / data.length,
                totalCount: data.length,
                completionRate: (data.filter(t => t.status === 'Completed').length / data.length) * 100
            };
            
            const overallStats = {
                avgAmount: filteredData.reduce((sum, t) => sum + t.amount, 0) / filteredData.length,
                totalCount: filteredData.length,
                completionRate: (filteredData.filter(t => t.status === 'Completed').length / filteredData.length) * 100
            };
            
            return new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Avg Amount', 'Volume', 'Success Rate'],
                    datasets: [{
                        label: label,
                        data: [
                            (selectionStats.avgAmount / 1000000),
                            (selectionStats.totalCount / 10),
                            selectionStats.completionRate
                        ],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        pointBackgroundColor: '#6366f1'
                    }, {
                        label: 'Overall Average',
                        data: [
                            (overallStats.avgAmount / 1000000),
                            (overallStats.totalCount / 10),
                            overallStats.completionRate
                        ],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        pointBackgroundColor: '#ef4444',
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Generate all transaction data
            allTransactions = generateRealisticData();
            
            // Set initial filters and filter data
            filterData();
            
            // Initialize all charts
            initLCTrendChart();
            initProductDistChart();
            initRegionalChart();
            initBankDistChart();
            initProcessingTimeChart();
            initRiskChart();
            initCurrencyChart();

            // Load initial data
            updateStatistics();
            updateAllCharts();
            loadTransactionTable();

            // Set up auto-refresh every 30 seconds (optional)
            setInterval(() => {
                // Only refresh if no user interaction in last 10 seconds
                applyFilters();
            }, 60000);
        });

        // Chart interaction functions
        function changeChartPeriod(chartName, period) {
            // Update button states
            const buttons = event.target.parentElement.querySelectorAll('.chart-action-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update chart data based on period
            const chart = charts[chartName];
            if (chart) {
                // Generate new data based on period
                const dataPoints = period === 'daily' ? 30 : period === 'weekly' ? 12 : 12;
                chart.data.datasets.forEach(dataset => {
                    dataset.data = Array(dataPoints).fill(0).map(() => Math.floor(Math.random() * 30) + 10);
                });
                chart.update();
            }
        }

        function toggleChartType(chartName) {
            const chart = charts[chartName];
            if (chart) {
                chart.config.type = chart.config.type === 'bar' ? 'line' : 'bar';
                chart.update();
            }
        }
    </script>
</body>
</html>