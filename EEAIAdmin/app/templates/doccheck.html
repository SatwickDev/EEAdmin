<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document Compliance Checker</title>
  <!-- Enhanced CSS Framework -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.6.10/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/finstack-master.css') }}">
  <link href="{{ url_for('static', filename='css/global-components.css') }}" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    .file-drop { 
      border: 2px dashed var(--primary-500); 
      padding: var(--space-8); 
      border-radius: var(--radius-2xl); 
      text-align: center; 
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      transition: all var(--transition-spring);
    }
    .file-drop:hover {
      border-color: var(--primary-600);
      background: var(--primary-50);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .json-viewer { 
      background: var(--gray-900); 
      color: var(--gray-200); 
      padding: var(--space-6); 
      border-radius: var(--radius-xl); 
      font-size: var(--text-sm); 
      overflow-x: auto;
      border: 1px solid var(--glass-border);
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3"></script>
  <!-- Vuetify 3 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.6.10/dist/vuetify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.6.10/dist/vuetify-labs-components.umd.js"></script>
  <script>
    const { createApp, ref, computed } = Vue;
    const { createVuetify } = Vuetify;

    const app = createApp({
      setup() {
        // State
        const files = ref([]);
        const uploading = ref(false);
        const results = ref(null);
        const error = ref("");
        const expand = ref([]);

        // Drag & Drop file handler
        const handleDrop = (e) => {
          e.preventDefault();
          const dropped = Array.from(e.dataTransfer.files);
          files.value.push(...dropped);
        };
        const removeFile = (idx) => files.value.splice(idx, 1);

        // File input
        const addFiles = (e) => {
          files.value.push(...Array.from(e.target.files));
        };

        // API call
        const runCompliance = async () => {
          error.value = "";
          results.value = null;
          expand.value = [];
          if (files.value.length < 2) {
            error.value = "Upload at least a SWIFT doc and a supporting doc.";
            return;
          }
          uploading.value = true;
          try {
            const formData = new FormData();
            files.value.forEach(f => formData.append("file", f));
            const res = await fetch("/doc_compliance_check", {
              method: "POST",
              body: formData
            });
            if (!res.ok) throw new Error((await res.json()).error || "Server error");
            results.value = await res.json();
            expand.value = results.value.compliance_results.map(_ => false);
          } catch (e) {
            error.value = e.message || "Unknown error";
          } finally {
            uploading.value = false;
          }
        };

        // Utility: Export results as JSON
        const exportResults = () => {
          if (!results.value) return;
          const blob = new Blob([JSON.stringify(results.value, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "compliance_results.json";
          a.click();
          URL.revokeObjectURL(url);
        };

        // Format JSON pretty for UI
        const prettyJSON = (obj) => JSON.stringify(obj, null, 2);

        // Map icons for file types
        const fileIcon = (file) => {
          if (file.name.match(/\.pdf$/i)) return "mdi-file-pdf-box";
          if (file.name.match(/\.(jpg|jpeg|png)$/i)) return "mdi-file-image";
          if (file.name.match(/swift/i)) return "mdi-email-fast-outline";
          return "mdi-file-document";
        };

        return {
          files, uploading, results, error, expand,
          handleDrop, removeFile, addFiles, runCompliance, exportResults, prettyJSON, fileIcon
        };
      },
      // All delimiters changed to [[ ... ]]
      template: `
        <v-app>
          <v-main>
            <v-container class="py-8" style="max-width:900px">
              <v-card class="mb-6 elevation-10" rounded="xl">
                <v-card-title class="text-h4 pb-0 pt-6 text-primary font-weight-bold text-center">Document Compliance Checker</v-card-title>
                <v-card-text>
                  <p class="mb-4 text-medium-emphasis">Upload your SWIFT document and supporting documents (PDF, images). Each page will be checked and compared for compliance.</p>
                  <!-- File Drop Area -->
                  <div class="file-drop mb-3"
                       @dragover.prevent
                       @dragenter.prevent
                       @drop="handleDrop">
                    <v-icon size="50" color="primary">mdi-cloud-upload</v-icon>
                    <div class="my-2">Drag & drop files here, or</div>
                    <v-btn color="primary" variant="outlined" @click="$refs.fileInput.click()">Select Files</v-btn>
                    <input ref="fileInput" type="file" multiple hidden accept=".pdf,image/*" @change="addFiles" />
                  </div>
                  <v-list lines="two" v-if="files.length">
                    <v-list-item v-for="(f, i) in files" :key="i" :title="f.name" :subtitle="'Size: '+(f.size/1024).toFixed(1)+' KB'">
                      <template #prepend>
                        <v-icon :icon="fileIcon(f)" color="primary"></v-icon>
                      </template>
                      <template #append>
                        <v-btn icon="mdi-close" @click="removeFile(i)" variant="text"></v-btn>
                      </template>
                    </v-list-item>
                  </v-list>
                  <v-alert v-if="error" type="error" class="my-4" border="start" variant="tonal">
                    [[ error ]]
                  </v-alert>
                  <div class="d-flex justify-end mt-2">
                    <v-btn :loading="uploading" color="primary" size="large" @click="runCompliance" :disabled="uploading || files.length < 2">
                      <v-icon start>mdi-rocket-launch</v-icon>
                      Run Compliance Check
                    </v-btn>
                  </div>
                </v-card-text>
              </v-card>

              <!-- Results -->
              <v-card v-if="results" class="elevation-4 mb-8" rounded="xl">
                <v-card-title class="text-h5">Compliance Results</v-card-title>
                <v-card-text>
                  <div class="mb-3">
                    <v-chip color="primary" variant="flat" size="small" class="me-2">
                      <v-icon start>mdi-email-fast-outline</v-icon>
                      SWIFT: [[ results.swift_doc ]]
                    </v-chip>
                    <v-chip color="primary" variant="flat" size="small" v-for="s in results.supporting_docs" :key="s" class="me-2">
                      <v-icon start>mdi-file-document</v-icon>
                      [[ s ]]
                    </v-chip>
                  </div>
                  <v-btn color="success" @click="exportResults" prepend-icon="mdi-download" variant="outlined" size="small" class="mb-2">
                    Export JSON
                  </v-btn>
                  <v-expansion-panels v-model="expand" multiple>
                    <v-expansion-panel
                      v-for="(item, i) in results.compliance_results"
                      :key="i"
                      :title="'[' + item.supporting_doc_type + '] Page ' + item.supporting_doc_page + ' - ' + item.supporting_file"
                      :text="null"
                      :color="item.comparison.match ? 'green-lighten-4' : 'red-lighten-4'"
                    >
                      <template #title>
                        <div class="d-flex align-center">
                          <v-icon :color="item.comparison.match ? 'green' : 'red'" class="me-2">
                            [[ item.comparison.match ? 'mdi-check-circle-outline' : 'mdi-close-circle-outline' ]]
                          </v-icon>
                          <div>
                            <span class="font-weight-bold">[[ '[' + item.supporting_doc_type + ']' ]]</span>
                            Page [[ item.supporting_doc_page ]] -
                            [[ item.supporting_file ]]
                          </div>
                        </div>
                      </template>
                      <template #default>
                        <div class="mb-2">
                          <v-alert
                            :type="item.comparison.match ? 'success' : 'warning'"
                            variant="tonal"
                            border="start"
                          >
                            [[ item.comparison.match ? "MATCH: All key details are compliant." : "MISMATCH: Review the issues below." ]]
                          </v-alert>
                          <div v-if="item.comparison.mismatches && item.comparison.mismatches.length">
                            <v-list density="compact">
                              <v-list-item v-for="(mis, mi) in item.comparison.mismatches" :key="mi" prepend-icon="mdi-alert">
                                <span class="text-error">[[ mis ]]</span>
                              </v-list-item>
                            </v-list>
                          </div>
                          <div class="mt-2">
                            <v-row>
                              <v-col cols="12" md="6">
                                <div class="text-caption text-primary font-weight-bold mb-1">Extracted SWIFT Fields</div>
                                <pre class="json-viewer">[[ prettyJSON(item.comparison.extracted_swift) ]]</pre>
                              </v-col>
                              <v-col cols="12" md="6">
                                <div class="text-caption text-primary font-weight-bold mb-1">Extracted Supporting Doc Fields</div>
                                <pre class="json-viewer">[[ prettyJSON(item.comparison.extracted_support) ]]</pre>
                              </v-col>
                            </v-row>
                          </div>
                        </div>
                      </template>
                    </v-expansion-panel>
                  </v-expansion-panels>
                </v-card-text>
              </v-card>
            </v-container>
            <v-footer app absolute class="bg-white text-grey-darken-1 justify-center py-2" elevation="6">
              <div>
                Â© [[ new Date().getFullYear() ]] Doc Compliance Checker
                &nbsp;|&nbsp; <a href="https://vuejs.org/" target="_blank" style="color: #1976d2">Vue 3</a>
                & <a href="https://vuetifyjs.com/" target="_blank" style="color: #1976d2">Vuetify 3</a>
              </div>
            </v-footer>
          </v-main>
        </v-app>
      `
    });

    // Avoid Jinja2 conflict: Use [[ ... ]] for Vue
    app.config.compilerOptions.delimiters = ["[[", "]]"];
    app.use(createVuetify()).mount("#app");
  </script>
</body>
</html>
