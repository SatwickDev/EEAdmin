<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Guarantee - Finstack Trade Finance</title>
    
    <!-- CSS Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.6.10/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/unified-design.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- CKEditor 5 for rich text editing -->
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
    <!-- Bootstrap Icons for accept/reject buttons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        /* Modern Floating Header - Matching index.html */
        .floating-header {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .floating-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Brand Section */
        .brand-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .modern-logo {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: logoFloat 4s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }

        .modern-logo:hover {
            transform: scale(1.05) rotate(2deg);
            border-color: rgba(99, 102, 241, 0.3);
            background: rgba(99, 102, 241, 0.1);
        }

        .status-pulse {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.9);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .brand-info h1 {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
            color: white;
            letter-spacing: -0.5px;
        }

        .brand-info p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
            font-weight: 500;
        }

        /* Navigation Pills */
        .nav-pills {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 4px;
        }

        .nav-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 12px;
            text-decoration: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            background: transparent;
            cursor: pointer;
        }

        .nav-pill:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-1px);
        }

        .nav-pill.active {
            background: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 70%, #06b6d4 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 120px 20px 40px;
        }

        /* Glass Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Header */
        .card-header {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            padding: 30px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }

        .card-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .card-subtitle {
            color: #64748b;
            font-size: 15px;
        }

        /* Form Container */
        .form-container {
            padding: 30px;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            margin-top: 32px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.1);
        }

        .section-header:first-child {
            margin-top: 0;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6366f1;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        /* Form Groups */
        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Editor Container */
        .editor-wrapper {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .editor-wrapper.focused {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .editor-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1e293b;
        }

        /* Sample Data Button */
        .sample-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sample-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }


        /* Results Section */
        .results-section {
            display: none;
            margin-top: 32px;
            padding: 24px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(99, 102, 241, 0.1);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.1);
        }

        .metric-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Loading Modal */
        .loader-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loader-content {
            background: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .spinner {
            font-size: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button Group */
        .button-group {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid #e2e8f0;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }


        /* Grid layout */
        .grid {
            display: grid;
        }
        
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .md\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        
        .gap-3 {
            gap: 0.75rem;
        }
        
        .gap-6 {
            gap: 1.5rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .p-6 {
            padding: 1.5rem;
        }
        
        .text-4xl {
            font-size: 2.25rem;
            line-height: 2.5rem;
        }
        
        .text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .text-xs {
            font-size: 0.75rem;
            line-height: 1rem;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .text-gray-500 {
            color: #6b7280;
        }
        
        .text-gray-600 {
            color: #4b5563;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .text-gray-800 {
            color: #1f2937;
        }
        
        .text-primary-500 {
            color: #6366f1;
        }
        
        .text-primary-600 {
            color: #4f46e5;
        }
        
        .text-primary-700 {
            color: #4338ca;
        }
        
        .bg-gray-50 {
            background-color: #f9fafb;
        }
        
        .bg-gray-100 {
            background-color: #f3f4f6;
        }
        
        .border-t {
            border-top-width: 1px;
        }
        
        .border-b {
            border-bottom-width: 1px;
        }
        
        .border-gray-200 {
            border-color: #e5e7eb;
        }
        
        .rounded {
            border-radius: 0.375rem;
        }
        
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .flex {
            display: flex;
        }
        
        .inline-block {
            display: inline-block;
        }
        
        .items-center {
            align-items: center;
        }
        
        .items-start {
            align-items: flex-start;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-1 {
            gap: 0.25rem;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .gap-3 {
            gap: 0.75rem;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .space-y-1 > * + * {
            margin-top: 0.25rem;
        }
        
        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }
        
        .space-y-3 > * + * {
            margin-top: 0.75rem;
        }
        
        .overflow-y-auto {
            overflow-y: auto;
        }
        
        .max-h-48 {
            max-height: 12rem;
        }
        
        .hover\:bg-gray-50:hover {
            background-color: #f9fafb;
        }
        
        .hover\:text-primary-700:hover {
            color: #4338ca;
        }
        
        .transition-colors {
            transition-property: color, background-color, border-color;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        .hidden {
            display: none;
        }
        
        .px-2 {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        
        .ml-2 {
            margin-left: 0.5rem;
        }
        
        .mr-1 {
            margin-right: 0.25rem;
        }
        
        .mt-1 {
            margin-top: 0.25rem;
        }
        
        .pb-4 {
            padding-bottom: 1rem;
        }
        
        .p-2 {
            padding: 0.5rem;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        .text-left {
            text-align: left;
        }
        
        .flex-1 {
            flex: 1 1 0%;
        }
        
        .w-full {
            width: 100%;
        }
        
        .border-collapse {
            border-collapse: collapse;
        }
        
        .border {
            border-width: 1px;
        }
        
        .overflow-hidden {
            overflow: hidden;
        }
        
        .my-6 {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .flex-wrap {
            flex-wrap: wrap;
        }
        
        .text-yellow-500 {
            color: #eab308;
        }
        
        .text-blue-500 {
            color: #3b82f6;
        }
        
        .fw-bold {
            font-weight: 700 !important;
        }
        
        .mb-0 {
            margin-bottom: 0 !important;
        }
        
        /* Compliance Metric Card */
        .compliance-metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .compliance-metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin: 8px 0;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }
        
        /* Main Container */
        .main-container {
            max-width: 100%;
            padding: 0;
        }
        
        /* Dashboard Card */
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }
        
        .card-header {
            border-bottom: 1px solid rgba(229, 231, 235, 0.8);
            margin-bottom: 24px;
            padding-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* Glass Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        /* Glass Button */
        .glass-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .glass-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }
        
        .glass-button-outline {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .glass-button-outline:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Form Select Modern */
        .form-select-modern {
            padding: 8px 32px 8px 12px;
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 8px;
            background: white;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 20px;
        }
        
        .form-select-modern:hover {
            border-color: #6366f1;
        }
        
        .form-select-modern:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Nav Tabs */
        .nav-tabs {
            border: none;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        .nav-tabs .nav-link {
            border: 2px solid rgba(229, 231, 235, 0.8);
            border-radius: 12px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            color: #4b5563;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
            color: #4f46e5;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }
        
        .nav-item {
            list-style: none;
        }
        
        /* Tab Content */
        .tab-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 24px;
            padding: 32px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.show.active {
            display: block;
        }
        
        .tab-pane.fade {
            transition: opacity 0.15s linear;
        }
        
        .tab-pane.fade.show {
            opacity: 1;
        }
        
        /* Info Card */
        .info-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .severity-high {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
        }
        
        .severity-medium {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
        }
        
        .severity-low {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
        }
        
        /* Highlight Container */
        .highlight-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 16px;
            padding: 24px;
            margin-top: 16px;
            line-height: 1.8;
            white-space: pre-line;
            font-size: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }
        
        .highlight-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0.8;
        }
        
        /* Fade In Animation */
        .fade-in {
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Enhanced Tabs */
        .modal-tabs {
            display: flex;
            gap: 8px;
            padding: 0 24px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            margin-bottom: 24px;
            overflow-x: auto;
        }

        .modal-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .modal-tab:hover {
            color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }

        .modal-tab.active {
            color: #6366f1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-gradient);
        }

        .tab-badge {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Severity Filter */
        .severity-filter {
            padding: 0 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .severity-filter label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .severity-filter select {
            padding: 8px 12px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            background: white;
            color: #1e293b;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Interactive Suggestion Cards */
        .suggestion-card {
            padding: 20px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.1);
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .suggestion-card.accepted {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .suggestion-card.rejected {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border-color: rgba(239, 68, 68, 0.3);
            opacity: 0.6;
        }

        .suggestion-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-accept, .btn-reject {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-accept {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        /* Highlighted Text - Exact match from compliance_results.html */
        .highlight-text {
            position: relative;
            display: inline;
        }

        .highlight-high {
            background: transparent;
            color: var(--gray-700, #374151);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: normal;
            margin: 2px;
            display: inline-block;
            border-bottom: 2px solid #ef4444;
            position: relative;
        }

        .highlight-medium {
            background: transparent;
            color: var(--gray-700, #374151);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: normal;
            margin: 2px;
            display: inline-block;
            border-bottom: 2px solid #f59e0b;
            position: relative;
        }

        .highlight-low {
            background: transparent;
            color: var(--gray-700, #374151);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: normal;
            margin: 2px;
            display: inline-block;
            border-bottom: 2px solid #3b82f6;
            position: relative;
        }

        /* Enhanced suggestion buttons - Clean Modern Design from compliance_results.html */
        .highlight-btn {
            border: none;
            cursor: pointer;
            margin-left: 2px;
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            font-weight: 500;
            backdrop-filter: blur(8px);
            position: relative;
            overflow: hidden;
        }

        .highlight-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .highlight-btn:active::before {
            width: 120px;
            height: 120px;
        }

        .highlight-btn.btn-right {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .highlight-btn.btn-wrong {
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1);
        }

        .highlight-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .highlight-btn.btn-right:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .highlight-btn.btn-wrong:hover {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: rgba(239, 68, 68, 0.5);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
        }

        /* Suggestion styling - Enhanced Modern Design from compliance_results.html */
        .red-strike {
            text-decoration: line-through;
            text-decoration-color: #ef4444;
            text-decoration-thickness: 2px;
            color: #6b7280;
            background: transparent;
            padding: 0 4px;
            opacity: 0.7;
            position: relative;
        }

        .suggested-text {
            color: #059669;
            font-weight: 600;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 3px 12px;
            border-radius: 6px;
            margin-left: 8px;
            border: 1px solid #86efac;
            display: inline-block;
            position: relative;
            box-shadow: 0 1px 3px rgba(5, 150, 105, 0.1);
            animation: subtle-pulse 3s ease-in-out infinite;
        }
        
        @keyframes subtle-pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 1px 3px rgba(5, 150, 105, 0.1);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 2px 4px rgba(5, 150, 105, 0.15);
            }
        }

        /* Suggestion wrapper - Enhanced design from compliance_results.html */
        .suggestion-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            border-radius: 8px;
            border: 1px solid #fbbf24;
            margin: 2px 4px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .suggestion-wrapper:hover {
            background: linear-gradient(135deg, #fed7aa 0%, #fff7ed 100%);
            border-color: #f59e0b;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.2);
        }

        /* Entities Grid */
        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .entity-card {
            padding: 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        /* History Timeline */
        .history-timeline {
            position: relative;
            padding-left: 40px;
        }

        .history-timeline::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #6366f1 0%, rgba(99, 102, 241, 0.1) 100%);
        }

        .history-item {
            position: relative;
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        /* Rules List */
        .rules-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .rule-item {
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Footer Stats */
        .footer-stats {
            display: flex;
            gap: 20px;
            padding-right: 20px;
            border-right: 1px solid rgba(99, 102, 241, 0.1);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #64748b;
        }

        .footer-actions {
            display: flex;
            gap: 12px;
        }

        /* Section Header with Actions */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        /* Compliance Modal Styles */
        .compliance-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .compliance-modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .compliance-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .compliance-modal-content {
            position: relative;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .compliance-modal-header {
            padding: 28px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        }

        .compliance-modal-title {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .compliance-modal-title h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .compliance-modal-title p {
            margin: 4px 0 0 0;
            font-size: 14px;
            color: #64748b;
        }

        .modal-close-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            background: #f1f5f9;
            color: #1e293b;
            transform: rotate(90deg);
        }

        .compliance-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        /* Score Overview */
        .score-overview {
            display: flex;
            align-items: center;
            gap: 32px;
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            margin-bottom: 28px;
            color: white;
        }

        .score-circle {
            width: 120px;
            height: 120px;
        }

        .circular-chart {
            display: block;
            margin: 0;
            max-width: 100%;
            max-height: 100%;
        }

        .circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 2.8;
        }

        .circle {
            fill: none;
            stroke-width: 2.8;
            stroke-linecap: round;
            stroke: white;
            transition: stroke-dasharray 1s ease;
        }

        .percentage {
            fill: white;
            font-size: 8px;
            font-weight: 700;
            text-anchor: middle;
        }

        .score-details h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 600;
        }

        .score-details p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Risk Metrics */
        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        .risk-card {
            padding: 20px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .risk-card.high {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .risk-card.medium {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .risk-card.low {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .risk-card i {
            font-size: 32px;
        }

        .risk-card.high i { color: #ef4444; }
        .risk-card.medium i { color: #f59e0b; }
        .risk-card.low i { color: #10b981; }

        .risk-info {
            display: flex;
            flex-direction: column;
        }

        .risk-count {
            font-size: 28px;
            font-weight: 700;
            line-height: 1;
        }

        .risk-card.high .risk-count { color: #dc2626; }
        .risk-card.medium .risk-count { color: #d97706; }
        .risk-card.low .risk-count { color: #059669; }

        .risk-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Content Sections */
        .content-section {
            margin-bottom: 24px;
        }

        .content-section h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .summary-content, .findings-content, .suggestions-content {
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .highlight-container {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Highlight styles for text */
        .highlight-high {
            background: rgba(239, 68, 68, 0.2);
            padding: 2px 4px;
            border-bottom: 2px solid #ef4444;
            cursor: pointer;
            position: relative;
        }

        .highlight-medium {
            background: rgba(245, 158, 11, 0.2);
            padding: 2px 4px;
            border-bottom: 2px solid #f59e0b;
            cursor: pointer;
            position: relative;
        }

        .highlight-low {
            background: rgba(16, 185, 129, 0.2);
            padding: 2px 4px;
            border-bottom: 2px solid #10b981;
            cursor: pointer;
            position: relative;
        }

        .highlight-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            display: none;
            z-index: 1000;
        }

        .highlight-high:hover .highlight-tooltip,
        .highlight-medium:hover .highlight-tooltip,
        .highlight-low:hover .highlight-tooltip {
            display: block;
        }

        /* Modal Footer */
        .compliance-modal-footer {
            padding: 20px 32px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8fafc;
        }

        .modal-action-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .modal-action-btn.secondary {
            background: white;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }

        .modal-action-btn.secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .modal-action-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .modal-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .floating-header-content {
                flex-direction: column;
                gap: 16px;
            }

            .nav-pills {
                width: 100%;
            }

            .compliance-modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .score-overview {
                flex-direction: column;
                text-align: center;
            }

            .risk-metrics {
                grid-template-columns: 1fr;
            }

            .compliance-modal-footer {
                flex-direction: column;
            }

            .modal-action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Modern Floating Header -->
    <header class="floating-header">
        <div class="floating-header-content">
            <div class="brand-section">
                <div class="logo-container">
                    <div class="modern-logo">
                        <i class="mdi mdi-shield-check" style="font-size: 24px; color: white;"></i>
                        <div class="status-pulse"></div>
                    </div>
                </div>
                <div class="brand-info">
                    <h1>Finstack</h1>
                    <p>Trade Finance Platform</p>
                </div>
            </div>

            <nav class="nav-pills">
                <button class="nav-pill" onclick="window.location.href='/'">
                    <i class="mdi mdi-view-dashboard"></i>
                    <span>Dashboard</span>
                </button>
                <button class="nav-pill active">
                    <i class="mdi mdi-file-document-edit"></i>
                    <span>Guarantee Form</span>
                </button>
                <button class="nav-pill" onclick="window.location.href='/guarantee'">
                    <i class="mdi mdi-shield-check"></i>
                    <span>Vetting Portal</span>
                </button>
            </nav>

            <div class="header-actions">
                <button class="action-btn secondary" onclick="saveDraft()">
                    <i class="mdi mdi-content-save"></i>
                    <span>Save Draft</span>
                </button>
                <button class="action-btn primary" onclick="loadSampleData()">
                    <i class="mdi mdi-file-import"></i>
                    <span>Load Sample</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <div class="glass-card">
            <!-- Card Header -->
            <div class="card-header">
                <h1 class="card-title">Bank Guarantee Application</h1>
                <p class="card-subtitle">Complete the form below and run AI-powered compliance vetting before submission</p>
            </div>

            <!-- Form Container -->
            <div class="form-container">
                <form id="guaranteeForm">
                    <!-- Basic Information Section -->
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="mdi mdi-information"></i>
                        </div>
                        <h2 class="section-title">Basic Information</h2>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="guaranteeNumber">Guarantee Number</label>
                            <input type="text" class="form-control" id="guaranteeNumber" name="guaranteeNumber" placeholder="Auto-generated">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="issueDate">Issue Date</label>
                            <input type="date" class="form-control" id="issueDate" name="issueDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="expiryDate">Expiry Date</label>
                            <input type="date" class="form-control" id="expiryDate" name="expiryDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="amount">Guarantee Amount</label>
                            <input type="number" class="form-control" id="amount" name="amount" placeholder="Enter amount" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="currency">Currency</label>
                            <select class="form-control" id="currency" name="currency" required>
                                <option value="">Select Currency</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                                <option value="INR">INR - Indian Rupee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="guaranteeType">Guarantee Type</label>
                            <select class="form-control" id="guaranteeType" name="guaranteeType" required>
                                <option value="">Select Type</option>
                                <option value="performance">Performance Guarantee</option>
                                <option value="advance_payment">Advance Payment Guarantee</option>
                                <option value="bid_bond">Bid Bond</option>
                                <option value="retention">Retention Money Guarantee</option>
                                <option value="financial">Financial Guarantee</option>
                            </select>
                        </div>
                    </div>

                    <!-- Parties Information Section -->
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="mdi mdi-account-group"></i>
                        </div>
                        <h2 class="section-title">Parties Information</h2>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="applicant">Applicant Name</label>
                            <input type="text" class="form-control" id="applicant" name="applicant" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="applicantAddress">Applicant Address</label>
                            <input type="text" class="form-control" id="applicantAddress" name="applicantAddress" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="beneficiary">Beneficiary Name</label>
                            <input type="text" class="form-control" id="beneficiary" name="beneficiary" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="beneficiaryAddress">Beneficiary Address</label>
                            <input type="text" class="form-control" id="beneficiaryAddress" name="beneficiaryAddress" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="issuingBank">Issuing Bank</label>
                            <input type="text" class="form-control" id="issuingBank" name="issuingBank" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="advisingBank">Advising Bank (Optional)</label>
                            <input type="text" class="form-control" id="advisingBank" name="advisingBank">
                        </div>
                    </div>

                    <!-- Guarantee Terms Section -->
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="mdi mdi-file-document-edit"></i>
                        </div>
                        <h2 class="section-title">Guarantee Terms and Conditions</h2>
                    </div>
                    
                    <div class="editor-wrapper">
                        <div class="editor-header">
                            <div class="editor-title">
                                <i class="mdi mdi-text"></i>
                                Guarantee Wording
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="sample-btn" onclick="loadSampleTerms()">
                                    <i class="mdi mdi-file-import"></i>
                                    Load Sample Terms
                                </button>
                                <button type="button" class="btn btn-secondary" style="padding: 8px 16px;" onclick="clearEditor()">
                                    <i class="mdi mdi-delete"></i>
                                    Clear
                                </button>
                            </div>
                        </div>
                        <div id="guaranteeEditor"></div>
                        <input type="hidden" id="guaranteeTerms" name="guaranteeTerms">
                    </div>

                    <!-- Vetting Analysis Button -->
                    <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%); border-radius: 16px; border: 1px solid rgba(99, 102, 241, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="mdi mdi-robot" style="font-size: 24px; color: white;"></i>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1e293b;">AI-Powered Vetting Analysis</h3>
                                    <p style="margin: 0; font-size: 14px; color: #64748b;">Analyze your guarantee against URDG 758 and compliance rules</p>
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="runVettingAnalysis()" style="width: 100%; padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">
                            <i class="mdi mdi-magnify-scan"></i>
                            Run Vetting Analysis
                        </button>
                    </div>

                    <!-- Form Actions -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="mdi mdi-refresh"></i>
                            Reset Form
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="mdi mdi-send"></i>
                            Submit Guarantee
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loader" class="loader-modal">
        <div class="loader-content">
            <i class="mdi mdi-loading spinner"></i>
            <h3 id="loadingText" style="margin-top: 20px; color: #1e293b;">Analyzing compliance...</h3>
            <p id="loadingSubtext" style="color: #64748b; font-size: 14px; margin-top: 10px;">AI is processing your document</p>
        </div>
    </div>

            <div class="compliance-modal-header">
                <div class="compliance-modal-title">
                    <i class="mdi mdi-chart-box" style="color: #6366f1; font-size: 28px;"></i>
                    <div>
                        <h2>Vetting Analysis Results</h2>
                        <p>AI-powered compliance analysis based on URDG 758</p>
                    </div>
                </div>
                <button class="modal-close-btn" onclick="closeComplianceModal()">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            
            <div class="compliance-modal-body">
                <!-- Main Container -->
                <div class="main-container">
                    <!-- Vetting Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
                        <div class="compliance-metric-card">
                            <i class="mdi mdi-shield-check text-4xl mb-2" style="color: #6366f1;"></i>
                            <div id="complianceScore" class="metric-value">-</div>
                            <div class="metric-label">Vetting Score</div>
                        </div>
                        <div class="compliance-metric-card">
                            <i class="mdi mdi-alert-circle text-4xl mb-2" style="color: #ef4444;"></i>
                            <div id="highRiskCount" class="metric-value">-</div>
                            <div class="metric-label">High Risk Issues</div>
                        </div>
                        <div class="compliance-metric-card">
                            <i class="mdi mdi-alert text-4xl mb-2" style="color: #f59e0b;"></i>
                            <div id="mediumRiskCount" class="metric-value">-</div>
                            <div class="metric-label">Medium Risk Issues</div>
                        </div>
                        <div class="compliance-metric-card">
                            <i class="mdi mdi-check-circle text-4xl mb-2" style="color: #10b981;"></i>
                            <div id="lowRiskCount" class="metric-value">-</div>
                            <div class="metric-label">Low Risk Issues</div>
                        </div>
                    </div>

                    <!-- Results Card -->
                    <div class="dashboard-card fade-in">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="mdi mdi-file-check"></i>
                                Detailed Analysis Report
                            </h2>
                            <div class="flex gap-3">
                                <button class="glass-button-outline" onclick="printReport()">
                                    <i class="mdi mdi-printer"></i>
                                    Print
                                </button>
                                <button class="glass-button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="exportReport()">
                                    <i class="mdi mdi-download"></i>
                                    Export
                                </button>
                            </div>
                        </div>

                        <div class="results-content">
                            <!-- Summary Section -->
                            <div class="glass-card p-6 mb-6">
                                <h6 class="text-lg font-bold gradient-text mb-4">Executive Summary</h6>
                                <div id="complianceSummary" class="text-gray-700"></div>
                            </div>

                            <!-- Framework and Articles -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div class="glass-card p-6">
                                    <h6 class="text-lg font-bold gradient-text mb-4">
                                        <i class="mdi mdi-book-open-variant"></i> Vetting Framework
                                    </h6>
                                    <div id="frameworkBadge" class="glass-button inline-block mb-3"></div>
                                    <p class="text-sm text-gray-600">This analysis is based on international trade finance standards and best practices.</p>
                                    <div id="CustomBadge" class="glass-button inline-block mb-3"><i class="mdi mdi-playlist-plus mr-1"></i>Custom Rule</div>
                                    <p id="customBadgeDescription" class="text-sm text-gray-600">This analysis includes custom compliance rules specific to your organization.</p>
                                    
                                    <!-- Custom Rules Display -->
                                    <div id="customRulesDisplay" class="hidden mt-4 pt-4 border-t border-gray-200">
                                        <h7 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                            <i class="mdi mdi-playlist-plus text-primary-500"></i>
                                            Custom Rules Applied
                                        </h7>
                                        <p class="text-xs text-gray-500 mb-2">In addition to the standard framework rules, the following custom compliance rules have been applied to this vetting analysis:</p>
                                        <div id="customRulesListInFramework" class="space-y-1 text-sm">
                                            <!-- Custom rules will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="glass-card p-6">
                                    <h6 class="text-lg font-bold gradient-text mb-4">
                                        <i class="mdi mdi-format-list-bulleted"></i> Applicable Rules
                                    </h6>
                                    <ul id="articleList" class="space-y-2 max-h-48 overflow-y-auto"></ul>
                                </div>
                            </div>

                            <!-- Custom Rules Section -->
                            <div id="customRulesSection" class="glass-card p-6 mb-8 hidden">
                                <h6 class="text-lg font-bold gradient-text mb-4">
                                    <i class="mdi mdi-playlist-plus"></i> Custom Rules Analysis
                                </h6>
                                <div id="customRulesContent" class="space-y-3">
                                    <p class="text-sm text-gray-600">Custom rules were applied during this analysis:</p>
                                    <div id="customRulesList" class="bg-gray-50 rounded-lg p-4 space-y-2"></div>
                                    <div id="customRulesResults" class="mt-4"></div>
                                </div>
                            </div>

                            <!-- Filter Section -->
                            <div class="flex items-center justify-between mb-6">
                                <h6 class="text-lg font-bold gradient-text flex items-center gap-3">
                                    <span>
                                        <i class="mdi mdi-text-search"></i> Field-by-Field Analysis
                                    </span>
                                    <a href="javascript:void(0)" onclick="goToEntitiesTab()" class="text-sm font-normal text-primary-600 hover:text-primary-700 flex items-center gap-1" title="View Extracted Entities">
                                        <i class="mdi mdi-tag-multiple"></i>
                                        <span>View Entities</span>
                                        <i class="mdi mdi-arrow-right"></i>
                                    </a>
                                </h6>
                                <div class="flex items-center gap-4">
                                    <label class="text-sm font-medium text-gray-700">Filter by severity:</label>
                                    <select id="severityFilter" class="form-select-modern" onchange="filterTabsBySeverity(this.value)">
                                        <option value="all">All Levels</option>
                                        <option value="high">High Risk Only</option>
                                        <option value="medium">Medium Risk Only</option>
                                        <option value="low">Low Risk Only</option>
                                    </select>
                                </div>
                            </div>

                            <div class="border-t border-gray-200 my-6"></div>

                            <!-- Enhanced Tabs -->
                            <ul class="nav-tabs flex flex-wrap gap-3 mb-6" id="fieldTabs" role="tablist"></ul>
                            <div class="tab-content" id="tabContent"></div>
                        </div>
                    </div>
                </div>

                <!-- Legacy Tabs Navigation (Hidden) -->
                <div class="modal-tabs" style="display: none;">
                    <button class="modal-tab active" onclick="switchTab('overview')">
                        <i class="mdi mdi-view-dashboard"></i> Overview
                    </button>
                    <button class="modal-tab" onclick="switchTab('suggestions')">
                        <i class="mdi mdi-lightbulb"></i> Suggestions
                        <span class="tab-badge" id="suggestionsBadge">0</span>
                    </button>
                    <button class="modal-tab" onclick="switchTab('entities')">
                        <i class="mdi mdi-domain"></i> Entities
                        <span class="tab-badge" id="entitiesBadge">0</span>
                    </button>
                    <button class="modal-tab" onclick="switchTab('history')">
                        <i class="mdi mdi-history"></i> History
                        <span class="tab-badge" id="historyBadge">0</span>
                    </button>
                    <button class="modal-tab" onclick="switchTab('rules')">
                        <i class="mdi mdi-shield-check"></i> Custom Rules
                        <span class="tab-badge" id="rulesBadge">0</span>
                    </button>
                </div>

                <!-- Severity Filter -->
                <div class="severity-filter">
                    <label>Filter by Severity:</label>
                    <select id="severityFilter" onchange="filterBySeverity()">
                        <option value="all">All Issues</option>
                        <option value="high">High Priority</option>
                        <option value="medium">Medium Priority</option>
                        <option value="low">Low Priority</option>
                    </select>
                </div>

                <!-- Tab Content -->
                <div id="tabContent">
                    <!-- Overview Tab -->
                    <div id="overviewTab" class="tab-content active">
                        <!-- Score Overview -->
                        <div class="score-overview">
                    <div class="score-circle">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg"
                                d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                            />
                            <path class="circle" id="scoreCircle"
                                stroke-dasharray="0, 100"
                                d="M18 2.0845
                                a 15.9155 15.9155 0 0 1 0 31.831
                                a 15.9155 15.9155 0 0 1 0 -31.831"
                            />
                            <text x="18" y="20.35" class="percentage" id="scorePercentage">0%</text>
                        </svg>
                    </div>
                    <div class="score-details">
                        <h3>Overall Compliance Score</h3>
                        <p id="scoreDescription">Analyzing your document...</p>
                    </div>
                </div>

                <!-- Risk Metrics -->
                <div class="risk-metrics">
                    <div class="risk-card high">
                        <i class="mdi mdi-alert-circle"></i>
                        <div class="risk-info">
                            <span class="risk-count" id="modalHighRisk">0</span>
                            <span class="risk-label">High Risk</span>
                        </div>
                    </div>
                    <div class="risk-card medium">
                        <i class="mdi mdi-alert"></i>
                        <div class="risk-info">
                            <span class="risk-count" id="modalMediumRisk">0</span>
                            <span class="risk-label">Medium Risk</span>
                        </div>
                    </div>
                    <div class="risk-card low">
                        <i class="mdi mdi-check-circle"></i>
                        <div class="risk-info">
                            <span class="risk-count" id="modalLowRisk">0</span>
                            <span class="risk-label">Low Risk</span>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Content with Highlighted Text -->
                <div class="content-section">
                    <h4><i class="mdi mdi-text-box-outline"></i> Executive Summary</h4>
                    <div id="modalSummary" class="summary-content">
                        <!-- Summary will be inserted here -->
                    </div>
                </div>

                <!-- Analyzed Text with Highlights -->
                <div class="content-section">
                    <h4><i class="mdi mdi-file-document-edit"></i> Analyzed Guarantee Text</h4>
                    <div id="highlightedText" class="highlight-container">
                        <!-- Highlighted text will be inserted here -->
                    </div>
                </div>

                <!-- Detailed Findings -->
                <div class="content-section">
                    <h4><i class="mdi mdi-magnify"></i> Detailed Findings</h4>
                    <div id="modalFindings" class="findings-content">
                        <!-- Findings will be inserted here -->
                    </div>
                </div>

                    </div>

                    <!-- Suggestions Tab -->
                    <div id="suggestionsTab" class="tab-content">
                        <div class="content-section">
                            <div class="section-header">
                                <h4><i class="mdi mdi-lightbulb-outline"></i> AI-Powered Suggestions</h4>
                                <div class="action-buttons">
                                    <button class="btn-small" onclick="acceptAllSuggestions()">
                                        <i class="mdi mdi-check-all"></i> Accept All
                                    </button>
                                    <button class="btn-small" onclick="rejectAllSuggestions()">
                                        <i class="mdi mdi-close-circle"></i> Reject All
                                    </button>
                                </div>
                            </div>
                            <div id="modalSuggestions" class="suggestions-content">
                                <!-- Suggestions will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Entities Tab -->
                    <div id="entitiesTab" class="tab-content">
                        <div class="content-section">
                            <h4><i class="mdi mdi-domain"></i> Extracted Entities</h4>
                            <div id="entitiesContent" class="entities-grid">
                                <!-- Entities will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div id="historyTab" class="tab-content">
                        <div class="content-section">
                            <h4><i class="mdi mdi-history"></i> Change History</h4>
                            <div id="historyContent" class="history-timeline">
                                <!-- History will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Rules Tab -->
                    <div id="rulesTab" class="tab-content">
                        <div class="content-section">
                            <div class="section-header">
                                <h4><i class="mdi mdi-shield-check"></i> Custom Compliance Rules</h4>
                                <button class="btn-small" onclick="addCustomRule()">
                                    <i class="mdi mdi-plus"></i> Add Rule
                                </button>
                            </div>
                            <div id="rulesContent" class="rules-list">
                                <!-- Custom rules will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="compliance-modal-footer">
                <div class="footer-stats">
                    <span class="stat-item">
                        <i class="mdi mdi-check-circle"></i>
                        <span id="acceptedCount">0</span> Accepted
                    </span>
                    <span class="stat-item">
                        <i class="mdi mdi-close-circle"></i>
                        <span id="rejectedCount">0</span> Rejected
                    </span>
                    <span class="stat-item">
                        <i class="mdi mdi-clock-outline"></i>
                        <span id="pendingCount">0</span> Pending
                    </span>
                </div>
                <div class="footer-actions">
                    <button class="modal-action-btn secondary" onclick="exportReport()">
                        <i class="mdi mdi-download"></i>
                        Export Report
                    </button>
                    <button class="modal-action-btn secondary" onclick="printReport()">
                        <i class="mdi mdi-printer"></i>
                        Print
                    </button>
                    <button class="modal-action-btn secondary" onclick="copyToClipboard()">
                        <i class="mdi mdi-content-copy"></i>
                        Copy Results
                    </button>
                    <button class="modal-action-btn secondary" onclick="resetAnalysis()">
                        <i class="mdi mdi-refresh"></i>
                        Reset
                    </button>
                    <button class="modal-action-btn primary" onclick="acceptAndContinue()">
                        <i class="mdi mdi-check"></i>
                        Accept & Continue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" style="position: fixed; top: 100px; right: 20px; z-index: 1001;"></div>

    <script>
        let editorInstance = null;
        let currentComplianceData = null;
        let suggestionHistory = [];
        let customRules = [];
        let extractedEntities = [];
        let acceptedSuggestions = new Set();
        let rejectedSuggestions = new Set();

        // Sample Data
        const sampleData = {
            guaranteeNumber: "BG-2024-001234",
            issueDate: "2024-01-15",
            expiryDate: "2025-01-15",
            amount: "500000",
            currency: "USD",
            guaranteeType: "performance",
            applicant: "ABC Construction Ltd.",
            applicantAddress: "123 Business Park, Dubai, UAE",
            beneficiary: "XYZ Infrastructure Corp.",
            beneficiaryAddress: "456 Tower Plaza, Singapore",
            issuingBank: "Emirates NBD Bank",
            advisingBank: "DBS Bank Singapore",
            guaranteeTerms: `<p><strong>PERFORMANCE GUARANTEE</strong></p>
<p>We, Emirates NBD Bank, hereby irrevocably undertake to pay you, XYZ Infrastructure Corp., on your first written demand, any sum or sums not exceeding in total USD 500,000.00 (United States Dollars Five Hundred Thousand Only).</p>
<p><strong>This guarantee is subject to the following conditions:</strong></p>
<ul>
<li>This guarantee shall come into force on the date of issue and shall remain valid until January 15, 2025.</li>
<li>Any claim under this guarantee must be received by us at our office on or before the expiry date.</li>
<li>This guarantee shall be governed by URDG 758 (Uniform Rules for Demand Guarantees, 2010 Revision, ICC Publication No. 758).</li>
<li>Any demand for payment must be accompanied by your written statement that the applicant has failed to perform their contractual obligations.</li>
<li>The maximum aggregate amount payable under this guarantee shall not exceed USD 500,000.00.</li>
<li>This guarantee shall automatically expire on the expiry date, and no claim received after such date shall be honored.</li>
</ul>
<p>This guarantee is issued subject to the laws of the United Arab Emirates and the exclusive jurisdiction of the courts of Dubai.</p>`
        };

        // Initialize CKEditor
        ClassicEditor.create(document.querySelector('#guaranteeEditor'), {
            toolbar: {
                items: [
                    'heading', '|',
                    'bold', 'italic', 'underline', 'strikethrough', '|',
                    'link', 'blockQuote', '|',
                    'bulletedList', 'numberedList', 'outdent', 'indent', '|',
                    'insertTable', '|',
                    'undo', 'redo'
                ]
            },
            placeholder: 'Enter your guarantee text here for AI-powered compliance analysis...',
            language: 'en'
        })
        .then(editor => {
            editorInstance = editor;
            
            // Update hidden field when editor content changes
            editor.model.document.on('change:data', () => {
                document.getElementById('guaranteeTerms').value = editor.getData();
            });

            // Add focus effects
            editor.editing.view.document.on('focus', () => {
                document.querySelector('.editor-wrapper').classList.add('focused');
            });

            editor.editing.view.document.on('blur', () => {
                document.querySelector('.editor-wrapper').classList.remove('focused');
            });

            // Load draft if exists
            loadDraft();
        })
        .catch(error => {
            console.error('Error initializing editor:', error);
            showToast('Failed to initialize editor. Please refresh the page.', 'error');
        });

        // Load Sample Data
        function loadSampleData() {
            if (confirm('This will replace all current form data with sample data. Continue?')) {
                // Fill form fields
                Object.keys(sampleData).forEach(key => {
                    if (key === 'guaranteeTerms') {
                        if (editorInstance) {
                            editorInstance.setData(sampleData[key]);
                        }
                    } else {
                        const field = document.getElementById(key);
                        if (field) {
                            field.value = sampleData[key];
                        }
                    }
                });
                
                showToast('Sample data loaded successfully!', 'success');
            }
        }

        // Load Sample Terms
        function loadSampleTerms() {
            if (editorInstance) {
                if (!editorInstance.getData() || confirm('This will replace current guarantee terms. Continue?')) {
                    editorInstance.setData(sampleData.guaranteeTerms);
                    showToast('Sample terms loaded!', 'success');
                }
            }
        }

        // Clear Editor
        function clearEditor() {
            if (editorInstance && confirm('Are you sure you want to clear all content?')) {
                editorInstance.setData('');
            }
        }


        // Save Draft
        function saveDraft() {
            const formData = new FormData(document.getElementById('guaranteeForm'));
            const data = Object.fromEntries(formData);
            data.guaranteeTerms = editorInstance ? editorInstance.getData() : '';
            
            localStorage.setItem('guaranteeDraft', JSON.stringify(data));
            showToast('Draft saved successfully!', 'success');
        }

        // Load Draft
        function loadDraft() {
            const draft = localStorage.getItem('guaranteeDraft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    Object.keys(data).forEach(key => {
                        if (key === 'guaranteeTerms') {
                            if (editorInstance && data[key]) {
                                editorInstance.setData(data[key]);
                            }
                        } else {
                            const field = document.getElementById(key);
                            if (field) {
                                field.value = data[key];
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error loading draft:', error);
                }
            }
        }

        // Reset Form
        function resetForm() {
            if (confirm('Are you sure you want to reset the form?')) {
                document.getElementById('guaranteeForm').reset();
                if (editorInstance) {
                    editorInstance.setData('');
                }
                showToast('Form reset successfully', 'info');
            }
        }

        // Form Submission
        document.getElementById('guaranteeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            data.guaranteeTerms = editorInstance ? editorInstance.getData() : '';
            
            try {
                showLoader('Submitting guarantee...');
                
                const response = await fetch('/api/guarantee/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                hideLoader();
                
                if (response.ok) {
                    showToast('Guarantee submitted successfully!', 'success');
                    setTimeout(() => {
                        resetForm();
                    }, 2000);
                } else {
                    showToast(result.error || 'Failed to submit guarantee', 'error');
                }
            } catch (error) {
                hideLoader();
                showToast('Error submitting guarantee: ' + error.message, 'error');
            }
        });

        // Show Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 
                             type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' :
                             type === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' :
                             'linear-gradient(135deg, #6366f1, #8b5cf6)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 12px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease;
            `;
            
            const icon = type === 'success' ? 'check-circle' : 
                         type === 'error' ? 'alert-circle' :
                         type === 'warning' ? 'alert' : 'information';
            
            toast.innerHTML = `
                <i class="mdi mdi-${icon}" style="font-size: 20px;"></i>
                <span style="font-weight: 500;">${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Show/Hide Loader
        function showLoader(message = 'Processing...') {
            const loader = document.getElementById('loader');
            document.getElementById('loadingText').textContent = message;
            loader.style.display = 'flex';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        // Auto-save draft every 30 seconds
        setInterval(() => {
            if (editorInstance && editorInstance.getData()) {
                saveDraft();
            }
        }, 30000);


        // Run Vetting Analysis
        async function runVettingAnalysis() {
            if (!editorInstance) {
                showToast('Editor not initialized. Please refresh the page.', 'error');
                return;
            }

            const guaranteeText = editorInstance.getData().replace(/<[^>]+>/g, '').trim();
            
            if (!guaranteeText) {
                showToast('Please enter guarantee terms before running vetting analysis', 'warning');
                return;
            }

            // Show loader
            showLoader('Running AI-powered vetting analysis...');

            try {
                // Prepare data for vetting
                const data = {
                    fields: [{
                        label: "guarantee_wording",
                        value: guaranteeText,
                        description: "Full guarantee text for analysis"
                    }]
                };

                // Submit for AI vetting
                const response = await fetch('/AICheck', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Vetting analysis failed');
                }

                const result = await response.json();
                currentComplianceData = result;

                hideLoader();
                
                // Display results in modal
                displayVettingResults(result);
                
                showToast('Vetting analysis completed successfully', 'success');
            } catch (error) {
                hideLoader();
                console.error('Vetting analysis error:', error);
                showToast('Vetting analysis failed. Please try again.', 'error');
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.closest('.modal-tab').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Filter by severity
        function filterBySeverity() {
            const severity = document.getElementById('severityFilter').value;
            const suggestions = document.querySelectorAll('.suggestion-card');
            
            suggestions.forEach(card => {
                const cardSeverity = card.dataset.severity;
                if (severity === 'all' || cardSeverity === severity) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Accept/Reject individual suggestion
        function acceptSuggestion(suggestionId, fieldKey, originalText, suggestionText) {
            const card = document.getElementById('suggestion-' + suggestionId);
            card.classList.add('accepted');
            card.classList.remove('rejected');
            
            // Track in history
            suggestionHistory.push({
                id: suggestionId,
                fieldKey: fieldKey,
                original: originalText,
                suggestion: suggestionText,
                action: 'accepted',
                timestamp: new Date().toISOString()
            });
            
            acceptedSuggestions.add(suggestionId);
            rejectedSuggestions.delete(suggestionId);
            
            updateStats();
            updateHistoryTab();
            showToast('Suggestion accepted', 'success');
        }

        function rejectSuggestion(suggestionId, fieldKey, originalText) {
            const card = document.getElementById('suggestion-' + suggestionId);
            card.classList.add('rejected');
            card.classList.remove('accepted');
            
            // Track in history
            suggestionHistory.push({
                id: suggestionId,
                fieldKey: fieldKey,
                original: originalText,
                action: 'rejected',
                timestamp: new Date().toISOString()
            });
            
            rejectedSuggestions.add(suggestionId);
            acceptedSuggestions.delete(suggestionId);
            
            updateStats();
            updateHistoryTab();
            showToast('Suggestion rejected', 'info');
        }

        // Accept all suggestions
        function acceptAllSuggestions() {
            const suggestions = document.querySelectorAll('.suggestion-card:not(.accepted):not(.rejected)');
            suggestions.forEach(card => {
                const suggestionId = card.id.replace('suggestion-', '');
                const acceptBtn = card.querySelector('.btn-accept');
                if (acceptBtn) {
                    acceptBtn.click();
                }
            });
            showToast('All suggestions accepted', 'success');
        }

        // Reject all suggestions
        function rejectAllSuggestions() {
            const suggestions = document.querySelectorAll('.suggestion-card:not(.accepted):not(.rejected)');
            suggestions.forEach(card => {
                const suggestionId = card.id.replace('suggestion-', '');
                const rejectBtn = card.querySelector('.btn-reject');
                if (rejectBtn) {
                    rejectBtn.click();
                }
            });
            showToast('All suggestions rejected', 'info');
        }

        // Update statistics
        function updateStats() {
            document.getElementById('acceptedCount').textContent = acceptedSuggestions.size;
            document.getElementById('rejectedCount').textContent = rejectedSuggestions.size;
            
            const totalSuggestions = document.querySelectorAll('.suggestion-card').length;
            const pendingCount = totalSuggestions - acceptedSuggestions.size - rejectedSuggestions.size;
            document.getElementById('pendingCount').textContent = pendingCount;
        }

        // Update history tab
        function updateHistoryTab() {
            const historyContent = document.getElementById('historyContent');
            if (!historyContent) return;
            
            historyContent.innerHTML = '';
            
            // Sort history by timestamp (most recent first)
            const sortedHistory = [...suggestionHistory].reverse();
            
            sortedHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const time = new Date(item.timestamp).toLocaleTimeString();
                const actionIcon = item.action === 'accepted' ? 'check-circle' : 'close-circle';
                const actionColor = item.action === 'accepted' ? '#10b981' : '#ef4444';
                
                historyItem.innerHTML = `
                    <div class="history-time">${time}</div>
                    <div class="history-action">
                        <i class="mdi mdi-${actionIcon}" style="color: ${actionColor};"></i>
                        ${item.action === 'accepted' ? 'Accepted' : 'Rejected'} suggestion for ${item.fieldKey}
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">
                        ${item.original} ${item.action === 'accepted' ? '→ ' + item.suggestion : ''}
                    </div>
                `;
                
                historyContent.appendChild(historyItem);
            });
            
            // Update history badge
            document.getElementById('historyBadge').textContent = suggestionHistory.length;
        }

        // Add custom rule
        function addCustomRule() {
            const ruleName = prompt('Enter rule name:');
            if (!ruleName) return;
            
            const ruleDescription = prompt('Enter rule description:');
            if (!ruleDescription) return;
            
            customRules.push({
                id: Date.now(),
                name: ruleName,
                description: ruleDescription,
                active: true
            });
            
            updateRulesTab();
            showToast('Custom rule added', 'success');
        }

        // Toggle custom rule
        function toggleRule(ruleId) {
            const rule = customRules.find(r => r.id === ruleId);
            if (rule) {
                rule.active = !rule.active;
                updateRulesTab();
            }
        }

        // Update rules tab
        function updateRulesTab() {
            const rulesContent = document.getElementById('rulesContent');
            if (!rulesContent) return;
            
            rulesContent.innerHTML = '';
            
            customRules.forEach(rule => {
                const ruleItem = document.createElement('div');
                ruleItem.className = 'rule-item';
                
                ruleItem.innerHTML = `
                    <div class="rule-info">
                        <div class="rule-name">${rule.name}</div>
                        <div class="rule-description">${rule.description}</div>
                    </div>
                    <div class="rule-toggle ${rule.active ? 'active' : ''}" onclick="toggleRule(${rule.id})"></div>
                `;
                
                rulesContent.appendChild(ruleItem);
            });
            
            // Update rules badge
            document.getElementById('rulesBadge').textContent = customRules.filter(r => r.active).length;
        }

        // Reset analysis
        function resetAnalysis() {
            if (confirm('Are you sure you want to reset all changes?')) {
                acceptedSuggestions.clear();
                rejectedSuggestions.clear();
                suggestionHistory = [];
                
                // Reset all suggestion cards
                document.querySelectorAll('.suggestion-card').forEach(card => {
                    card.classList.remove('accepted', 'rejected');
                });
                
                updateStats();
                updateHistoryTab();
                showToast('Analysis reset', 'info');
            }
        }

        // Print report
        function printReport() {
            window.print();
        }

        // Display Entities
        function displayEntities(data) {
            const entitiesContent = document.getElementById('entitiesContent');
            if (!entitiesContent) return;
            
            // Extract entities from data
            const entities = data.entities || {};
            extractedEntities = entities;
            
            entitiesContent.innerHTML = '';
            
            Object.entries(entities).forEach(([type, value]) => {
                const entityCard = document.createElement('div');
                entityCard.className = 'entity-card';
                entityCard.innerHTML = `
                    <div class="entity-type">${type.replace(/_/g, ' ')}</div>
                    <div class="entity-value">${value}</div>
                `;
                entitiesContent.appendChild(entityCard);
            });
            
            // Update entities badge
            document.getElementById('entitiesBadge').textContent = Object.keys(entities).length;
        }

        // Enhanced highlight function with accept/reject functionality - EXACT from compliance_results.html
        function highlightTextToDOM(text, spans, className, tooltip, fieldKey, suggestions = {}) {
            if (!spans || spans.length === 0) return document.createTextNode(text);

            spans.sort((a, b) => b.length - a.length);
            const lowerText = text.toLowerCase();
            const used = Array(text.length).fill(false);
            const matches = [];

            spans.forEach(span => {
                const safe = span.toLowerCase();
                let start = 0;
                while ((start = lowerText.indexOf(safe, start)) !== -1) {
                    let overlap = false;
                    for (let i = start; i < start + span.length; i++) {
                        if (used[i]) { overlap = true; break; }
                    }
                    if (!overlap) {
                        for (let i = start; i < start + span.length; i++) used[i] = true;
                        matches.push({ start, end: start + span.length, phrase: span });
                    }
                    start += span.length;
                }
            });

            matches.sort((a, b) => a.start - b.start);
            const fragment = document.createDocumentFragment();
            let cursor = 0;

            matches.forEach(({ start, end, phrase }) => {
                if (cursor < start) fragment.appendChild(document.createTextNode(text.slice(cursor, start)));

                // Main highlight wrapper span
                const wrapperSpan = document.createElement('span');
                wrapperSpan.className = className + ' position-relative';
                wrapperSpan.setAttribute('title', tooltip);

                // Check if there's a suggestion for this phrase
                if (suggestions && suggestions[phrase]) {
                    // Create a suggestion wrapper for better styling
                    wrapperSpan.className = 'suggestion-wrapper';

                    const redStrikeSpan = document.createElement('span');
                    redStrikeSpan.className = 'red-strike';
                    redStrikeSpan.textContent = text.slice(start, end);
                    wrapperSpan.appendChild(redStrikeSpan);

                    // Arrow indicator with enhanced styling
                    const arrow = document.createElement('span');
                    arrow.innerHTML = '→';
                    arrow.style.cssText = 'color: #9ca3af; margin: 0 8px; font-size: 16px; font-weight: bold; opacity: 0.8;';
                    wrapperSpan.appendChild(arrow);

                    // Green suggestion
                    const suggestionSpan = document.createElement('span');
                    suggestionSpan.className = 'suggested-text';
                    suggestionSpan.textContent = suggestions[phrase];
                    wrapperSpan.appendChild(suggestionSpan);

                    // Button container
                    const buttonContainer = document.createElement('span');
                    buttonContainer.style.marginLeft = '12px';
                    buttonContainer.style.display = 'inline-flex';
                    buttonContainer.style.gap = '4px';

                    // Accept button
                    const acceptBtn = document.createElement('button');
                    acceptBtn.type = 'button';
                    acceptBtn.className = 'highlight-btn btn-right';
                    acceptBtn.title = 'Accept suggestion: ' + suggestions[phrase];
                    acceptBtn.innerHTML = '<i class="bi bi-check-lg"></i>';
                    acceptBtn.onclick = function(e) {
                        e.preventDefault();
                        acceptSuggestionInline(fieldKey, phrase, suggestions[phrase], wrapperSpan);
                    };

                    // Reject button
                    const rejectBtn = document.createElement('button');
                    rejectBtn.type = 'button';
                    rejectBtn.className = 'highlight-btn btn-wrong';
                    rejectBtn.title = 'Reject suggestion';
                    rejectBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                    rejectBtn.onclick = function(e) {
                        e.preventDefault();
                        rejectSuggestionInline(fieldKey, phrase, wrapperSpan);
                    };

                    buttonContainer.appendChild(acceptBtn);
                    buttonContainer.appendChild(rejectBtn);

                    wrapperSpan.appendChild(buttonContainer);
                } else {
                    // No suggestion, just highlight
                    wrapperSpan.textContent = text.slice(start, end);
                }

                fragment.appendChild(wrapperSpan);
                cursor = end;
            });

            if (cursor < text.length) fragment.appendChild(document.createTextNode(text.slice(cursor)));
            return fragment;
        }

        function acceptSuggestionInline(fieldKey, targetPhrase, suggestion, wrapperSpan) {
            // Track the change
            if (!suggestionHistory[fieldKey]) suggestionHistory[fieldKey] = [];
            suggestionHistory.push({
                fieldKey: fieldKey,
                original: targetPhrase,
                suggestion: suggestion,
                action: 'accepted',
                timestamp: new Date().toISOString()
            });

            // Update the UI - show only the accepted suggestion with a checkmark
            wrapperSpan.innerHTML = '';
            wrapperSpan.className = '';
            wrapperSpan.style.cssText = 'color: #059669; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;';

            const checkIcon = document.createElement('span');
            checkIcon.innerHTML = '✓';
            checkIcon.style.cssText = 'color: #10b981; font-size: 14px;';

            const acceptedText = document.createElement('span');
            acceptedText.textContent = suggestion;

            wrapperSpan.appendChild(checkIcon);
            wrapperSpan.appendChild(acceptedText);

            // Update stats
            acceptedSuggestions.add(fieldKey + '-' + targetPhrase);
            updateStats();
            updateHistoryTab();
            
            // Show applied badge
            markSuggestionApplied(fieldKey);
        }

        function rejectSuggestionInline(fieldKey, targetPhrase, wrapperSpan) {
            // Track the rejection
            if (!suggestionHistory[fieldKey]) suggestionHistory[fieldKey] = [];
            suggestionHistory.push({
                fieldKey: fieldKey,
                original: targetPhrase,
                action: 'rejected',
                timestamp: new Date().toISOString()
            });

            // Replace with original text with a subtle style
            const originalText = wrapperSpan.querySelector('.red-strike').textContent;
            wrapperSpan.innerHTML = '';
            wrapperSpan.className = '';
            wrapperSpan.style.cssText = 'color: #374151; display: inline-flex; align-items: center; gap: 4px;';

            const crossIcon = document.createElement('span');
            crossIcon.innerHTML = '✗';
            crossIcon.style.cssText = 'color: #ef4444; font-size: 12px;';

            const rejectedText = document.createElement('span');
            rejectedText.textContent = originalText;

            wrapperSpan.appendChild(crossIcon);
            wrapperSpan.appendChild(rejectedText);

            wrapperSpan.removeAttribute('title');
            
            // Update stats
            rejectedSuggestions.add(fieldKey + '-' + targetPhrase);
            updateStats();
            updateHistoryTab();
        }

        function markSuggestionApplied(fieldKey) {
            const badge = document.getElementById(`applied-${fieldKey}`);
            if (badge) {
                badge.classList.remove('hidden');
            } else {
                // Create badge if it doesn't exist
                const badgeContainer = document.querySelector('.modal-tabs');
                if (badgeContainer) {
                    const appliedBadge = document.createElement('span');
                    appliedBadge.id = `applied-${fieldKey}`;
                    appliedBadge.className = 'status-badge low';
                    appliedBadge.innerHTML = '<i class="mdi mdi-check"></i> Changes Applied';
                    appliedBadge.style.marginLeft = '12px';
                    badgeContainer.appendChild(appliedBadge);
                }
            }
        }

        // Go to Entities Tab
        function goToEntitiesTab() {
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
            const entitiesTab = document.getElementById('tab-entities-tab');
            if (entitiesTab) {
                entitiesTab.classList.add('active');
                document.getElementById('tab-entities').classList.add('show', 'active');
            }
        }
        
        // Filter tabs by severity
        function filterTabsBySeverity(severity) {
            document.querySelectorAll('#fieldTabs .nav-link').forEach(tab => {
                const fieldKey = tab.dataset.field;
                const tabPane = document.getElementById('tab-' + fieldKey);
                const field = currentComplianceData?.fields[fieldKey];
                const shouldShow = (severity === 'all') || (field?.severity === severity);

                if (shouldShow) {
                    tab.parentElement.style.display = '';
                    if (tabPane) tabPane.style.display = '';
                } else {
                    tab.parentElement.style.display = 'none';
                    if (tabPane) tabPane.style.display = 'none';
                }
            });
        }
        
        // Undo all changes for a field
        function undoAllChanges(fieldKey) {
            // Refresh the tab content with original text
            const field = currentComplianceData.fields[fieldKey];
            const highlightContainer = document.getElementById(`highlight-content-${fieldKey}`);

            if (highlightContainer && field) {
                highlightContainer.innerHTML = '';
                highlightContainer.appendChild(
                    highlightTextToDOM(
                        field.value,
                        field.highlight_spans,
                        'highlight-' + field.severity,
                        field.reason,
                        fieldKey,
                        field.highlight_suggestions || {}
                    )
                );

                // Clear history and hide badge
                suggestionHistory = suggestionHistory.filter(h => h.fieldKey !== fieldKey);
                const badge = document.getElementById(`applied-${fieldKey}`);
                if (badge) badge.classList.add('hidden');
                
                updateStats();
                updateHistoryTab();
            }
        }
        
        // Create field tab
        function createFieldTab(key, field, fieldTabs, tabContent, isFirst) {
            // Create tab button
            const li = document.createElement('li');
            li.className = 'nav-item';
            li.setAttribute('role', 'presentation');

            const button = document.createElement('button');
            button.className = 'nav-link' + (isFirst ? ' active' : '');
            button.id = `tab-${key}-tab`;
            button.setAttribute('data-bs-toggle', 'tab');
            button.setAttribute('data-bs-target', `#tab-${key}`);
            button.setAttribute('type', 'button');
            button.setAttribute('role', 'tab');
            button.setAttribute('data-field', key);
            
            const severityIcon = field.severity === 'high' ? 'mdi-alert-circle' : 
                               field.severity === 'medium' ? 'mdi-alert' : 'mdi-check-circle';
            const severityColor = field.severity === 'high' ? 'text-red-500' : 
                                field.severity === 'medium' ? 'text-yellow-500' : 'text-green-500';
            
            button.innerHTML = `
                <i class="mdi ${severityIcon} ${severityColor}"></i>
                ${key.replace(/_/g, ' ')}
            `;
            
            button.onclick = function() {
                document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
                this.classList.add('active');
                document.getElementById(`tab-${key}`).classList.add('show', 'active');
            };

            li.appendChild(button);
            fieldTabs.appendChild(li);

            // Create tab content
            const tabPane = document.createElement('div');
            tabPane.className = 'tab-pane fade' + (isFirst ? ' show active' : '');
            tabPane.id = `tab-${key}`;
            tabPane.setAttribute('role', 'tabpanel');

            const content = document.createElement('div');
            content.innerHTML = `
                <div class="info-card severity-${field.severity}">
                    <h6 class="fw-bold mb-2">
                        <i class="mdi ${severityIcon}"></i>
                        Severity: ${field.severity.toUpperCase()}
                    </h6>
                    <p class="mb-0">${field.reason}</p>
                </div>

                <div class="highlight-container">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <i class="mdi mdi-text-search text-blue-500"></i>
                                Interactive Text Analysis
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">Click ✓ to accept suggestions or ✗ to reject them</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="glass-button-outline text-sm" onclick="undoAllChanges('${key}')">
                                <i class="mdi mdi-undo"></i> Reset All
                            </button>
                            <span id="applied-${key}" class="status-badge low hidden">
                                <i class="mdi mdi-check"></i> Changes Applied
                            </span>
                        </div>
                    </div>
                    <div id="highlight-content-${key}" class="mt-4"></div>
                </div>
            `;

            tabPane.appendChild(content);
            tabContent.appendChild(tabPane);

            // Add highlighted content after DOM is ready
            setTimeout(() => {
                const highlightContainer = document.getElementById(`highlight-content-${key}`);
                if (highlightContainer) {
                    highlightContainer.appendChild(
                        highlightTextToDOM(
                            field.value,
                            field.highlight_spans,
                            'highlight-' + field.severity,
                            field.reason,
                            key,
                            field.highlight_suggestions || {}
                        )
                    );
                }
            }, 100);
        }
        
        // Create entities tab
        function createEntitiesTab(entities, fieldTabs, tabContent) {
            const entLi = document.createElement('li');
            entLi.className = 'nav-item';
            entLi.setAttribute('role', 'presentation');

            const entBtn = document.createElement('button');
            entBtn.className = 'nav-link';
            entBtn.id = 'tab-entities-tab';
            entBtn.setAttribute('type', 'button');
            entBtn.setAttribute('role', 'tab');
            entBtn.innerHTML = '<i class="mdi mdi-tag-multiple"></i> Extracted Entities';

            entBtn.onclick = function() {
                document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
                this.classList.add('active');
                document.getElementById('tab-entities').classList.add('show', 'active');
            };

            entLi.appendChild(entBtn);
            fieldTabs.appendChild(entLi);

            const entPane = document.createElement('div');
            entPane.className = 'tab-pane fade';
            entPane.id = 'tab-entities';
            entPane.setAttribute('role', 'tabpanel');

            let tableHTML = '<h6 class="text-lg font-bold gradient-text mb-4"><i class="mdi mdi-tag-multiple"></i> Extracted Entities</h6>';
            tableHTML += '<table class="w-full border-collapse border border-gray-200 rounded-lg overflow-hidden">';

            Object.entries(entities).forEach(([key, value]) => {
                tableHTML += `
                    <tr class="border-b border-gray-200">
                        <th class="bg-gray-50 p-4 text-left font-semibold text-gray-700" style="width: 200px;">${key.replace(/_/g, ' ').toUpperCase()}</th>
                        <td class="p-4 text-gray-800">${value}</td>
                    </tr>
                `;
            });

            tableHTML += '</table>';
            entPane.innerHTML = tableHTML;
            tabContent.appendChild(entPane);
        }

        // Display Vetting Results
        function displayVettingResults(data) {
            const { summary, fields, applicable_framework, applicable_articles, entities, customRules, rule_type } = data;
            
            // Calculate metrics
            let highCount = 0, mediumCount = 0, lowCount = 0;
            const issues = [];
            
            if (fields) {
                Object.entries(fields).forEach(([key, field]) => {
                    const severity = field.severity || 'low';
                    if (severity === 'high') highCount++;
                    else if (severity === 'medium') mediumCount++;
                    else lowCount++;
                    
                    issues.push({
                        key: key,
                        label: field.label || key,
                        message: field.message || 'Issue detected',
                        severity: severity,
                        recommendation: field.recommendation || ''
                    });
                });
            }

            // Calculate compliance score
            const totalIssues = highCount + mediumCount + lowCount;
            let score = 100;
            if (totalIssues > 0) {
                score = Math.max(0, 100 - (highCount * 20 + mediumCount * 10 + lowCount * 5));
            }

            // Update modal metrics
            // Also update old modal elements if they exist (for compatibility)
            if (document.getElementById('modalHighRisk')) document.getElementById('modalHighRisk').textContent = highCount;
            if (document.getElementById('modalMediumRisk')) document.getElementById('modalMediumRisk').textContent = mediumCount;
            if (document.getElementById('modalLowRisk')) document.getElementById('modalLowRisk').textContent = lowCount;
            
            // Update new metric cards
            document.getElementById('highRiskCount').textContent = highCount;
            document.getElementById('mediumRiskCount').textContent = mediumCount;
            document.getElementById('lowRiskCount').textContent = lowCount;

            // Update score circle
            const scoreCircle = document.getElementById('scoreCircle');
            const scorePercentage = document.getElementById('scorePercentage');
            scoreCircle.setAttribute('stroke-dasharray', `${score}, 100`);
            scorePercentage.textContent = score + '%';

            // Update score description
            const scoreDescription = document.getElementById('scoreDescription');
            if (score >= 80) {
                scoreDescription.textContent = 'Excellent compliance - Low risk profile';
            } else if (score >= 60) {
                scoreDescription.textContent = 'Good compliance - Some attention needed';
            } else if (score >= 40) {
                scoreDescription.textContent = 'Fair compliance - Multiple issues found';
            } else {
                scoreDescription.textContent = 'Poor compliance - Immediate attention required';
            }

            // Update summary
            const modalSummary = document.getElementById('modalSummary');
            modalSummary.innerHTML = `
                <div style="padding: 16px; background: ${score >= 80 ? '#d1fae5' : score >= 50 ? '#fef3c7' : '#fee2e2'}; border-radius: 8px;">
                    <p style="margin: 0 0 8px 0; color: ${score >= 80 ? '#059669' : score >= 50 ? '#d97706' : '#dc2626'}; font-weight: 500;">
                        ${summary || 'Vetting analysis completed. Your guarantee has been analyzed against URDG 758 and compliance rules.'}
                    </p>
                    <p style="margin: 0; font-size: 13px; color: ${score >= 80 ? '#047857' : score >= 50 ? '#b45309' : '#b91c1c'};">
                        <strong>Framework:</strong> ${applicable_framework || 'URDG 758'}
                    </p>
                </div>
            `;

            // Update highlighted text
            updateHighlightedText(editorInstance.getData(), issues);

            // Update findings
            updateFindings(issues);

            // Generate AI suggestions
            generateSuggestions(issues, score);

            // Show modal
            showComplianceModal();
        }

        // Update Highlighted Text
        function updateHighlightedText(originalText, issues) {
            const highlightedTextDiv = document.getElementById('highlightedText');
            let textContent = originalText.replace(/<[^>]+>/g, ''); // Remove HTML tags
            
            // Create highlighted version
            issues.forEach(issue => {
                // Try to find and highlight relevant portions
                const keywords = issue.label.toLowerCase().split(' ');
                keywords.forEach(keyword => {
                    if (keyword.length > 3) {
                        const regex = new RegExp(`(${keyword})`, 'gi');
                        const highlightClass = `highlight-${issue.severity}`;
                        textContent = textContent.replace(regex, 
                            `<span class="${highlightClass}">$1<span class="highlight-tooltip">${issue.message}</span></span>`
                        );
                    }
                });
            });
            
            highlightedTextDiv.innerHTML = textContent || 'No text to display';
        }

        // Update Findings
        function updateFindings(issues) {
            const modalFindings = document.getElementById('modalFindings');
            let findingsHtml = '';
            
            if (issues.length > 0) {
                issues.forEach(issue => {
                    const severityColor = issue.severity === 'high' ? '#ef4444' : 
                                         issue.severity === 'medium' ? '#f59e0b' : '#10b981';
                    const severityBg = issue.severity === 'high' ? 'rgba(239, 68, 68, 0.1)' : 
                                      issue.severity === 'medium' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(16, 185, 129, 0.1)';
                    
                    findingsHtml += `
                        <div style="padding: 16px; margin-bottom: 12px; background: ${severityBg}; border-left: 4px solid ${severityColor}; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="background: ${severityColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                    ${issue.severity}
                                </span>
                                <strong style="color: #1e293b;">${issue.label}</strong>
                            </div>
                            <p style="margin: 0; color: #475569; font-size: 14px;">
                                ${issue.message}
                            </p>
                            ${issue.recommendation ? `
                                <p style="margin: 8px 0 0 0; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); color: #64748b; font-size: 13px;">
                                    <strong>Recommendation:</strong> ${issue.recommendation}
                                </p>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                findingsHtml = '<p style="color: #64748b; text-align: center; padding: 20px;">No compliance issues found. Your guarantee appears to be well-structured.</p>';
            }
            
            modalFindings.innerHTML = findingsHtml;
        }

        // Generate AI Suggestions
        function generateSuggestions(issues, score) {
            const modalSuggestions = document.getElementById('modalSuggestions');
            
            const suggestions = [];
            
            // Generate suggestions based on score and issues
            if (score < 80) {
                suggestions.push({
                    title: 'Strengthen Guarantee Wording',
                    description: 'Consider adding more specific terms regarding payment conditions and default scenarios.',
                    priority: 'high',
                    icon: 'alert-circle'
                });
            }
            
            if (issues.some(i => i.label.toLowerCase().includes('date') || i.label.toLowerCase().includes('expiry'))) {
                suggestions.push({
                    title: 'Review Expiry Terms',
                    description: 'Ensure automatic expiry clauses are clearly defined to avoid disputes.',
                    priority: 'medium',
                    icon: 'clock-outline'
                });
            }
            
            if (issues.some(i => i.label.toLowerCase().includes('jurisdiction') || i.label.toLowerCase().includes('law'))) {
                suggestions.push({
                    title: 'Clarify Jurisdiction',
                    description: 'Specify the governing law and dispute resolution mechanism more clearly.',
                    priority: 'medium',
                    icon: 'gavel'
                });
            }
            
            // Always add a general suggestion
            suggestions.push({
                title: 'Include Force Majeure Clause',
                description: 'Add provisions for unforeseen circumstances that may affect guarantee execution.',
                priority: 'low',
                icon: 'shield-check'
            });
            
            let suggestionsHtml = '<div style="display: grid; gap: 16px;">';
            
            suggestions.forEach(suggestion => {
                const priorityColor = suggestion.priority === 'high' ? '#ef4444' : 
                                     suggestion.priority === 'medium' ? '#f59e0b' : '#10b981';
                
                suggestionsHtml += `
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%); border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.1);">
                        <div style="display: flex; align-items: start; gap: 16px;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, ${priorityColor}22 0%, ${priorityColor}11 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="mdi mdi-${suggestion.icon}" style="font-size: 24px; color: ${priorityColor};"></i>
                            </div>
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; font-weight: 600;">${suggestion.title}</h5>
                                <p style="margin: 0 0 12px 0; color: #64748b; font-size: 14px; line-height: 1.5;">${suggestion.description}</p>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="applySuggestion('${suggestion.title}')" style="padding: 6px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                        Apply Suggestion
                                    </button>
                                    <span style="padding: 4px 8px; background: ${priorityColor}22; color: ${priorityColor}; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                        ${suggestion.priority} priority
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            suggestionsHtml += '</div>';
            modalSuggestions.innerHTML = suggestionsHtml;
        }

        // Apply Suggestion
        function applySuggestion(suggestionTitle) {
            showToast(`Applying suggestion: ${suggestionTitle}`, 'info');
            closeComplianceModal();
            
            // Focus back on editor
            if (editorInstance) {
                editorInstance.focus();
                showToast('Please add the suggested content to your guarantee text', 'info');
            }
        }

        // Show Compliance Modal
        function showComplianceModal() {
            const modal = document.getElementById('complianceModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Close Compliance Modal
        function closeComplianceModal() {
            const modal = document.getElementById('complianceModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Export Report
        function exportReport() {
            if (!currentComplianceData) {
                showToast('No analysis data available to export', 'warning');
                return;
            }
            
            // Create a detailed report
            const report = `VETTING ANALYSIS REPORT\n` +
                          `========================\n\n` +
                          `Date: ${new Date().toLocaleString()}\n` +
                          `Framework: ${currentComplianceData.applicable_framework || 'URDG 758'}\n\n` +
                          `EXECUTIVE SUMMARY\n` +
                          `-----------------\n${currentComplianceData.summary || 'N/A'}\n\n` +
                          `DETAILED FINDINGS\n` +
                          `-----------------\n${JSON.stringify(currentComplianceData.fields, null, 2)}`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vetting_report_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('Report exported successfully', 'success');
        }

        // Copy to Clipboard
        function copyToClipboard() {
            if (!currentComplianceData) {
                showToast('No analysis data available to copy', 'warning');
                return;
            }
            
            const text = `Vetting Analysis Summary:\n${currentComplianceData.summary || 'Analysis completed'}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Results copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        // Accept and Continue
        function acceptAndContinue() {
            closeComplianceModal();
            showToast('Vetting analysis accepted. You can now proceed with the form submission.', 'success');
        }

        // Keyboard shortcut to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('complianceModal');
                if (modal.classList.contains('show')) {
                    closeComplianceModal();
                }
            }
        });

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            @keyframes slideOutRight {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(100px);
                }
            }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>