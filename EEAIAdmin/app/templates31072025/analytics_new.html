<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Finstack</title>

    <!-- Chart Libraries -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/drilldown.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/heatmap.js"></script>
    <script src="https://code.highcharts.com/modules/treemap.js"></script>
    <script src="https://code.highcharts.com/modules/sankey.js"></script>
    <script src="https://code.highcharts.com/modules/dependency-wheel.js"></script>
    <script src="https://code.highcharts.com/modules/networkgraph.js"></script>
    <script src="https://code.highcharts.com/modules/pattern-fill.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/modules/sunburst.js"></script>
    <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>

    <!-- ApexCharts as secondary option -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- MDI Icons -->
    
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/floating-header-unified.css') }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.6.10/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/unified-design.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
</head>
<body class="with-floating-header">
    <!-- Unified Floating Header -->
    <div class="floating-header">
        <div class="floating-header-content">
            <!-- Brand Section -->
            <div class="brand-section">
                <div class="logo-container">
                    <div class="modern-logo">
                        <svg width="28" height="28" viewBox="0 0 48 48">
                            <defs>
                                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#6366f1"/>
                                    <stop offset="50%" style="stop-color:#8b5cf6"/>
                                    <stop offset="100%" style="stop-color:#06b6d4"/>
                                </linearGradient>
                            </defs>
                            <g fill="url(#logoGradient)">
                                <rect x="8" y="8" width="8" height="32" rx="3"/>
                                <rect x="8" y="8" width="24" height="8" rx="3"/>
                                <rect x="8" y="20" width="20" height="8" rx="3"/>
                            </g>
                            <g fill="url(#logoGradient)" opacity="0.6">
                                <rect x="20" y="32" width="20" height="2" rx="1"/>
                                <rect x="20" y="36" width="20" height="2" rx="1"/>
                            </g>
                        </svg>
                        <div class="status-pulse"></div>
                    </div>
                </div>
                <div class="brand-info">
                    <h1 class="brand-title">Finstack</h1>
                    <p class="brand-subtitle">Innovation Partners for the Future of Finance</p>
                </div>
            </div>

            <!-- Navigation Pills -->
            <nav class="nav-pills">
                <a href="/" class="nav-pill ">
                    <i class="mdi mdi-view-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/analytics" class="nav-pill active">
                    <i class="mdi mdi-chart-line"></i>
                    <span>Analytics</span>
                </a>
                <a href="/ai-chat-pro" class="nav-pill ">
                    <i class="mdi mdi-robot"></i>
                    <span>AI Chat</span>
                </a>
                <a href="/compliance-results" class="nav-pill ">
                    <i class="mdi mdi-shield-check"></i>
                    <span>Vetting</span>
                </a>
                <a href="/document-classification" class="nav-pill ">
                    <i class="mdi mdi-file-document-multiple"></i>
                    <span>Documents</span>
                </a>
            </nav>

            <!-- Header Actions -->
            <div class="header-actions">
                <div class="status-indicator-modern">
                    <div class="status-dot"></div>
                    <span>System Online</span>
                </div>
                <a href="/ai-chat-pro" class="action-button">
                    <i class="mdi mdi-plus"></i>
                    <span>New Session</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Modern Floating Header -->
    

            <!-- Navigation Pills -->
            

            <!-- Actions -->
            <div class="header-actions">
                <div class="status-indicator-modern">
                    <div class="pulse-dot"></div>
                    <span>Online</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pt-40 pb-12 px-6">
        <div class="page-container">
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;">
                <div class="breadcrumb-item" onclick="navigateToOverview()">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics Overview</span>
                </div>
                <span class="breadcrumb-separator">/</span>
                <div class="breadcrumb-item" id="breadcrumbModule">
                    <span>Module Details</span>
                </div>
            </div>

            <!-- Advanced Filter Section -->
            <div class="filter-section">
                <div class="filter-grid">
                    <div class="filter-item">
                        <label class="filter-label">Date Range</label>
                        <select class="filter-select" id="dateRangeFilter" onchange="applyDateRangeFilter()">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="3months">Last 3 Months</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Repository</label>
                        <select class="filter-select" id="repositoryFilter" onchange="applyFilters()">
                            <option value="">All Repositories</option>
                            <option value="Trade Finance">Trade Finance</option>
                            <option value="Treasury">Treasury</option>
                            <option value="Cash Management">Cash Management</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Module</label>
                        <select class="filter-select" id="moduleFilter" onchange="applyFilters()">
                            <option value="">All Modules</option>
                            <option value="IMCO">Import Collections (IMCO)</option>
                            <option value="INFI">Inward Finance (INFI)</option>
                            <option value="IMLC">Import LC (IMLC)</option>
                            <option value="MESG">Messages (MESG)</option>
                            <option value="SHGT">Shipping Guarantee (SHGT)</option>
                            <option value="OWGT">Outward Guarantee (OWGT)</option>
                            <option value="FXHD">FX Hedging (FXHD)</option>
                            <option value="SWAP">Interest Rate Swaps</option>
                            <option value="MKTD">Money Market (MKTD)</option>
                            <option value="CASH">Cash Management</option>
                            <option value="POOL">Cash Pooling</option>
                            <option value="PAYM">Payment Processing</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                            <option value="">All Status</option>
                            <option value="authorised">Authorised</option>
                            <option value="pending">Pending</option>
                            <option value="released">Released</option>
                            <option value="rejected">Rejected</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">Amount Range</label>
                        <select class="filter-select" id="amountFilter" onchange="applyFilters()">
                            <option value="">All Amounts</option>
                            <option value="0-50000">AED 0 - 50K</option>
                            <option value="50000-200000">AED 50K - 200K</option>
                            <option value="200000-500000">AED 200K - 500K</option>
                            <option value="500000-1000000">AED 500K - 1M</option>
                            <option value="1000000-5000000">AED 1M - 5M</option>
                            <option value="5000000+">AED 5M+</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                    <div id="filterResultsCount" style="font-size: 14px; color: #64748b; font-weight: 500; opacity: 0; transition: opacity 0.3s ease;">
                        <i class="fas fa-filter" style="margin-right: 6px; font-size: 12px;"></i>
                        <span id="resultsText">Showing all transactions</span>
                    </div>
                    <button class="action-button" style="background: #f3f4f6; color: #374151;" onclick="resetFilters()">
                        <i class="fas fa-redo"></i>
                        Reset
                    </button>
                </div>
            </div>

            <!-- Main Dashboard View -->
            <div id="mainDashboard">
                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card" onclick="showDetailedMetrics('transactions')">
                        <div class="kpi-icon-container gradient-1">
                            <i class="fas fa-exchange-alt" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div class="kpi-value">1,247</div>
                        <div class="kpi-label">Total Transactions</div>
                        <div class="kpi-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>12.5% from last month</span>
                        </div>
                    </div>

                    <div class="kpi-card" onclick="showDetailedMetrics('value')">
                        <div class="kpi-icon-container gradient-2">
                            <i class="fas fa-dollar-sign" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div class="kpi-value">$5.2M</div>
                        <div class="kpi-label">Total Value (AED)</div>
                        <div class="kpi-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>8.2% from last month</span>
                        </div>
                    </div>

                    <div class="kpi-card" onclick="showDetailedMetrics('pending')">
                        <div class="kpi-icon-container gradient-3">
                            <i class="fas fa-clock" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div class="kpi-value">89</div>
                        <div class="kpi-label">Pending Approval</div>
                        <div class="kpi-trend negative">
                            <i class="fas fa-arrow-down"></i>
                            <span>5.1% from last month</span>
                        </div>
                    </div>

                    <div class="kpi-card" onclick="showDetailedMetrics('approved')">
                        <div class="kpi-icon-container gradient-4">
                            <i class="fas fa-check-circle" style="font-size: 28px; color: white;"></i>
                        </div>
                        <div class="kpi-value">342</div>
                        <div class="kpi-label">Approved Today</div>
                        <div class="kpi-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>15.7% from yesterday</span>
                        </div>
                    </div>
                </div>

                <!-- Main Chart Grid -->
                <div class="chart-grid">
                    <!-- Transaction Volume Chart -->
                    <div class="chart-container" id="volumeChartContainer">
                        <div class="realtime-indicator">
                            <div class="realtime-dot"></div>
                            <span>Real-time</span>
                        </div>
                        <div class="chart-header">
                            <h3 class="chart-title">Transaction Volume Analysis</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="toggleChartType('volume')">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                <button class="chart-action-btn" onclick="expandChart('volume')">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <div class="export-menu">
                                    <button class="chart-action-btn" onclick="toggleExportMenu('volume')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <div class="export-dropdown" id="volumeExportMenu">
                                        <div class="export-option" onclick="exportChart('volume', 'png')">
                                            <i class="fas fa-image"></i>
                                            <span>Export as PNG</span>
                                        </div>
                                        <div class="export-option" onclick="exportChart('volume', 'pdf')">
                                            <i class="fas fa-file-pdf"></i>
                                            <span>Export as PDF</span>
                                        </div>
                                        <div class="export-option" onclick="exportChart('volume', 'csv')">
                                            <i class="fas fa-file-csv"></i>
                                            <span>Export as CSV</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-controls">
                            <div class="time-range-selector">
                                <button class="time-range-btn" onclick="changeTimeRange('volume', '1D')">1D</button>
                                <button class="time-range-btn" onclick="changeTimeRange('volume', '1W')">1W</button>
                                <button class="time-range-btn active" onclick="changeTimeRange('volume', '1M')">1M</button>
                                <button class="time-range-btn" onclick="changeTimeRange('volume', '3M')">3M</button>
                                <button class="time-range-btn" onclick="changeTimeRange('volume', '1Y')">1Y</button>
                                <button class="time-range-btn custom-date-btn" onclick="showCustomDatePicker('volume')">
                                    <i class="fas fa-calendar-alt"></i> Custom
                                </button>
                            </div>
                            <div class="comparison-toggle">
                                <input type="checkbox" id="compareVolume" onchange="toggleComparison('volume')">
                                <label for="compareVolume">Compare with previous period</label>
                            </div>
                        </div>
                        <div id="volumeChart" style="height: 350px;"></div>
                        <div class="chart-loading" id="volumeLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>

                    <!-- Status Distribution Chart -->
                    <div class="chart-container" id="statusChartContainer">
                        <div class="chart-header">
                            <h3 class="chart-title">Status Distribution</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="toggleChartType('status')">
                                    <i class="fas fa-chart-pie"></i>
                                </button>
                                <button class="chart-action-btn" onclick="expandChart('status')">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <div class="export-menu">
                                    <button class="chart-action-btn" onclick="toggleExportMenu('status')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <div class="export-dropdown" id="statusExportMenu">
                                        <div class="export-option" onclick="exportChart('status', 'png')">
                                            <i class="fas fa-image"></i>
                                            <span>Export as PNG</span>
                                        </div>
                                        <div class="export-option" onclick="exportChart('status', 'pdf')">
                                            <i class="fas fa-file-pdf"></i>
                                            <span>Export as PDF</span>
                                        </div>
                                        <div class="export-option" onclick="exportChart('status', 'csv')">
                                            <i class="fas fa-file-csv"></i>
                                            <span>Export as CSV</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-type-selector">
                            <button class="chart-type-btn active" onclick="changeStatusChartType('pie')">Pie Chart</button>
                            <button class="chart-type-btn" onclick="changeStatusChartType('donut')">Donut Chart</button>
                            <button class="chart-type-btn" onclick="changeStatusChartType('3d')">3D Pie</button>
                            <button class="chart-type-btn" onclick="changeStatusChartType('treemap')">Treemap</button>
                        </div>
                        <div id="statusChart" style="height: 350px;"></div>
                        <div class="chart-loading" id="statusLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Additional Charts Row -->
                <div class="chart-grid">
                    <!-- Trend Analysis Chart -->
                    <div class="chart-container" id="trendChartContainer">
                        <div class="chart-header">
                            <h3 class="chart-title">Trend Analysis & Forecasting</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="toggleForecast()">
                                    <i class="fas fa-chart-area"></i> Forecast
                                </button>
                                <button class="chart-action-btn" onclick="expandChart('trend')">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div id="trendChart" style="height: 350px;"></div>
                    </div>

                    <!-- Heatmap Chart -->
                    <div class="chart-container" id="heatmapChartContainer">
                        <div class="chart-header">
                            <h3 class="chart-title">Activity Heatmap</h3>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="changeHeatmapView()">
                                    <i class="fas fa-th"></i> Change View
                                </button>
                                <button class="chart-action-btn" onclick="expandChart('heatmap')">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div id="heatmapChart" style="height: 350px;"></div>
                    </div>
                </div>


                <!-- Data Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">Recent Transactions</h3>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div class="table-search">
                                <i class="fas fa-search" style="color: #6b7280;"></i>
                                <input type="text" placeholder="Search transactions..." id="transactionSearch" onkeyup="searchTransactions()">
                            </div>
                            <button class="action-button" style="background: #f3f4f6; color: #374151;" onclick="refreshTransactions()">
                                <i class="fas fa-sync"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable('id')">
                                    Transaction ID
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('module')">
                                    Module
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('entity')">
                                    Entity
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('amount')">
                                    Amount
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('status')">
                                    Status
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('date')">
                                    Date
                                    <i class="fas fa-sort"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                    <div class="pagination">
                        <button class="pagination-btn" onclick="previousPage()" id="prevBtn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="pageInfo">Page 1 of 5</span>
                        <button class="pagination-btn" onclick="nextPage()" id="nextBtn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Module Detail View (Hidden by default) -->
            <div id="moduleDetailView" style="display: none;">
                <!-- Module detail content will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="chart-modal" id="chartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" style="font-size: 24px; font-weight: 700; color: #1e293b;">Chart Details</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalChart" style="height: 500px;"></div>
        </div>
    </div>

    <!-- Transaction Details Drawer -->
    <div class="transaction-drawer" id="transactionDrawer">
        <div class="drawer-header">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">Transaction Details</h3>
            <button class="modal-close" onclick="closeTransactionDrawer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="drawer-content" id="transactionDetails">
            <!-- Transaction details will be loaded here -->
        </div>
    </div>

    <!-- Drill-down Panel -->
    <div class="drilldown-panel" id="drilldownPanel">
        <div class="drilldown-header">
            <div>
                <h2 id="drilldownTitle" style="font-size: 24px; font-weight: 700; color: #1e293b;">Module Analysis</h2>
                <p id="drilldownSubtitle" style="color: #64748b; margin-top: 4px;">Detailed breakdown and insights</p>
            </div>
            <button class="modal-close" onclick="closeDrilldownPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="drilldown-content" id="drilldownContent">
            <!-- Drill-down content will be loaded here -->
        </div>
    </div>

    <!-- Advanced Features Panel -->
    <div class="advanced-panel" id="advancedPanel">
        <div class="panel-header">
            <h3 style="font-size: 18px; font-weight: 700; color: #1e293b;">Advanced Settings</h3>
            <button class="modal-close" onclick="toggleAdvancedPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="panel-section">
                <h4 class="panel-section-title">Chart Settings</h4>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableAnimations" checked>
                        <span>Enable Animations</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableTooltips" checked>
                        <span>Enable Tooltips</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableDataLabels">
                        <span>Show Data Labels</span>
                    </label>
                </div>
            </div>

            <div class="panel-section">
                <h4 class="panel-section-title">Data Refresh</h4>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <label style="display: flex; flex-direction: column; gap: 8px;">
                        <span>Refresh Interval (seconds)</span>
                        <input type="range" min="5" max="60" value="30" id="refreshInterval">
                        <span id="refreshValue" style="font-size: 12px; color: #6b7280;">30s</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autoRefresh" checked>
                        <span>Auto Refresh</span>
                    </label>
                </div>
            </div>

            <div class="panel-section">
                <h4 class="panel-section-title">Export Settings</h4>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <label style="display: flex; flex-direction: column; gap: 8px;">
                        <span>Default Export Format</span>
                        <select class="filter-select">
                            <option value="png">PNG Image</option>
                            <option value="pdf">PDF Document</option>
                            <option value="csv">CSV Data</option>
                            <option value="xlsx">Excel Workbook</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Toggle Button -->
    <div class="settings-toggle" onclick="toggleAdvancedPanel()">
        <i class="fas fa-cog"></i>
    </div>

    <!-- Node Tooltip -->
    <div class="node-tooltip" id="nodeTooltip"></div>

    <!-- Scripts -->
    <script>
        // Initialize Highcharts default options
        Highcharts.setOptions({
            chart: {
                style: {
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                }
            },
            colors: ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6'],
            credits: { enabled: false },
            exporting: {
                buttons: {
                    contextButton: {
                        enabled: false
                    }
                }
            }
        });

        // Global variables
        let currentPage = 1;
        const itemsPerPage = 10;
        let allTransactions = [];
        let filteredTransactions = [];
        let sortColumn = 'date';
        let sortDirection = 'desc';
        let currentModule = null;

        // Enhanced sample data generation with more comprehensive data
        function generateSampleData() {
            const repositories = [
                {
                    name: 'Trade Finance',
                    modules: ['IMCO', 'INFI', 'IMLC', 'MESG', 'SHGT', 'OWGT'],
                    products: ['LC', 'BG', 'Collections', 'Documentary Credit', 'SBLC'],
                    statusWeights: { 'Authorised': 45, 'Pending': 25, 'Released': 20, 'Rejected': 8, 'Processing': 2 },
                    amountRange: [50000, 2000000]
                },
                {
                    name: 'Treasury', 
                    modules: ['FXHD', 'SWAP', 'MKTD', 'DERV', 'BOND'],
                    products: ['FX Forward', 'IRS', 'Money Market', 'Currency Option', 'Bond'],
                    statusWeights: { 'Authorised': 60, 'Pending': 15, 'Released': 18, 'Rejected': 5, 'Completed': 2 },
                    amountRange: [100000, 5000000]
                },
                {
                    name: 'Cash Management',
                    modules: ['CASH', 'POOL', 'PAYM', 'LIQU', 'INVS'],
                    products: ['Cash Pooling', 'Payment Order', 'Liquidity Line', 'Investment', 'Sweep'],
                    statusWeights: { 'Authorised': 70, 'Pending': 20, 'Released': 8, 'Rejected': 1, 'Cancelled': 1 },
                    amountRange: [25000, 1000000]
                }
            ];

            const entities = [
                'ADCB Corporate Banking', 'Emirates NBD Business', 'FAB International', 
                'HSBC UAE Corporate', 'Standard Chartered', 'Mashreq Bank',
                'ADIB Commercial', 'RAK Bank Business'
            ];

            const customerTiers = ['Platinum', 'Gold', 'Silver', 'Bronze'];
            const banks = ['ADCB', 'ENBD', 'FAB', 'HSBC', 'SCB', 'MASHREQ', 'ADIB', 'RAKBANK'];

            const transactions = [];
            const currentDate = new Date();
            
            // Generate 500 transactions for better analytics
            for (let i = 0; i < 500; i++) {
                const repo = repositories[Math.floor(Math.random() * repositories.length)];
                const module = repo.modules[Math.floor(Math.random() * repo.modules.length)];
                const product = repo.products[Math.floor(Math.random() * repo.products.length)];
                
                // Weighted status selection
                const statusRand = Math.random() * 100;
                let status = 'Pending';
                let cumulative = 0;
                for (const [statusName, weight] of Object.entries(repo.statusWeights)) {
                    cumulative += weight;
                    if (statusRand <= cumulative) {
                        status = statusName;
                        break;
                    }
                }

                // Realistic amount generation
                const [minAmount, maxAmount] = repo.amountRange;
                const amount = Math.floor(Math.random() * (maxAmount - minAmount) + minAmount);

                // Date distribution (more recent transactions weighted)
                const daysBack = Math.floor(Math.pow(Math.random(), 1.5) * 365); // Last year with recent bias
                const transactionDate = new Date(currentDate - daysBack * 24 * 60 * 60 * 1000);

                // Customer tier based on amount
                let tier = 'Bronze';
                if (amount > 1000000) tier = 'Platinum';
                else if (amount > 500000) tier = 'Gold';
                else if (amount > 200000) tier = 'Silver';

                transactions.push({
                    id: `${repo.name.substring(0, 2).toUpperCase()}${String(i + 1001).padStart(6, '0')}`,
                    repository: repo.name,
                    module: module,
                    entity: entities[Math.floor(Math.random() * entities.length)],
                    amount: amount,
                    status: status,
                    date: transactionDate.toISOString().split('T')[0],
                    timestamp: transactionDate.getTime(),
                    product: product,
                    bank: banks[Math.floor(Math.random() * banks.length)],
                    customer: `Customer ${Math.floor(Math.random() * 200) + 1}`,
                    tier: tier,
                    processingTime: Math.floor(Math.random() * 72) + 1, // Hours
                    riskScore: Math.floor(Math.random() * 100) + 1,
                    priority: ['High', 'Medium', 'Low'][Math.floor(Math.random() * 3)],
                    channel: ['Online', 'Branch', 'Mobile', 'API'][Math.floor(Math.random() * 4)],
                    currency: ['AED', 'USD', 'EUR', 'GBP'][Math.floor(Math.random() * 4)],
                    country: ['UAE', 'USA', 'UK', 'Germany', 'Singapore'][Math.floor(Math.random() * 5)]
                });
            }

            // Sort by date (most recent first)
            transactions.sort((a, b) => b.timestamp - a.timestamp);
            return transactions;
        }

        // Initialize charts
        let volumeChart, statusChart, trendChart, heatmapChart;
        let chartInstances = {};

        function initializeCharts() {
            // Volume Chart with drill-down capability
            volumeChart = Highcharts.chart('volumeChart', {
                chart: {
                    type: 'column',
                    backgroundColor: 'transparent',
                    events: {
                        drilldown: function(e) {
                            if (!e.seriesOptions) {
                                showModuleDrilldown(e.point.name);
                            }
                        }
                    }
                },
                title: { text: null },
                xAxis: {
                    type: 'category',
                    crosshair: true
                },
                yAxis: {
                    title: { text: 'Number of Transactions' }
                },
                legend: {
                    enabled: false
                },
                tooltip: {
                    headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                    pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y}</b> transactions<br/>'
                },
                plotOptions: {
                    column: {
                        borderRadius: 8,
                        dataLabels: {
                            enabled: false
                        },
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function() {
                                    showModuleDrilldown(this.name);
                                }
                            }
                        }
                    }
                },
                series: [{
                    name: 'Transactions',
                    colorByPoint: true,
                    data: [{
                        name: 'IMCO',
                        y: 187,
                        drilldown: 'IMCO'
                    }, {
                        name: 'INFI',
                        y: 98,
                        drilldown: 'INFI'
                    }, {
                        name: 'IMLC',
                        y: 156,
                        drilldown: 'IMLC'
                    }, {
                        name: 'MESG',
                        y: 234,
                        drilldown: 'MESG'
                    }, {
                        name: 'SHGT',
                        y: 145,
                        drilldown: 'SHGT'
                    }, {
                        name: 'OWGT',
                        y: 89,
                        drilldown: 'OWGT'
                    }]
                }]
            });
            chartInstances.volume = volumeChart;

            // Status Chart
            statusChart = Highcharts.chart('statusChart', {
                chart: {
                    type: 'pie',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                accessibility: {
                    point: {
                        valueSuffix: '%'
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Status',
                    colorByPoint: true,
                    data: [{
                        name: 'Authorised',
                        y: 45.2,
                        color: '#10b981'
                    }, {
                        name: 'Pending',
                        y: 26.8,
                        color: '#f59e0b'
                    }, {
                        name: 'Released',
                        y: 18.5,
                        color: '#6366f1'
                    }, {
                        name: 'Rejected',
                        y: 9.5,
                        color: '#ef4444'
                    }]
                }]
            });
            chartInstances.status = statusChart;

            // Trend Chart
            trendChart = Highcharts.chart('trendChart', {
                chart: {
                    type: 'areaspline',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                xAxis: {
                    categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                },
                yAxis: {
                    title: { text: 'Transaction Volume' }
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' transactions'
                },
                plotOptions: {
                    areaspline: {
                        fillOpacity: 0.1
                    }
                },
                series: [{
                    name: 'Actual',
                    data: [120, 145, 160, 135, 180, 195, 210, 225, 240, 255, 270, 285],
                    color: '#6366f1'
                }, {
                    name: 'Forecast',
                    data: [null, null, null, null, null, null, null, null, null, 255, 275, 295],
                    color: '#f59e0b',
                    dashStyle: 'ShortDash'
                }]
            });
            chartInstances.trend = trendChart;

            // Heatmap Chart
            heatmapChart = Highcharts.chart('heatmapChart', {
                chart: {
                    type: 'heatmap',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                xAxis: {
                    categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                },
                yAxis: {
                    categories: ['00:00', '06:00', '12:00', '18:00'],
                    title: null,
                    reversed: true
                },
                accessibility: {
                    point: {
                        descriptionFormatter: function (point) {
                            var ix = point.index + 1,
                                xName = point.series.xAxis.categories[point.x] || point.x,
                                yName = point.series.yAxis.categories[point.y] || point.y,
                                val = point.value;
                            return ix + '. ' + xName + ' ' + yName + ', ' + val + '.';
                        }
                    }
                },
                colorAxis: {
                    min: 0,
                    minColor: '#FFFFFF',
                    maxColor: '#6366f1'
                },
                legend: {
                    align: 'right',
                    layout: 'vertical',
                    margin: 0,
                    verticalAlign: 'top',
                    y: 25,
                    symbolHeight: 280
                },
                series: [{
                    name: 'Activity',
                    borderWidth: 1,
                    borderColor: '#f3f4f6',
                    data: generateHeatmapData(),
                    dataLabels: {
                        enabled: false
                    }
                }]
            });
            chartInstances.heatmap = heatmapChart;


            // Initialize transactions
            allTransactions = generateSampleData();
            filteredTransactions = [...allTransactions];
            console.log('Generated transactions:', allTransactions.length);
            loadTransactionTable();
            updateKPIMetrics();
        }

        // Update charts based on filtered data
        function updateChartsWithFilteredData() {
            // Update KPI metrics
            updateKPIMetrics();

            // Update Volume Chart
            const volumeData = {};
            filteredTransactions.forEach(transaction => {
                volumeData[transaction.module] = (volumeData[transaction.module] || 0) + 1;
            });

            const volumeSeriesData = Object.entries(volumeData).map(([module, count]) => ({
                name: module,
                y: count,
                drilldown: module
            }));

            if (chartInstances.volume) {
                chartInstances.volume.series[0].setData(volumeSeriesData);
            }

            // Update Status Chart
            const statusData = {};
            filteredTransactions.forEach(transaction => {
                statusData[transaction.status] = (statusData[transaction.status] || 0) + 1;
            });

            const statusSeriesData = Object.entries(statusData).map(([status, count]) => ({
                name: status,
                y: count,
                color: status === 'Authorised' ? '#10b981' :
                       status === 'Pending' ? '#f59e0b' :
                       status === 'Released' ? '#6366f1' : '#ef4444'
            }));

            if (chartInstances.status) {
                chartInstances.status.series[0].setData(statusSeriesData);
            }

            // Update Trend Chart with monthly data
            const monthlyData = {};
            const currentYear = new Date().getFullYear();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            months.forEach((month, index) => {
                monthlyData[index] = 0;
            });

            filteredTransactions.forEach(transaction => {
                const date = new Date(transaction.date);
                if (date.getFullYear() === currentYear) {
                    monthlyData[date.getMonth()]++;
                }
            });

            const trendSeriesData = months.map((month, index) => monthlyData[index]);

            if (chartInstances.trend) {
                chartInstances.trend.series[0].setData(trendSeriesData);
            }

            // Update Heatmap with hourly activity
            const heatmapData = generateFilteredHeatmapData(filteredTransactions);
            if (chartInstances.heatmap) {
                chartInstances.heatmap.series[0].setData(heatmapData);
            }

            // Update Network Chart
            const networkData = generateFilteredNetworkData(filteredTransactions);
            if (chartInstances.network) {
                chartInstances.network.series[0].setData(networkData);
            }
        }

        // Helper functions for data generation
        function generateHeatmapData() {
            const data = [];
            for (let i = 0; i < 7; i++) {
                for (let j = 0; j < 4; j++) {
                    data.push([i, j, Math.floor(Math.random() * 100)]);
                }
            }
            return data;
        }

        function generateFilteredHeatmapData(transactions) {
            const data = [];
            const activity = {};

            // Initialize activity matrix
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 4; hour++) {
                    activity[`${day}-${hour}`] = 0;
                }
            }

            // Count transactions by day and time period
            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                const day = date.getDay();
                const hourGroup = Math.floor(date.getHours() / 6); // 0-5:0, 6-11:1, 12-17:2, 18-23:3
                activity[`${day}-${hourGroup}`]++;
            });

            // Convert to heatmap data format
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 4; hour++) {
                    data.push([day, hour, activity[`${day}-${hour}`]]);
                }
            }

            return data;
        }

        function generateNetworkData() {
            const nodes = ['IMCO', 'INFI', 'IMLC', 'MESG', 'SHGT', 'OWGT', 'Bank A', 'Bank B', 'Entity 1', 'Entity 2'];
            const data = [];
            for (let i = 0; i < 30; i++) {
                const from = nodes[Math.floor(Math.random() * nodes.length)];
                let to = nodes[Math.floor(Math.random() * nodes.length)];
                while (to === from) {
                    to = nodes[Math.floor(Math.random() * nodes.length)];
                }
                const weight = Math.floor(Math.random() * 10) + 1;
                data.push([from, to, weight]);
            }
            return data;
        }

        function generateFilteredNetworkData(transactions) {
            const flowMap = {};

            // Count flows between modules and entities
            transactions.forEach(transaction => {
                const key = `${transaction.module}-${transaction.entity}`;
                flowMap[key] = (flowMap[key] || 0) + 1;
            });

            // Convert to network data format
            const data = Object.entries(flowMap).map(([flow, count]) => {
                const [from, to] = flow.split('-');
                return [from, to, count];
            });

            // Add some bank connections if data is sparse
            if (data.length < 5) {
                const modules = [...new Set(transactions.map(t => t.module))];
                const entities = [...new Set(transactions.map(t => t.entity))];
                const banks = ['Bank A', 'Bank B'];

                modules.forEach(module => {
                    banks.forEach(bank => {
                        data.push([module, bank, Math.floor(Math.random() * 5) + 1]);
                    });
                });

                entities.forEach(entity => {
                    banks.forEach(bank => {
                        data.push([entity, bank, Math.floor(Math.random() * 5) + 1]);
                    });
                });
            }

            return data;
        }

        // Update KPI metrics based on filtered data
        function updateKPIMetrics() {
            // Calculate metrics from filtered transactions
            const totalTransactions = filteredTransactions.length || 0;
            const pendingCount = filteredTransactions.filter(t => t.status === 'Pending').length || 0;
            const totalValue = filteredTransactions.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            const approvedCount = filteredTransactions.filter(t => t.status === 'Authorised').length || 0;

            // Format values with validation
            const formattedTotal = isNaN(totalTransactions) ? '0' : totalTransactions.toLocaleString();
            const formattedValue = isNaN(totalValue) ? 'AED 0.0M' : 'AED ' + (totalValue / 1000000).toFixed(1) + 'M';
            const formattedPending = isNaN(pendingCount) ? '0' : pendingCount.toLocaleString();
            const formattedApproved = isNaN(approvedCount) ? '0' : approvedCount.toLocaleString();

            // Update KPI cards
            const kpiCards = document.querySelectorAll('.kpi-card');
            if (kpiCards[0]) {
                kpiCards[0].querySelector('.kpi-value').textContent = formattedTotal;
            }
            if (kpiCards[1]) {
                kpiCards[1].querySelector('.kpi-value').textContent = formattedValue;
            }
            if (kpiCards[2]) {
                kpiCards[2].querySelector('.kpi-value').textContent = formattedPending;
            }
            if (kpiCards[3]) {
                kpiCards[3].querySelector('.kpi-value').textContent = formattedApproved;
            }

            // Update trends (this would normally be calculated from historical data)
            updateTrendIndicators();
        }

        function updateTrendIndicators() {
            // This is a simplified version - in production, you would calculate actual trends
            const trends = document.querySelectorAll('.kpi-trend');
            trends.forEach(trend => {
                const change = (Math.random() * 20 - 10).toFixed(1);
                const isPositive = change > 0;
                trend.className = `kpi-trend ${isPositive ? 'positive' : 'negative'}`;
                trend.innerHTML = `
                    <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i>
                    <span>${Math.abs(change)}% from last month</span>
                `;
            });
        }

        // Enhanced transaction table with pagination and search
        function loadTransactionTable() {
            const tbody = document.getElementById('transactionTableBody');
            if (!tbody) {
                console.error('Transaction table body not found');
                return;
            }
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

            pageTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td style="cursor: pointer; color: #6366f1;" onclick="showModuleDrilldown('${transaction.module}')">${transaction.module}</td>
                    <td>${transaction.entity}</td>
                    <td>$${transaction.amount.toLocaleString()}</td>
                    <td><span class="status-badge status-${transaction.status.toLowerCase()}">${transaction.status}</span></td>
                    <td>${transaction.date}</td>
                    <td>
                        <div class="action-menu">
                            <button class="chart-action-btn" onclick="viewTransaction('${transaction.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="chart-action-btn" onclick="toggleActionMenu('${transaction.id}')">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="action-menu-dropdown" id="menu-${transaction.id}">
                                <div class="action-menu-item" onclick="exportTransaction('${transaction.id}')">
                                    <i class="fas fa-download"></i>
                                    <span>Export</span>
                                </div>
                                <div class="action-menu-item" onclick="shareTransaction('${transaction.id}')">
                                    <i class="fas fa-share"></i>
                                    <span>Share</span>
                                </div>
                                <div class="action-menu-item" onclick="auditTransaction('${transaction.id}')">
                                    <i class="fas fa-history"></i>
                                    <span>Audit Trail</span>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // Pagination functions
        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadTransactionTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                loadTransactionTable();
            }
        }

        // Search functionality
        function searchTransactions() {
            const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();

            if (searchTerm === '') {
                filteredTransactions = [...allTransactions];
            } else {
                filteredTransactions = allTransactions.filter(transaction =>
                    transaction.id.toLowerCase().includes(searchTerm) ||
                    transaction.module.toLowerCase().includes(searchTerm) ||
                    transaction.entity.toLowerCase().includes(searchTerm) ||
                    transaction.status.toLowerCase().includes(searchTerm) ||
                    transaction.customer.toLowerCase().includes(searchTerm)
                );
            }

            currentPage = 1;
            loadTransactionTable();
        }

        // Sort functionality
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredTransactions.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (column === 'amount') {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            loadTransactionTable();
        }

        // Module drill-down functionality
        function showModuleDrilldown(moduleName) {
            currentModule = moduleName;

            // Show breadcrumb
            document.getElementById('breadcrumb').style.display = 'flex';
            document.getElementById('breadcrumbModule').innerHTML = `<span>${moduleName} Details</span>`;

            // Hide main dashboard
            document.getElementById('mainDashboard').style.display = 'none';

            // Show module detail view
            const moduleDetailView = document.getElementById('moduleDetailView');
            moduleDetailView.style.display = 'block';

            // Generate module-specific content
            const moduleData = generateModuleData(moduleName);
            moduleDetailView.innerHTML = `
                <div class="module-detail-card">
                    <h2 style="font-size: 24px; font-weight: 700; color: #1e293b; margin-bottom: 24px;">
                        ${moduleName} - ${getModuleFullName(moduleName)}
                    </h2>

                    <div class="module-stats-grid">
                        <div class="module-stat">
                            <div class="module-stat-value">${moduleData.totalTransactions}</div>
                            <div class="module-stat-label">Total Transactions</div>
                        </div>
                        <div class="module-stat">
                            <div class="module-stat-value">$${moduleData.totalValue}M</div>
                            <div class="module-stat-label">Total Value</div>
                        </div>
                        <div class="module-stat">
                            <div class="module-stat-value">${moduleData.avgProcessingTime}h</div>
                            <div class="module-stat-label">Avg Processing Time</div>
                        </div>
                        <div class="module-stat">
                            <div class="module-stat-value">${moduleData.successRate}%</div>
                            <div class="module-stat-label">Success Rate</div>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">${moduleName} Status Breakdown</h3>
                        </div>
                        <div id="moduleStatusChart" style="height: 350px;"></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">${moduleName} Daily Trend</h3>
                        </div>
                        <div id="moduleTrendChart" style="height: 350px;"></div>
                    </div>
                </div>

                <div class="chart-container" style="margin-top: 24px;">
                    <div class="chart-header">
                        <h3 class="chart-title">${moduleName} Entity Distribution</h3>
                    </div>
                    <div id="moduleEntityChart" style="height: 400px;"></div>
                </div>
            `;

            // Initialize module-specific charts
            initializeModuleCharts(moduleName);
        }

        function getModuleFullName(module) {
            const names = {
                'IMCO': 'Import Collections',
                'INFI': 'Inward Finance',
                'IMLC': 'Import LC',
                'MESG': 'Messages',
                'SHGT': 'Shipping Guarantee',
                'OWGT': 'Outward Guarantee'
            };
            return names[module] || module;
        }

        function generateModuleData(module) {
            return {
                totalTransactions: Math.floor(Math.random() * 500) + 100,
                totalValue: (Math.random() * 10 + 1).toFixed(1),
                avgProcessingTime: (Math.random() * 48 + 12).toFixed(1),
                successRate: (Math.random() * 20 + 75).toFixed(1)
            };
        }

        function initializeModuleCharts(moduleName) {
            // Module Status Chart
            Highcharts.chart('moduleStatusChart', {
                chart: {
                    type: 'column',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                xAxis: {
                    categories: ['Authorised', 'Pending', 'Released', 'Rejected']
                },
                yAxis: {
                    title: { text: 'Count' }
                },
                series: [{
                    name: moduleName,
                    data: [
                        Math.floor(Math.random() * 100) + 20,
                        Math.floor(Math.random() * 50) + 10,
                        Math.floor(Math.random() * 80) + 15,
                        Math.floor(Math.random() * 30) + 5
                    ],
                    colorByPoint: true
                }]
            });

            // Module Trend Chart
            const days = [];
            const data = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                data.push(Math.floor(Math.random() * 50) + 10);
            }

            Highcharts.chart('moduleTrendChart', {
                chart: {
                    type: 'spline',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                xAxis: {
                    categories: days
                },
                yAxis: {
                    title: { text: 'Transactions' }
                },
                series: [{
                    name: moduleName,
                    data: data,
                    color: '#6366f1'
                }]
            });

            // Module Entity Chart (Sunburst)
            Highcharts.chart('moduleEntityChart', {
                chart: {
                    type: 'sunburst',
                    backgroundColor: 'transparent'
                },
                title: { text: null },
                series: [{
                    type: 'sunburst',
                    data: generateSunburstData(moduleName),
                    allowDrillToNode: true,
                    cursor: 'pointer',
                    dataLabels: {
                        format: '{point.name}',
                        filter: {
                            property: 'innerArcLength',
                            operator: '>',
                            value: 16
                        }
                    },
                    levels: [{
                        level: 1,
                        levelIsConstant: false,
                        dataLabels: {
                            filter: {
                                property: 'outerArcLength',
                                operator: '>',
                                value: 64
                            }
                        }
                    }, {
                        level: 2,
                        colorByPoint: true
                    }, {
                        level: 3,
                        colorVariation: {
                            key: 'brightness',
                            to: -0.5
                        }
                    }, {
                        level: 4,
                        colorVariation: {
                            key: 'brightness',
                            to: 0.5
                        }
                    }]
                }]
            });
        }

        function generateSunburstData(module) {
            const entities = ['Entity 1', 'Entity 2', 'Entity 3', 'Entity 4'];
            const products = ['LC', 'BG', 'Collections'];
            const data = [{
                id: '0.0',
                parent: '',
                name: module
            }];

            let id = 1;
            entities.forEach((entity, i) => {
                const entityId = `1.${i}`;
                data.push({
                    id: entityId,
                    parent: '0.0',
                    name: entity,
                    value: Math.floor(Math.random() * 100) + 20
                });

                products.forEach((product, j) => {
                    data.push({
                        id: `2.${id}`,
                        parent: entityId,
                        name: product,
                        value: Math.floor(Math.random() * 50) + 10
                    });
                    id++;
                });
            });

            return data;
        }

        function navigateToOverview() {
            document.getElementById('breadcrumb').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('moduleDetailView').style.display = 'none';
            currentModule = null;
        }

        // Transaction detail functions
        function viewTransaction(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (!transaction) return;

            const drawer = document.getElementById('transactionDrawer');
            const details = document.getElementById('transactionDetails');

            details.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">Transaction ID</div>
                    <div class="detail-value">${transaction.id}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Module</div>
                    <div class="detail-value">${transaction.module} - ${getModuleFullName(transaction.module)}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge status-${transaction.status.toLowerCase()}">${transaction.status}</span>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Amount</div>
                    <div class="detail-value" style="font-size: 24px; font-weight: 700; color: #6366f1;">
                        $${transaction.amount.toLocaleString()}
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Entity</div>
                    <div class="detail-value">${transaction.entity}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Product Type</div>
                    <div class="detail-value">${transaction.product}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Bank</div>
                    <div class="detail-value">${transaction.bank}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Customer</div>
                    <div class="detail-value">${transaction.customer}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Date</div>
                    <div class="detail-value">${new Date(transaction.date).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}</div>
                </div>

                <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid #e5e7eb;">
                    <h4 style="font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 16px;">Transaction Timeline</h4>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        ${generateTimeline()}
                    </div>
                </div>
            `;

            drawer.classList.add('active');
        }

        function generateTimeline() {
            const events = [
                { time: '09:00 AM', event: 'Transaction Initiated', status: 'completed' },
                { time: '09:15 AM', event: 'Document Verification', status: 'completed' },
                { time: '10:30 AM', event: 'Compliance Check', status: 'completed' },
                { time: '11:00 AM', event: 'Approval Process', status: 'in-progress' },
                { time: 'Pending', event: 'Final Authorization', status: 'pending' }
            ];

            return events.map(item => `
                <div style="display: flex; align-items: flex-start; gap: 16px;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background: ${
                        item.status === 'completed' ? '#10b981' :
                        item.status === 'in-progress' ? '#f59e0b' : '#e5e7eb'
                    }; margin-top: 2px;"></div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">${item.time}</div>
                        <div style="font-size: 14px; color: #1e293b; font-weight: 500;">${item.event}</div>
                    </div>
                </div>
            `).join('');
        }

        function closeTransactionDrawer() {
            document.getElementById('transactionDrawer').classList.remove('active');
        }

        // Action menu functions
        function toggleActionMenu(transactionId) {
            const menu = document.getElementById(`menu-${transactionId}`);
            const isActive = menu.classList.contains('active');

            // Close all menus
            document.querySelectorAll('.action-menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('active');
            });

            // Toggle current menu
            if (!isActive) {
                menu.classList.add('active');
            }
        }

        function exportTransaction(transactionId) {
            showNotification(`Exporting transaction ${transactionId}...`);
            // Implement export logic
        }

        function shareTransaction(transactionId) {
            showNotification(`Sharing transaction ${transactionId}...`);
            // Implement share logic
        }

        function auditTransaction(transactionId) {
            showNotification(`Loading audit trail for ${transactionId}...`);
            // Implement audit trail logic
        }

        // Network node details
        function showNodeDetails(node) {
            const tooltip = document.getElementById('nodeTooltip');
            const nodeData = {
                connections: Math.floor(Math.random() * 20) + 5,
                transactions: Math.floor(Math.random() * 100) + 20,
                value: '$' + (Math.random() * 5 + 0.5).toFixed(1) + 'M'
            };

            tooltip.innerHTML = `
                <strong>${node.name}</strong><br>
                Connections: ${nodeData.connections}<br>
                Transactions: ${nodeData.transactions}<br>
                Total Value: ${nodeData.value}
            `;

            // Position tooltip
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.classList.add('active');

            // Hide tooltip after delay
            setTimeout(() => {
                tooltip.classList.remove('active');
            }, 3000);
        }

        // Refresh functions
        function refreshTransactions() {
            showNotification('Refreshing transactions...');
            setTimeout(() => {
                allTransactions = generateSampleData();
                filteredTransactions = [...allTransactions];
                loadTransactionTable();
                showNotification('Transactions refreshed successfully');
            }, 1000);
        }

        function refreshData() {
            showNotification('Refreshing all data...');
            // Refresh charts
            initializeCharts();
            // Refresh transactions
            refreshTransactions();
        }

        // Chart interaction functions
        function toggleChartType(chartId) {
            if (chartId === 'volume') {
                const currentType = volumeChart.options.chart.type;
                const newType = currentType === 'column' ? 'line' : 'column';
                volumeChart.update({
                    chart: { type: newType }
                });
            }
        }

        function changeStatusChartType(type) {
            document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            let chartType = 'pie';
            let options3d = {};

            if (type === '3d') {
                chartType = 'pie';
                options3d = {
                    enabled: true,
                    alpha: 45,
                    beta: 0
                };
            } else if (type === 'donut') {
                chartType = 'pie';
            } else if (type === 'treemap') {
                chartType = 'treemap';
            }

            statusChart.update({
                chart: {
                    type: chartType,
                    options3d: options3d
                },
                plotOptions: {
                    pie: {
                        innerSize: type === 'donut' ? '50%' : '0%'
                    }
                }
            });
        }

        function expandChart(chartId) {
            const modal = document.getElementById('chartModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalChart = document.getElementById('modalChart');

            // Set title based on chart
            const titles = {
                'volume': 'Transaction Volume Analysis',
                'status': 'Status Distribution',
                'trend': 'Trend Analysis & Forecasting',
                'heatmap': 'Activity Heatmap',
                'network': 'Transaction Flow Network'
            };

            modalTitle.textContent = titles[chartId] || 'Chart Details';
            modal.classList.add('active');

            // Clone the chart to modal
            setTimeout(() => {
                const originalChart = chartInstances[chartId];
                if (originalChart) {
                    Highcharts.chart('modalChart', originalChart.options);
                }
            }, 100);
        }

        function closeModal() {
            document.getElementById('chartModal').classList.remove('active');
        }

        function closeDrilldownPanel() {
            document.getElementById('drilldownPanel').classList.remove('active');
        }

        function toggleExportMenu(chartId) {
            const menu = document.getElementById(chartId + 'ExportMenu');
            menu.classList.toggle('active');

            // Close other menus
            document.querySelectorAll('.export-dropdown').forEach(dropdown => {
                if (dropdown.id !== chartId + 'ExportMenu') {
                    dropdown.classList.remove('active');
                }
            });
        }

        function exportChart(chartId, format) {
            const chart = chartInstances[chartId];
            if (!chart) return;

            if (format === 'png' || format === 'pdf') {
                chart.exportChart({
                    type: format === 'png' ? 'image/png' : 'application/pdf',
                    filename: `${chartId}-chart-${new Date().toISOString().split('T')[0]}`
                });
            } else if (format === 'csv') {
                chart.downloadCSV();
            }

            // Close export menu
            document.getElementById(chartId + 'ExportMenu').classList.remove('active');
            showNotification(`Exporting chart as ${format.toUpperCase()}...`);
        }

        function changeTimeRange(chartId, range) {
            // Update active button
            event.target.parentElement.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update chart data based on range
            showNotification(`Updating to ${range} view...`);
            // Implement actual data loading based on time range
        }

        function toggleComparison(chartId) {
            const isChecked = document.getElementById('compare' + chartId.charAt(0).toUpperCase() + chartId.slice(1)).checked;

            if (isChecked && chartId === 'volume') {
                volumeChart.addSeries({
                    name: 'Previous Period',
                    data: [165, 85, 140, 210, 125, 78],
                    color: '#94a3b8'
                });
            } else if (!isChecked && chartId === 'volume') {
                if (volumeChart.series.length > 1) {
                    volumeChart.series[1].remove();
                }
            }
        }

        function toggleForecast() {
            const forecastSeries = trendChart.series[1];
            if (forecastSeries) {
                forecastSeries.setVisible(!forecastSeries.visible);
                showNotification(forecastSeries.visible ? 'Forecast enabled' : 'Forecast disabled');
            }
        }

        function changeHeatmapView() {
            showNotification('Switching heatmap view...');
            // Implement view change logic
        }

        function resetNetwork() {
            networkChart.series[0].setData(generateNetworkData());
            showNotification('Network chart reset');
        }

        function showDetailedMetrics(metric) {
            const panel = document.getElementById('drilldownPanel');
            const title = document.getElementById('drilldownTitle');
            const subtitle = document.getElementById('drilldownSubtitle');
            const content = document.getElementById('drilldownContent');

            // Set title based on metric
            const titles = {
                'transactions': 'Transaction Analytics',
                'value': 'Value Distribution Analysis',
                'pending': 'Pending Transaction Details',
                'approved': 'Approval Metrics'
            };

            title.textContent = titles[metric] || 'Detailed Analysis';
            subtitle.textContent = 'Click on any element for more details';

            // Generate content based on metric
            content.innerHTML = `
                <div class="drilldown-charts">
                    <div class="chart-container">
                        <h3 class="chart-title">Daily Breakdown</h3>
                        <div id="drilldown-chart-1" style="height: 300px;"></div>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Category Distribution</h3>
                        <div id="drilldown-chart-2" style="height: 300px;"></div>
                    </div>
                </div>
            `;

            panel.classList.add('active');

            // Initialize drill-down charts
            setTimeout(() => {
                Highcharts.chart('drilldown-chart-1', {
                    chart: { type: 'spline', backgroundColor: 'transparent' },
                    title: { text: null },
                    series: [{
                        name: 'Daily ' + metric,
                        data: Array.from({length: 30}, () => Math.floor(Math.random() * 100) + 20)
                    }]
                });

                Highcharts.chart('drilldown-chart-2', {
                    chart: { type: 'pie', backgroundColor: 'transparent' },
                    title: { text: null },
                    series: [{
                        name: 'Distribution',
                        data: [
                            ['Category A', Math.random() * 100],
                            ['Category B', Math.random() * 100],
                            ['Category C', Math.random() * 100],
                            ['Category D', Math.random() * 100]
                        ]
                    }]
                });
            }, 100);
        }

        // Filter functions
        function applyFilters() {
            // Show loading state
            showLoadingState();

            const module = document.getElementById('moduleFilter').value;
            const status = document.getElementById('statusFilter').value;
            const entity = document.getElementById('entityFilter').value;

            // Update active filter visual indicators
            updateFilterIndicators();

            setTimeout(() => {
                filteredTransactions = allTransactions.filter(transaction => {
                    return (!module || transaction.module === module) &&
                           (!status || transaction.status.toLowerCase() === status) &&
                           (!entity || transaction.entity.toLowerCase() === entity.toLowerCase());
                });

                currentPage = 1;
                loadTransactionTable();
                updateChartsWithFilteredData();
                updateKPIMetrics();

                // Hide loading state
                hideLoadingState();

                // Show filter count and results
                const activeFilters = [module, status, entity].filter(f => f).length;
                const resultsCount = filteredTransactions.length;
                const totalCount = allTransactions.length;

                // Update results count display
                const resultsCountDiv = document.getElementById('filterResultsCount');
                const resultsText = document.getElementById('resultsText');

                if (resultsCountDiv && resultsText) {
                    resultsCountDiv.style.opacity = '1';

                    if (activeFilters > 0) {
                        resultsText.textContent = `Showing ${resultsCount} of ${totalCount} transactions`;
                        resultsText.style.color = '#4f46e5';

                        // Animate the count
                        resultsCountDiv.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            resultsCountDiv.style.transform = 'scale(1)';
                        }, 200);
                    } else {
                        resultsText.textContent = `Showing all ${totalCount} transactions`;
                        resultsText.style.color = '#64748b';
                    }
                }
            }, 300);
        }

        function updateFilterIndicators() {
            // Update visual state of dropdowns based on their values
            document.querySelectorAll('.filter-select').forEach(select => {
                if (select.value) {
                    select.style.background = 'linear-gradient(rgba(249, 250, 255, 1), rgba(249, 250, 255, 1)) padding-box, linear-gradient(135deg, rgba(99, 102, 241, 0.5) 0%, rgba(139, 92, 246, 0.5) 100%) border-box';
                    select.style.color = '#4f46e5';
                } else {
                    select.style.background = '';
                    select.style.color = '';
                }
            });
        }

        function resetFilters() {
            // Show loading briefly
            showLoadingState();

            setTimeout(() => {
                document.querySelectorAll('.filter-select').forEach(select => {
                    select.value = '';
                    select.style.background = '';
                    select.style.color = '';
                });

                filteredTransactions = [...allTransactions];
                currentPage = 1;
                loadTransactionTable();
                updateChartsWithFilteredData();
                updateKPIMetrics();

                // Update results count
                const resultsText = document.getElementById('resultsText');
                if (resultsText) {
                    resultsText.textContent = `Showing all ${allTransactions.length} transactions`;
                    resultsText.style.color = '#64748b';
                }

                hideLoadingState();
                showNotification('All filters cleared');
            }, 300);
        }

        // Advanced panel functions
        function toggleAdvancedPanel() {
            const panel = document.getElementById('advancedPanel');
            panel.classList.toggle('active');
        }

        // Settings handlers
        document.getElementById('refreshInterval').addEventListener('input', function(e) {
            document.getElementById('refreshValue').textContent = e.target.value + 's';
        });

        // Notification function
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #1e293b;
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                z-index: 3000;
                animation: slideUp 0.3s ease;
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        // Auto-refresh functionality
        let refreshInterval;
        function startAutoRefresh() {
            const interval = document.getElementById('refreshInterval').value * 1000;
            refreshInterval = setInterval(() => {
                if (document.getElementById('autoRefresh').checked) {
                    console.log('Refreshing data...');
                    // Implement data refresh logic
                }
            }, interval);
        }

        // Loading state functions
        function showLoadingState() {
            // Add loading class to filter section for shimmer
            const filterSection = document.querySelector('.filter-section');
            if (filterSection) {
                filterSection.classList.add('loading');
            }

            // Show loading spinners for all charts
            document.querySelectorAll('.chart-loading').forEach(loader => {
                loader.style.display = 'flex';
            });
        }

        function hideLoadingState() {
            // Remove loading class from filter section
            const filterSection = document.querySelector('.filter-section');
            if (filterSection) {
                filterSection.classList.remove('loading');
            }

            // Hide loading spinners for all charts
            document.querySelectorAll('.chart-loading').forEach(loader => {
                loader.style.display = 'none';
            });
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Show initial loading state
            showLoadingState();

            // Initialize charts with a slight delay for better UX
            setTimeout(() => {
                initializeCharts();
                startAutoRefresh();

                // Hide loading state after initialization
                setTimeout(() => {
                    hideLoadingState();
                }, 500);
            }, 300);

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.export-menu')) {
                    document.querySelectorAll('.export-dropdown').forEach(dropdown => {
                        dropdown.classList.remove('active');
                    });
                }

                if (!e.target.closest('.action-menu')) {
                    document.querySelectorAll('.action-menu-dropdown').forEach(dropdown => {
                        dropdown.classList.remove('active');
                    });
                }
            });

            // Hide node tooltip when clicking elsewhere
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.network-node')) {
                    document.getElementById('nodeTooltip').classList.remove('active');
                }
            });
        });

        // Simplified Date Range Filtering
        function applyDateRangeFilter() {
            const dateRange = document.getElementById('dateRangeFilter').value;
            let startDate, endDate;
            const now = new Date();
            
            switch(dateRange) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    endDate = new Date(now.setHours(23, 59, 59, 999));
                    break;
                case 'week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startDate = new Date(startOfWeek.setHours(0, 0, 0, 0));
                    endDate = new Date();
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date();
                    break;
                case '3months':
                    startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                    endDate = new Date();
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date();
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date();
            }
            
            // Apply date filter to transactions
            filteredTransactions = allTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            // Apply other active filters
            applyAllFilters();
        }

        // Enhanced filtering with all new filter options
        function applyFilters() {
            applyAllFilters();
        }

        function applyAllFilters() {
            showLoadingState();

            const repository = document.getElementById('repositoryFilter').value;
            const module = document.getElementById('moduleFilter').value;
            const status = document.getElementById('statusFilter').value;
            const amountRange = document.getElementById('amountFilter').value;

            setTimeout(() => {
                // Start with date-filtered transactions
                let filtered = [...filteredTransactions];
                
                // Apply repository filter
                if (repository) {
                    filtered = filtered.filter(t => t.repository === repository);
                }
                
                // Apply module filter
                if (module) {
                    filtered = filtered.filter(t => t.module === module);
                }
                
                // Apply status filter
                if (status) {
                    filtered = filtered.filter(t => t.status.toLowerCase() === status);
                }
                
                // Apply amount range filter
                if (amountRange) {
                    const [min, max] = amountRange.includes('+') 
                        ? [parseInt(amountRange.replace('+', '')), Infinity]
                        : amountRange.split('-').map(v => parseInt(v));
                    
                    filtered = filtered.filter(t => t.amount >= min && t.amount <= max);
                }

                // Update filteredTransactions for display
                const originalFiltered = filteredTransactions;
                filteredTransactions = filtered;

                currentPage = 1;
                loadTransactionTable();
                updateChartsWithFilteredData();
                updateKPIMetrics();

                // Restore original for next filter cycle
                filteredTransactions = originalFiltered;

                hideLoadingState();

                // Update results count
                updateFilterResultsCount(filtered.length);
            }, 500);
        }

        function updateFilterResultsCount(count) {
            const resultsCountDiv = document.getElementById('filterResultsCount');
            const resultsText = document.getElementById('resultsText');
            
            if (resultsCountDiv && resultsText) {
                resultsCountDiv.style.opacity = '1';
                resultsText.textContent = `Showing ${count.toLocaleString()} of ${allTransactions.length.toLocaleString()} transactions`;
            }
        }

        function clearAllFilters() {
            // Reset all filter selects
            document.querySelectorAll('.filter-select').forEach(select => {
                if (select.id === 'dateRangeFilter') {
                    select.value = 'month'; // Set date range back to month
                } else {
                    select.value = '';
                }
            });
            
            // Apply filters (which will show all data for the month)
            applyDateRangeFilter();
            
            // Update results text
            const resultsText = document.getElementById('resultsText');
            if (resultsText) {
                resultsText.textContent = 'Showing all transactions';
                resultsText.style.color = '#64748b';
            }
        }

        function saveFilterPreset() {
            const filters = {
                dateRange: document.getElementById('dateRangeFilter').value,
                repository: document.getElementById('repositoryFilter').value,
                module: document.getElementById('moduleFilter').value,
                status: document.getElementById('statusFilter').value,
                amount: document.getElementById('amountFilter').value
            };
            
            localStorage.setItem('analyticsFilterPreset', JSON.stringify(filters));
            showNotification('Filter preset saved successfully!');
        }

        function loadFilterPreset() {
            const saved = localStorage.getItem('analyticsFilterPreset');
            if (saved) {
                const filters = JSON.parse(saved);
                
                // Apply saved filters
                if (filters.dateRange) document.getElementById('dateRangeFilter').value = filters.dateRange;
                if (filters.repository) document.getElementById('repositoryFilter').value = filters.repository;
                if (filters.module) document.getElementById('moduleFilter').value = filters.module;
                if (filters.status) document.getElementById('statusFilter').value = filters.status;
                if (filters.amount) document.getElementById('amountFilter').value = filters.amount;
                
                // Apply the date range filter
                applyDateRangeFilter();
                
                showNotification('Filter preset loaded successfully!');
            }
        }

        function exportFilteredData() {
            const csv = convertToCSV(filteredTransactions);
            downloadCSV(csv, 'filtered_analytics_data.csv');
            showNotification('Data exported successfully!');
        }

        function convertToCSV(data) {
            const headers = ['ID', 'Repository', 'Module', 'Entity', 'Amount', 'Status', 'Date', 'Product', 'Tier', 'Priority', 'Channel'];
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = [
                    row.id, row.repository, row.module, row.entity, row.amount, 
                    row.status, row.date, row.product, row.tier, row.priority, row.channel
                ];
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: rgba(16, 185, 129, 0.9); color: white;
                padding: 12px 20px; border-radius: 8px; font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                transform: translateX(400px); transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Initialize date range filter on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date range to month
            document.getElementById('dateRangeFilter').value = 'month';
            applyDateRangeFilter();
            
            // Try to load saved filter preset
            loadFilterPreset();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>