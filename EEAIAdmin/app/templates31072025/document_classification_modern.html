<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Classification & Compliance - Finstack AI</title>
    
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/floating-header-unified.css') }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.6.10/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/unified-design.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
  <style>
    body {
      padding-top: 100px;
    }
    @media (max-width: 768px) {
      body {
        padding-top: 80px;
      }
    }
  </style>
</head>
<body class="with-floating-header">
    <!-- Unified Floating Header -->
    <div class="floating-header">
        <div class="floating-header-content">
            <!-- Brand Section -->
            <div class="brand-section">
                <div class="logo-container">
                    <div class="modern-logo">
                        <svg width="28" height="28" viewBox="0 0 48 48">
                            <defs>
                                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#6366f1"/>
                                    <stop offset="50%" style="stop-color:#8b5cf6"/>
                                    <stop offset="100%" style="stop-color:#06b6d4"/>
                                </linearGradient>
                            </defs>
                            <g fill="url(#logoGradient)">
                                <rect x="8" y="8" width="8" height="32" rx="3"/>
                                <rect x="8" y="8" width="24" height="8" rx="3"/>
                                <rect x="8" y="20" width="20" height="8" rx="3"/>
                            </g>
                            <g fill="url(#logoGradient)" opacity="0.6">
                                <rect x="20" y="32" width="20" height="2" rx="1"/>
                                <rect x="20" y="36" width="20" height="2" rx="1"/>
                            </g>
                        </svg>
                        <div class="status-pulse"></div>
                    </div>
                </div>
                <div class="brand-info">
                    <h1 class="brand-title">Finstack</h1>
                    <p class="brand-subtitle">Innovation Partners for the Future of Finance</p>
                </div>
            </div>

            <!-- Navigation Pills -->
            <nav class="nav-pills">
                <a href="/" class="nav-pill ">
                    <i class="mdi mdi-view-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/analytics" class="nav-pill ">
                    <i class="mdi mdi-chart-line"></i>
                    <span>Analytics</span>
                </a>
                <a href="/ai-chat-pro" class="nav-pill ">
                    <i class="mdi mdi-robot"></i>
                    <span>AI Chat</span>
                </a>
                <a href="/compliance-results" class="nav-pill ">
                    <i class="mdi mdi-shield-check"></i>
                    <span>Vetting</span>
                </a>
                <a href="/document-classification" class="nav-pill active">
                    <i class="mdi mdi-file-document-multiple"></i>
                    <span>Documents</span>
                </a>
            </nav>

            <!-- Header Actions -->
            <div class="header-actions">
                <div class="status-indicator-modern">
                    <div class="status-dot"></div>
                    <span>System Online</span>
                </div>
                <a href="/ai-chat-pro" class="action-button">
                    <i class="mdi mdi-plus"></i>
                    <span>New Session</span>
                </a>
            </div>
        </div>
    </div>

    <div id="app">
        <v-app>
            <!-- Header -->
            <div class="modern-header">
                <div class="header-content">
                    <div class="header-title">
                        <v-btn icon variant="text" color="white" @click="goBack">
                            <v-icon>mdi-arrow-left</v-icon>
                        </v-btn>
                        <v-icon size="28">mdi-file-document-multiple</v-icon>
                        <span>Document Classification & Compliance</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span style="opacity: 0.8;">Powered by</span>
                        <span style="font-weight: 600;">Finstack AI</span>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-container">
                <!-- Upload Section -->
                <div v-if="!results.length" class="upload-card fade-in">
                    <div
                        class="drop-zone"
                        :class="{ dragging: isDragging }"
                        @click="$refs.fileInput.click()"
                        @dragover.prevent="isDragging = true"
                        @dragleave.prevent="isDragging = false"
                        @drop.prevent="handleDrop"
                    >
                        <v-icon class="drop-zone-icon">mdi-cloud-upload-outline</v-icon>
                        <h2 class="drop-zone-title">Drop your documents here</h2>
                        <p class="drop-zone-subtitle">or click to browse</p>
                        <div style="display: flex; gap: 8px; justify-content: center;">
                            <v-chip variant="flat">PDF</v-chip>
                            <v-chip variant="flat">JPG</v-chip>
                            <v-chip variant="flat">PNG</v-chip>
                            <v-chip variant="flat">ZIP</v-chip>
                        </div>
                        <input
                            ref="fileInput"
                            type="file"
                            multiple
                            accept=".pdf,.jpg,.jpeg,.png,.zip"
                            @change="handleFileSelect"
                            style="display: none;"
                        />
                    </div>

                    <!-- File List -->
                    <div v-if="uploadedFiles.length" class="file-list">
                        <div
                            v-for="(file, index) in uploadedFiles"
                            :key="index"
                            class="file-item"
                            :class="{ selected: selectedFileIndex === index }"
                            @click="selectFile(index)"
                        >
                            <div class="file-info">
                                <div class="file-icon">
                                    <v-icon size="24" :color="getFileIconColor(file.name)">
                                        [[ getFileIcon(file.name) ]]
                                    </v-icon>
                                </div>
                                <div>
                                    <div style="font-weight: 500;">[[ file.name ]]</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        [[ formatFileSize(file.size) ]]
                                    </div>
                                </div>
                            </div>
                            <v-btn icon size="small" variant="text" @click.stop="removeFile(index)">
                                <v-icon>mdi-close</v-icon>
                            </v-btn>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div v-if="uploadedFiles.length" style="margin-top: 32px; display: flex; gap: 16px; justify-content: center;">
                        <button
                            class="btn btn-primary"
                            @click="classifyDocuments"
                            :disabled="processing"
                        >
                            <v-icon size="20">mdi-magnify-scan</v-icon>
                            <span v-if="!processing">Analyze Documents</span>
                            <span v-else>Processing...</span>
                        </button>
                        <button class="btn btn-secondary" @click="clearAll">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Results Section -->
                <div v-if="results.length" class="results-section fade-in">
                    <div class="results-header">
                        <h2 style="margin: 0; font-size: 28px; font-weight: 600;">Analysis Results</h2>
                        <button class="btn btn-secondary" @click="clearAll">
                            <v-icon size="16">mdi-close</v-icon>
                            New Analysis
                        </button>
                    </div>

                    <div class="results-grid">
                        <div
                            v-for="(result, index) in results"
                            :key="index"
                            class="result-card"
                            @click="openDocumentModal(result, index)"
                        >
                            <div class="result-preview">
                                <img
                                    v-if="result.preview_images && result.preview_images[0]"
                                    :src="'data:image/png;base64,' + result.preview_images[0]"
                                    :alt="result.file_name"
                                />
                                <v-icon v-else size="64" color="grey-lighten-2">
                                    mdi-file-document-outline
                                </v-icon>
                            </div>
                            <div class="result-content">
                                <h3 class="result-title">[[ result.file_name ]]</h3>
                                <span :class="getDocumentBadgeClass(result.document_type)" class="result-badge">
                                    [[ result.document_type ]]
                                </span>
                                <div class="confidence-bar">
                                    <div
                                        class="confidence-fill"
                                        :style="{ width: (result.confidence * 100) + '%' }"
                                    ></div>
                                </div>
                                <div style="font-size: 14px; color: var(--text-secondary);">
                                    Confidence: [[ Math.round(result.confidence * 100) ]]%
                                </div>
                                <div v-if="result.compliance" style="margin-top: 16px;">
                                    <v-icon
                                        size="20"
                                        :color="result.compliance.status === 'compliant' ? 'success' : 'error'"
                                    >
                                        [[ result.compliance.status === 'compliant' ? 'mdi-check-circle' : 'mdi-alert-circle' ]]
                                    </v-icon>
                                    <span style="font-size: 14px; margin-left: 4px;">
                                        [[ result.compliance.status === 'compliant' ? 'Compliant' : 'Non-Compliant' ]]
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Detail Modal -->
            <div v-if="showModal" class="modal-overlay" @click.self="closeModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div>
                            <h2 style="margin: 0; font-size: 24px;">[[ selectedDocument.file_name ]]</h2>
                            <div style="margin-top: 8px; display: flex; align-items: center; gap: 16px;">
                                <span :class="getDocumentBadgeClass(selectedDocument.document_type)" class="result-badge">
                                    [[ selectedDocument.document_type ]]
                                </span>
                                <span style="color: var(--text-secondary);">
                                    Confidence: [[ Math.round(selectedDocument.confidence * 100) ]]%
                                </span>
                            </div>
                        </div>
                        <v-btn icon variant="text" @click="closeModal">
                            <v-icon>mdi-close</v-icon>
                        </v-btn>
                    </div>
                    <div class="modal-body">
                        <div class="modal-left">
                            <h3>Document Preview</h3>
                            <div v-for="(img, idx) in getDocumentImages()" :key="idx">
                                <img
                                    :src="img"
                                    :alt="'Page ' + (idx + 1)"
                                    class="preview-image"
                                />
                            </div>
                        </div>
                        <div class="modal-right">
                            <div class="tabs">
                                <div
                                    class="tab"
                                    :class="{ active: activeTab === 'fields' }"
                                    @click="activeTab = 'fields'"
                                >
                                    Extracted Fields
                                </div>
                                <div
                                    class="tab"
                                    :class="{ active: activeTab === 'compliance' }"
                                    @click="activeTab = 'compliance'"
                                >
                                    Compliance
                                </div>
                            </div>

                            <div v-if="activeTab === 'fields'" class="field-list">
                                <div
                                    v-for="(field, key) in getDocumentFields()"
                                    :key="key"
                                    class="field-item"
                                >
                                    <div class="field-name">[[ formatFieldName(key) ]]</div>
                                    <div class="field-value">[[ getFieldValue(field) ]]</div>
                                    <div v-if="field.confidence" class="field-confidence">
                                        Confidence: [[ field.confidence ]]%
                                    </div>
                                </div>
                            </div>

                            <div v-if="activeTab === 'compliance'">
                                <div v-if="selectedDocument.compliance">
                                    <div
                                        class="compliance-status"
                                        :class="selectedDocument.compliance.status === 'compliant' ? 'status-compliant' : 'status-non-compliant'"
                                    >
                                        <v-icon size="20">
                                            [[ selectedDocument.compliance.status === 'compliant' ? 'mdi-check-circle' : 'mdi-alert-circle' ]]
                                        </v-icon>
                                        [[ selectedDocument.compliance.status === 'compliant' ? 'Compliant' : 'Non-Compliant' ]]
                                    </div>

                                    <div v-if="selectedDocument.compliance.violations && selectedDocument.compliance.violations.length">
                                        <h4>Violations</h4>
                                        <div
                                            v-for="(v, idx) in selectedDocument.compliance.violations"
                                            :key="idx"
                                            class="violation-item"
                                        >
                                            [[ v.description || v.message ]]
                                        </div>
                                    </div>

                                    <div v-if="selectedDocument.compliance.warnings && selectedDocument.compliance.warnings.length">
                                        <h4>Warnings</h4>
                                        <div
                                            v-for="(w, idx) in selectedDocument.compliance.warnings"
                                            :key="idx"
                                            class="warning-item"
                                        >
                                            [[ w.description || w.message ]]
                                        </div>
                                    </div>
                                </div>
                                <div v-else>
                                    <p>No compliance data available for this document.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 24px; border-top: 1px solid var(--border); display: flex; justify-content: space-between;">
                        <button class="btn btn-secondary" @click="exportDocument">
                            <v-icon size="16">mdi-download</v-icon>
                            Export
                        </button>
                        <div style="display: flex; gap: 16px;">
                            <button class="btn btn-error" @click="rejectDocument">
                                Reject
                            </button>
                            <button class="btn btn-success" @click="approveDocument">
                                <v-icon size="16">mdi-check</v-icon>
                                Approve
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Snackbar -->
            <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="3000">
                [[ snackbar.text ]]
            </v-snackbar>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>
    <script>
        const { createApp } = Vue;
        const { createVuetify } = Vuetify;

        const vuetify = createVuetify({
            theme: {
                defaultTheme: 'light'
            }
        });

        const app = createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    uploadedFiles: [],
                    selectedFileIndex: null,
                    isDragging: false,
                    processing: false,
                    results: [],
                    showModal: false,
                    selectedDocument: null,
                    activeTab: 'fields',
                    snackbar: {
                        show: false,
                        text: '',
                        color: 'success'
                    }
                };
            },
            methods: {
                handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    this.addFiles(files);
                },

                handleDrop(event) {
                    this.isDragging = false;
                    const files = Array.from(event.dataTransfer.files);
                    this.addFiles(files);
                },

                addFiles(files) {
                    files.forEach(file => {
                        if (this.isValidFile(file)) {
                            this.uploadedFiles.push(file);
                        } else {
                            this.showSnackbar(`Invalid file type: ${file.name}`, 'error');
                        }
                    });
                },

                isValidFile(file) {
                    const validTypes = ['application/pdf', 'image/jpeg', 'image/png', 'application/zip', 'application/x-zip-compressed'];
                    return validTypes.includes(file.type) || file.name.toLowerCase().endsWith('.zip');
                },

                getFileIcon(filename) {
                    const ext = filename.toLowerCase().split('.').pop();
                    const icons = {
                        'pdf': 'mdi-file-pdf-box',
                        'jpg': 'mdi-file-image',
                        'jpeg': 'mdi-file-image',
                        'png': 'mdi-file-image',
                        'zip': 'mdi-folder-zip'
                    };
                    return icons[ext] || 'mdi-file';
                },

                getFileIconColor(filename) {
                    const ext = filename.toLowerCase().split('.').pop();
                    const colors = {
                        'pdf': 'red',
                        'jpg': 'blue',
                        'jpeg': 'blue',
                        'png': 'green',
                        'zip': 'orange'
                    };
                    return colors[ext] || 'grey';
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                selectFile(index) {
                    this.selectedFileIndex = index;
                },

                removeFile(index) {
                    this.uploadedFiles.splice(index, 1);
                    if (this.selectedFileIndex === index) {
                        this.selectedFileIndex = null;
                    }
                },

                clearAll() {
                    this.uploadedFiles = [];
                    this.selectedFileIndex = null;
                    this.results = [];
                    this.showModal = false;
                    this.selectedDocument = null;
                },

                async classifyDocuments() {
                    if (this.uploadedFiles.length === 0) return;

                    this.processing = true;
                    const formData = new FormData();

                    this.uploadedFiles.forEach(file => {
                        formData.append('files', file);
                    });

                    formData.append('checkCompliance', 'true');

                    try {
                        const response = await fetch('/api/document/classify', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.results = data.results;
                            this.showSnackbar(`Successfully classified ${data.total_files} document(s)`, 'success');
                        } else {
                            this.showSnackbar(data.error || 'Classification failed', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.showSnackbar('An error occurred during classification', 'error');
                    } finally {
                        this.processing = false;
                    }
                },

                getDocumentBadgeClass(type) {
                    const typeMap = {
                        'letter_of_credit': 'badge-lc',
                        'proforma_invoice': 'badge-proforma',
                        'commercial_invoice': 'badge-invoice',
                        'invoice': 'badge-invoice'
                    };
                    return typeMap[type.toLowerCase().replace(/ /g, '_')] || 'result-badge';
                },

                openDocumentModal(document, index) {
                    this.selectedDocument = document;
                    this.showModal = true;
                    this.activeTab = 'fields';
                },

                closeModal() {
                    this.showModal = false;
                    this.selectedDocument = null;
                },

                getDocumentImages() {
                    if (!this.selectedDocument || !this.selectedDocument.preview_images) return [];
                    return this.selectedDocument.preview_images.map(img => {
                        return img.startsWith('data:image/') ? img : 'data:image/png;base64,' + img;
                    });
                },

                getDocumentFields() {
                    if (!this.selectedDocument) return {};
                    return this.selectedDocument.analysis_result?.combined_fields || 
                           this.selectedDocument.extracted_fields || {};
                },

                getFieldValue(field) {
                    if (typeof field === 'object' && field.value !== undefined) {
                        return field.value;
                    }
                    return field || 'N/A';
                },

                formatFieldName(fieldName) {
                    return fieldName
                        .split('_')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                },

                exportDocument() {
                    const report = {
                        file_name: this.selectedDocument.file_name,
                        document_type: this.selectedDocument.document_type,
                        confidence: this.selectedDocument.confidence,
                        extracted_fields: this.getDocumentFields(),
                        compliance: this.selectedDocument.compliance
                    };

                    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedDocument.file_name}_report.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showSnackbar('Document exported successfully', 'success');
                },

                approveDocument() {
                    this.showSnackbar(`Document "${this.selectedDocument.file_name}" approved!`, 'success');
                    this.closeModal();
                },

                rejectDocument() {
                    this.showSnackbar(`Document "${this.selectedDocument.file_name}" rejected!`, 'error');
                    this.closeModal();
                },

                showSnackbar(text, color = 'success') {
                    this.snackbar.text = text;
                    this.snackbar.color = color;
                    this.snackbar.show = true;
                },

                goBack() {
                    window.location.href = '/';
                }
            }
        });

        app.use(vuetify).mount('#app');
    </script>
</body>
</html>