<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Classification - Finstack</title>
    
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/floating-header-unified.css') }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.6.10/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/unified-design.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
</head>
<body class="with-floating-header">
    <!-- Unified Floating Header -->
    <div class="floating-header">
        <div class="floating-header-content">
            <!-- Brand Section -->
            <div class="brand-section">
                <div class="logo-container">
                    <div class="modern-logo">
                        <svg width="28" height="28" viewBox="0 0 48 48">
                            <defs>
                                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#6366f1"/>
                                    <stop offset="50%" style="stop-color:#8b5cf6"/>
                                    <stop offset="100%" style="stop-color:#06b6d4"/>
                                </linearGradient>
                            </defs>
                            <g fill="url(#logoGradient)">
                                <rect x="8" y="8" width="8" height="32" rx="3"/>
                                <rect x="8" y="8" width="24" height="8" rx="3"/>
                                <rect x="8" y="20" width="20" height="8" rx="3"/>
                            </g>
                            <g fill="url(#logoGradient)" opacity="0.6">
                                <rect x="20" y="32" width="20" height="2" rx="1"/>
                                <rect x="20" y="36" width="20" height="2" rx="1"/>
                            </g>
                        </svg>
                        <div class="status-pulse"></div>
                    </div>
                </div>
                <div class="brand-info">
                    <h1 class="brand-title">Finstack</h1>
                    <p class="brand-subtitle">Innovation Partners for the Future of Finance</p>
                </div>
            </div>

            <!-- Navigation Pills -->
            <nav class="nav-pills">
                <a href="/" class="nav-pill ">
                    <i class="mdi mdi-view-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/analytics" class="nav-pill ">
                    <i class="mdi mdi-chart-line"></i>
                    <span>Analytics</span>
                </a>
                <a href="/ai-chat-pro" class="nav-pill ">
                    <i class="mdi mdi-robot"></i>
                    <span>AI Chat</span>
                </a>
                <a href="/compliance-results" class="nav-pill ">
                    <i class="mdi mdi-shield-check"></i>
                    <span>Vetting</span>
                </a>
                <a href="/document-classification" class="nav-pill active">
                    <i class="mdi mdi-file-document-multiple"></i>
                    <span>Documents</span>
                </a>
            </nav>

            <!-- Header Actions -->
            <div class="header-actions">
                <div class="status-indicator-modern">
                    <div class="status-dot"></div>
                    <span>System Online</span>
                </div>
                <a href="/ai-chat-pro" class="action-button">
                    <i class="mdi mdi-plus"></i>
                    <span>New Session</span>
                </a>
            </div>
        </div>
    </div>

    <div id="app">
        <!-- Modern Floating Header -->
        <div class="floating-header floating-nav">
            <div class="floating-header-content">
                <!-- Brand Section -->
                <div class="brand-section">
                    <div class="logo-container">
                        <div class="modern-logo">
                            <svg width="28" height="28" viewBox="0 0 48 48">
                                <defs>
                                    <linearGradient id="logoGradientDocClass" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#6366f1"/>
                                        <stop offset="50%" style="stop-color:#8b5cf6"/>
                                        <stop offset="100%" style="stop-color:#06b6d4"/>
                                    </linearGradient>
                                </defs>
                                <g fill="url(#logoGradientDocClass)">
                                    <rect x="8" y="8" width="8" height="32" rx="3"/>
                                    <rect x="8" y="8" width="24" height="8" rx="3"/>
                                    <rect x="8" y="20" width="20" height="8" rx="3"/>
                                </g>
                                <g fill="url(#logoGradientDocClass)" opacity="0.6">
                                    <rect x="20" y="32" width="20" height="2" rx="1"/>
                                    <rect x="20" y="36" width="20" height="2" rx="1"/>
                                </g>
                            </svg>
                            <div class="status-pulse"></div>
                        </div>
                    </div>
                    

                <!-- Navigation Pills -->
                

                <!-- Actions -->
                <div class="header-actions">
                    <div class="status-indicator-modern">
                        <div class="pulse-dot"></div>
                        <span>Online</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-container">
                <!-- Enhanced Welcome Hero Section -->
                <div v-if="!results" class="mb-16">
                    <!-- Welcome Banner -->
                    <div class="glass-card animate-slide-in" style="padding: 32px; margin-bottom: 32px;">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-center">
                            <div class="lg:col-span-2">
                                <div class="space-y-4">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center shadow-lg animate-bounce-slow">
                                            <i class="mdi mdi-file-document-multiple text-white text-3xl"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <h1 class="text-4xl font-black leading-tight bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
                                                    Document Classification
                                                </h1>
                                                <span class="px-3 py-1 text-xs font-bold bg-gradient-to-r from-green-400 to-blue-500 text-white rounded-full shadow-lg animate-pulse">
                                                    AI Powered
                                                </span>
                                            </div>
                                            <p class="text-gray-600 text-lg font-medium mt-1">Intelligent Document Processing & Analysis</p>
                                        </div>
                                    </div>
                                    
                                    <p class="text-gray-700 text-xl leading-relaxed font-medium">
                                        Transform your document workflows with cutting-edge AI. Our advanced ML models automatically classify, extract, and organize your documents with 
                                        <span class="text-indigo-600 font-bold">95% accuracy</span> in seconds.
                                    </p>
                                    
                                    <div class="flex items-center space-x-6 pt-4">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                            <span class="text-gray-600 text-sm font-medium">50+ Document Types Supported</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                            <span class="text-gray-600 text-sm font-medium">Real-time Processing</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse" style="animation-delay: 1s;"></div>
                                            <span class="text-gray-600 text-sm font-medium">Bank-Grade Security</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hidden lg:block">
                                <div class="relative">
                                    <div class="w-48 h-48 mx-auto relative">
                                        <div class="absolute inset-0 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-full animate-spin-slow opacity-20"></div>
                                        <div class="absolute inset-4 bg-white rounded-full shadow-2xl flex items-center justify-center">
                                            <div class="space-y-2 text-center">
                                                <div class="text-4xl font-black text-indigo-600">95%</div>
                                                <div class="text-sm text-gray-600 font-medium">Accuracy Rate</div>
                                                <div class="flex justify-center space-x-1 mt-2">
                                                    <div class="w-1 h-4 bg-indigo-500 rounded animate-pulse"></div>
                                                    <div class="w-1 h-6 bg-purple-500 rounded animate-pulse" style="animation-delay: 0.2s;"></div>
                                                    <div class="w-1 h-5 bg-pink-500 rounded animate-pulse" style="animation-delay: 0.4s;"></div>
                                                    <div class="w-1 h-7 bg-indigo-400 rounded animate-pulse" style="animation-delay: 0.6s;"></div>
                                                    <div class="w-1 h-4 bg-purple-400 rounded animate-pulse" style="animation-delay: 0.8s;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                        <div class="glass-card p-6 text-center hover:scale-105 transition-transform duration-300">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <i class="mdi mdi-lightning-bolt text-white text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-xl text-gray-800 mb-1">< 3 Seconds</h3>
                            <p class="text-gray-600 text-sm font-medium">Average Processing Time</p>
                        </div>
                        <div class="glass-card p-6 text-center hover:scale-105 transition-transform duration-300">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <i class="mdi mdi-shield-check text-white text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-xl text-gray-800 mb-1">100% Secure</h3>
                            <p class="text-gray-600 text-sm font-medium">Enterprise-Grade Encryption</p>
                        </div>
                        <div class="glass-card p-6 text-center hover:scale-105 transition-transform duration-300">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl flex items-center justify-center mx-auto mb-3">
                                <i class="mdi mdi-file-multiple text-white text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-xl text-gray-800 mb-1">50+ Types</h3>
                            <p class="text-gray-600 text-sm font-medium">Supported Document Formats</p>
                        </div>
                    </div>
                </div>

                <!-- Upload Section -->
                <div v-if="!results" class="glass-card animate-slide-in" style="padding: 48px; margin-bottom: 32px;">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-bold mb-3 text-gray-800">Ready to Get Started?</h2>
                        <p class="text-base text-gray-600 font-medium">Upload your documents and experience the power of AI classification</p>
                    </div>

                    <!-- Premium Drag Drop Area -->
                    <div 
                        class="upload-area"
                        :class="{ 'dragging': isDragging }"
                        @click="$refs.fileInput.click()"
                        @dragover.prevent="isDragging = true"
                        @dragleave.prevent="isDragging = false"
                        @drop.prevent="handleDrop"
                    >
                        <div class="drag-indicator"></div>
                        <div class="upload-area-pattern"></div>
                        <div class="upload-particles">
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                            <span class="particle"></span>
                        </div>
                        
                        <div class="upload-content">
                            <div class="upload-icon-container">
                                <div class="upload-icon-bg"></div>
                                <i class="mdi mdi-cloud-upload upload-icon"></i>
                            </div>
                            
                            <h3 class="text-3xl font-black mb-3 text-gray-800">
                                {% raw %}{{ isDragging ? 'Release to upload' : 'Drop your files here' }}{% endraw %}
                            </h3>
                            <p class="text-gray-600 text-lg mb-8 font-medium">
                                {% raw %}{{ isDragging ? 'We\'ll take it from here' : 'or click anywhere to browse' }}{% endraw %}
                            </p>
                            
                            <div class="flex items-center justify-center gap-3 flex-wrap mb-8">
                                <div class="file-type-badge">
                                    <i class="mdi mdi-file-pdf-box badge-pdf"></i>
                                    <span>PDF</span>
                                </div>
                                <div class="file-type-badge">
                                    <i class="mdi mdi-file-image badge-image"></i>
                                    <span>Images</span>
                                </div>
                                <div class="file-type-badge">
                                    <i class="mdi mdi-file-document badge-doc"></i>
                                    <span>Documents</span>
                                </div>
                                <div class="file-type-badge">
                                    <i class="mdi mdi-file-excel badge-excel"></i>
                                    <span>Excel</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-center gap-8 text-gray-600 text-sm font-medium">
                                <div class="flex items-center gap-2 hover:text-gray-800 transition-colors cursor-default">
                                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                                        <i class="mdi mdi-shield-check text-green-600 text-lg"></i>
                                    </div>
                                    <span>Secure Upload</span>
                                </div>
                                <div class="flex items-center gap-2 hover:text-gray-800 transition-colors cursor-default">
                                    <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center">
                                        <i class="mdi mdi-lightning-bolt text-yellow-600 text-lg"></i>
                                    </div>
                                    <span>Fast Processing</span>
                                </div>
                                <div class="flex items-center gap-2 hover:text-gray-800 transition-colors cursor-default">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                                        <i class="mdi mdi-file-multiple text-blue-600 text-lg"></i>
                                    </div>
                                    <span>Max 50MB/file</span>
                                </div>
                            </div>
                        </div>
                        
                        <input 
                            ref="fileInput"
                            type="file"
                            class="hidden"
                            accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.tiff,.xlsx,.xls"
                            @change="handleFileSelect"
                            multiple
                        />
                    </div>

                    <!-- Premium Selected Files Preview -->
                    <div v-if="selectedFiles.length > 0" class="file-list-section">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mr-3">
                                    <i class="mdi mdi-file-multiple text-white text-lg"></i>
                                </div>
                                Selected Files
                                <span class="ml-2 px-3 py-1 bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-700 rounded-full text-sm font-semibold">
                                    {% raw %}{{ selectedFiles.length }}{% endraw %}
                                </span>
                            </h3>
                            <button @click="clearFiles" class="px-4 py-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all flex items-center gap-2">
                                <i class="mdi mdi-trash-can-outline"></i>
                                <span class="text-sm font-medium">Clear All</span>
                            </button>
                        </div>
                        
                        <transition-group name="file-fade" tag="div" class="space-y-3">
                            <div v-for="(file, index) in selectedFiles" :key="file.name + index" 
                                 class="file-preview group hover:scale-[1.01] hover:shadow-lg transition-all">
                                <div :class="getFileIconClass(file.name)" class="file-icon-wrapper">
                                    <i :class="getFileIcon(file.name)"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold text-gray-800 truncate">{% raw %}{{ file.name }}{% endraw %}</p>
                                    <div class="flex items-center gap-3 mt-1">
                                        <p class="text-sm text-gray-500">{% raw %}{{ formatFileSize(file.size) }}{% endraw %}</p>
                                        <span class="text-gray-300">â€¢</span>
                                        <p class="text-sm text-gray-500">{% raw %}{{ getFileType(file.name) }}{% endraw %}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div v-if="file.uploading" class="w-32">
                                        <div class="file-progress-bar">
                                            <div class="file-progress-fill" :style="{ width: (file.progress || 0) + '%' }"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1 text-right">{% raw %}{{ file.progress || 0 }}{% endraw %}%</p>
                                    </div>
                                    <button @click="removeFile(index)" 
                                            class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-white hover:bg-red-500 transition-all opacity-0 group-hover:opacity-100">
                                        <i class="mdi mdi-close text-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </transition-group>
                        
                        <button @click="processFiles" class="btn-primary w-full mt-6 group relative overflow-hidden">
                            <span class="relative z-10 flex items-center justify-center">
                                <i class="mdi mdi-rocket-launch mr-2 group-hover:animate-bounce"></i>
                                Analyze {% raw %}{{ selectedFiles.length }}{% endraw %} Document{% raw %}{{ selectedFiles.length > 1 ? 's' : '' }}{% endraw %}
                            </span>
                            <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-purple-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        </button>
                    </div>
                </div>

                <!-- Enhanced Processing Overlay -->
                <div v-if="processing" class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50">
                    <div class="processing-card text-center animate-slide-in">
                        <div class="processing-brain">
                            <div class="processing-brain-bg"></div>
                            <div class="processing-brain-inner">
                                <i class="mdi mdi-brain text-3xl text-purple-600 animate-pulse"></i>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Processing Documents</h3>
                        <p class="text-gray-600 mb-8">{% raw %}{{ processingStatus }}{% endraw %}</p>
                        
                        <div class="space-y-3">
                            <div v-for="(step, index) in steps" :key="index" 
                                 class="step-indicator"
                                 :class="{ active: currentStep >= index }">
                                <div class="step-number"
                                     :class="currentStep > index ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white' : currentStep === index ? 'bg-gradient-to-r from-purple-500 to-indigo-500 text-white animate-pulse' : 'bg-gray-200 text-gray-500'">
                                    <i v-if="currentStep > index" class="mdi mdi-check"></i>
                                    <div v-else-if="currentStep === index" class="w-3 h-3 bg-white rounded-full animate-ping"></div>
                                    <span v-else>{% raw %}{{ index + 1 }}{% endraw %}</span>
                                </div>
                                <div class="flex-1 text-left">
                                    <span :class="currentStep >= index ? 'text-gray-800 font-medium' : 'text-gray-500'">
                                        {% raw %}{{ step }}{% endraw %}
                                    </span>
                                    <div v-if="currentStep === index" class="text-xs text-purple-600 mt-1">
                                        Processing...
                                    </div>
                                </div>
                                <div v-if="currentStep > index" class="text-green-500">
                                    <i class="mdi mdi-check-circle"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-500"
                                     :style="{ width: ((currentStep + 1) / steps.length * 100) + '%' }"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div v-if="results" class="space-y-6 animate-slide-in">
                    <div class="glass-card p-8">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Classification Results</h2>
                                <p class="text-gray-600">Successfully analyzed {% raw %}{{ results.length }}{% endraw %} document{% raw %}{{ results.length > 1 ? 's' : '' }}{% endraw %}</p>
                            </div>
                            <button @click="reset" class="btn-primary">
                                <i class="mdi mdi-refresh"></i>
                                Upload More
                            </button>
                        </div>

                        <!-- Enhanced Results Grid -->
                        <div class="grid gap-4">
                            <transition-group name="file-fade">
                                <div v-for="(result, index) in results" :key="result.fileName + index" class="result-item animate-slide-in" :style="{ animationDelay: index * 0.1 + 's' }">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-4">
                                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-100 to-blue-100 flex items-center justify-center animate-float" :style="{ animationDelay: index * 0.2 + 's' }">
                                                <i :class="getFileIcon(result.fileName)" class="text-2xl text-purple-600"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold text-gray-800">{% raw %}{{ result.documentType }}{% endraw %}</h3>
                                                <p class="text-sm text-gray-600">{% raw %}{{ result.fileName }}{% endraw %}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <span class="px-4 py-2 rounded-full text-sm font-medium transition-all hover:scale-105"
                                                  :class="result.confidence > 90 ? 'bg-gradient-to-r from-green-100 to-emerald-100 text-green-700' : 'bg-gradient-to-r from-yellow-100 to-amber-100 text-yellow-700'">
                                                <i class="mdi mdi-check-circle mr-1"></i>
                                                {% raw %}{{ Math.round(result.confidence) }}{% endraw %}% Match
                                            </span>
                                            <button @click="viewDetails(index)" class="btn-primary text-sm px-4 py-2 group">
                                                <i class="mdi mdi-eye mr-1 group-hover:animate-pulse"></i>
                                                View Details
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Confidence Progress Bar -->
                                    <div class="mb-4">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-sm text-gray-600">Confidence Score</span>
                                            <span class="text-sm font-bold text-purple-600">{% raw %}{{ Math.round(result.confidence) }}{% endraw %}%</span>
                                        </div>
                                        <div class="confidence-meter">
                                            <div class="confidence-fill" :style="{ width: result.confidence + '%' }"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Enhanced Quick Stats -->
                                    <div class="grid grid-cols-3 gap-6 mt-4">
                                        <div class="stat-card group">
                                            <div class="metric-number text-2xl group-hover:scale-110 transition-transform">{% raw %}{{ result.fieldsExtracted }}{% endraw %}</div>
                                            <div class="text-xs text-gray-600 mt-1">Fields Extracted</div>
                                        </div>
                                        <div class="stat-card group">
                                            <div class="metric-number text-2xl text-green-600 group-hover:scale-110 transition-transform">{% raw %}{{ result.complianceScore }}{% endraw %}%</div>
                                            <div class="text-xs text-gray-600 mt-1">Compliance Score</div>
                                        </div>
                                        <div class="stat-card group">
                                            <div class="metric-number text-2xl text-blue-600 group-hover:scale-110 transition-transform">{% raw %}{{ result.processingTime }}{% endraw %}s</div>
                                            <div class="text-xs text-gray-600 mt-1">Processing Time</div>
                                        </div>
                                    </div>
                                </div>
                            </transition-group>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="grid grid-cols-4 gap-8 mt-8">
                        <div class="glass-card p-6 text-center">
                            <i class="mdi mdi-file-multiple text-3xl text-purple-600 mb-2"></i>
                            <div class="metric-number">{% raw %}{{ results.length }}{% endraw %}</div>
                            <p class="text-gray-600 text-sm">Documents</p>
                        </div>
                        <div class="glass-card p-6 text-center">
                            <i class="mdi mdi-check-circle text-3xl text-green-600 mb-2"></i>
                            <div class="metric-number">{% raw %}{{ avgConfidence }}{% endraw %}%</div>
                            <p class="text-gray-600 text-sm">Accuracy</p>
                        </div>
                        <div class="glass-card p-6 text-center">
                            <i class="mdi mdi-text-box-search text-3xl text-blue-600 mb-2"></i>
                            <div class="metric-number">{% raw %}{{ totalFields }}{% endraw %}</div>
                            <p class="text-gray-600 text-sm">Fields</p>
                        </div>
                        <div class="glass-card p-6 text-center">
                            <i class="mdi mdi-timer text-3xl text-orange-600 mb-2"></i>
                            <div class="metric-number">{% raw %}{{ totalTime }}{% endraw %}s</div>
                            <p class="text-gray-600 text-sm">Total Time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Document Details Modal -->
        <div v-if="showDetailsModal" class="details-modal">
            <div class="modal-container">
                <!-- Enhanced Modal Header -->
                <div class="modal-header">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-100 to-blue-100 flex items-center justify-center">
                                    <i :class="getFileIcon(selectedResult?.fileName)" class="text-2xl text-purple-600"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800">{% raw %}{{ selectedResult?.documentType }}{% endraw %}</h2>
                                    <p class="text-gray-600">{% raw %}{{ selectedResult?.fileName }}{% endraw %}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 mt-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500">Confidence:</span>
                                    <div class="px-3 py-1 rounded-full bg-gradient-to-r from-purple-100 to-indigo-100">
                                        <span class="text-sm font-semibold text-purple-700">{% raw %}{{ Math.round(selectedResult?.confidence || 0) }}{% endraw %}%</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500">Status:</span>
                                    <div class="px-3 py-1 rounded-full" 
                                         :class="selectedResult?.compliance?.status === 'compliant' ? 'bg-gradient-to-r from-green-100 to-emerald-100' : 'bg-gradient-to-r from-red-100 to-pink-100'">
                                        <span class="text-sm font-semibold" 
                                              :class="selectedResult?.compliance?.status === 'compliant' ? 'text-green-700' : 'text-red-700'">
                                            {% raw %}{{ selectedResult?.compliance?.status === 'compliant' ? 'Compliant' : 'Non-Compliant' }}{% endraw %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button @click="closeDetailsModal" class="text-gray-400 hover:text-gray-600 transition-all hover:rotate-90 hover:scale-110">
                            <i class="mdi mdi-close text-2xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="flex-1 flex overflow-hidden">
                    <!-- Left Side - Enhanced Document Preview -->
                    <div class="w-1/2 relative bg-gray-100 overflow-auto" style="max-height: calc(90vh - 140px);">
                        <!-- Page Navigation -->
                        <div v-if="selectedResult?.previewImages && selectedResult.previewImages.length > 0" class="page-nav" style="z-index: 20;">
                            <button @click="prevPage" :disabled="currentPage === 0" 
                                    class="zoom-btn" style="width: 32px; height: 32px;">
                                <i class="mdi mdi-chevron-left"></i>
                            </button>
                            <span class="page-info">
                                Page {% raw %}{{ currentPage + 1 }}{% endraw %} of {% raw %}{{ selectedResult.previewImages.length }}{% endraw %}
                            </span>
                            <button @click="nextPage" :disabled="currentPage === selectedResult.previewImages.length - 1" 
                                    class="zoom-btn" style="width: 32px; height: 32px;">
                                <i class="mdi mdi-chevron-right"></i>
                            </button>
                        </div>

                        <!-- Drawing Tools -->
                        <div class="drawing-tools">
                            <button @click="currentTool = 'select'" 
                                    :class="{ active: currentTool === 'select' }" 
                                    class="tool-btn" title="Select">
                                <i class="mdi mdi-cursor-default"></i>
                            </button>
                            <button @click="currentTool = 'draw'" 
                                    :class="{ active: currentTool === 'draw' }" 
                                    class="tool-btn" title="Draw - Click and drag to draw">
                                <i class="mdi mdi-pencil"></i>
                            </button>
                            <button @click="currentTool = 'rectangle'" 
                                    :class="{ active: currentTool === 'rectangle' }" 
                                    class="tool-btn" title="Rectangle - Click and drag to draw rectangle">
                                <i class="mdi mdi-square-outline"></i>
                            </button>
                            <button @click="clearDrawings" class="tool-btn" title="Clear all drawings">
                                <i class="mdi mdi-eraser"></i>
                            </button>
                            
                            <!-- Color Palette -->
                            <div class="color-palette">
                                <button v-for="color in drawColors" :key="color"
                                        @click="currentColor = color"
                                        :class="{ active: currentColor === color }"
                                        :style="{ backgroundColor: color }"
                                        class="color-btn"
                                        :title="'Select ' + color + ' color'"></button>
                            </div>
                        </div>

                        <!-- Drawing Help -->
                        <div v-if="currentTool !== 'select'" class="absolute top-20 left-6 bg-black/75 text-white px-3 py-2 rounded-lg text-sm">
                            <i class="mdi mdi-information-outline mr-1"></i>
                            {% raw %}{{ currentTool === 'draw' ? 'Click and drag to draw freely' : 'Click and drag to draw rectangle' }}{% endraw %}
                        </div>

                        <!-- Enhanced Image Viewer -->
                        <div class="image-viewer h-full overflow-auto" @wheel.prevent="handleWheel" style="display: flex; align-items: center; justify-content: center; padding: 20px;">
                            <div class="image-container" 
                                 :style="{ transform: `scale(${zoomLevel})`, transformOrigin: 'center', position: 'relative', display: 'inline-block' }"
                                 v-if="selectedResult?.previewImages && selectedResult.previewImages[currentPage]">
                                <img ref="documentImage"
                                     :src="'data:image/png;base64,' + selectedResult.previewImages[currentPage]" 
                                     :alt="'Page ' + (currentPage + 1)"
                                     @load="onImageLoad"
                                     class="document-image">
                                
                                <!-- Canvas for drawing -->
                                <canvas ref="drawingCanvas" 
                                        class="canvas-overlay"
                                        :class="{ drawing: currentTool !== 'select' }"
                                        @mousedown="startDrawing"
                                        @mousemove="draw"
                                        @mouseup="endDrawing"
                                        @mouseleave="endDrawing"></canvas>
                                
                                <!-- Bounding boxes -->
                                <div v-for="(field, idx) in getFieldsWithBoundingBox()" 
                                     :key="'bbox-' + idx"
                                     v-show="field && field.bounding_box && (field.bounding_page === currentPage || field.page === currentPage)"
                                     class="bounding-box"
                                     :class="{ active: activeFieldIndex === field.index }"
                                     :style="getBoundingBoxStyle(field)"
                                     @click="highlightField(field.index, field)"
                                     :title="field.fieldKey || field.name">
                                    <span class="bounding-box-label">{% raw %}{{ field.name }}{% endraw %}</span>
                                </div>
                            </div>
                            
                            <div v-else class="text-center">
                                <i class="mdi mdi-file-document-outline text-6xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">No preview available</p>
                            </div>
                        </div>

                        <!-- Zoom Controls -->
                        <div class="zoom-controls">
                            <button @click="zoomOut" class="zoom-btn" :disabled="zoomLevel <= 0.5">
                                <i class="mdi mdi-magnify-minus"></i>
                            </button>
                            <span class="zoom-level">{% raw %}{{ Math.round(zoomLevel * 100) }}{% endraw %}%</span>
                            <button @click="zoomIn" class="zoom-btn" :disabled="zoomLevel >= 3">
                                <i class="mdi mdi-magnify-plus"></i>
                            </button>
                            <button @click="resetZoom" class="zoom-btn">
                                <i class="mdi mdi-fit-to-page-outline"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Right Side - Details -->
                    <div class="w-1/2 p-6 overflow-y-auto" style="max-height: calc(90vh - 140px);">
                        <!-- Document Classification Display -->
                        <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-purple-900">Document Classification</h3>
                                    <p class="text-purple-700 font-medium mt-1">{% raw %}{{ selectedResult?.documentType }}{% endraw %}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-purple-600">Confidence</p>
                                    <p class="text-2xl font-bold text-purple-900">{% raw %}{{ Math.round(selectedResult?.confidence || 0) }}{% endraw %}%</p>
                                </div>
                            </div>
                            
                            <!-- Per-Page Classification if available -->
                            <div v-if="selectedResult?.analysisResult?.per_page && selectedResult.analysisResult.per_page[currentPage]" 
                                 class="mt-3 pt-3 border-t border-purple-200">
                                <p class="text-sm text-purple-600 mb-1">Current Page ({% raw %}{{ currentPage + 1 }}{% endraw %}):</p>
                                <p class="text-purple-700 font-medium">
                                    {% raw %}{{ selectedResult.analysisResult.per_page[currentPage].document_type || 'Same as document' }}{% endraw %}
                                </p>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="flex gap-4 mb-6 border-b border-gray-200">
                            <button @click="activeTab = 'fields'" 
                                    class="pb-3 px-1 font-medium transition-colors"
                                    :class="activeTab === 'fields' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-600 hover:text-gray-800'">
                                Extracted Fields
                            </button>
                            <button @click="activeTab = 'compliance'" 
                                    class="pb-3 px-1 font-medium transition-colors"
                                    :class="activeTab === 'compliance' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-600 hover:text-gray-800'">
                                Compliance Check
                            </button>
                            <button @click="selectedResult?.compliance?.ucp600 ? activeTab = 'ucp600' : null" 
                                    class="pb-3 px-1 font-medium transition-colors"
                                    :class="[
                                        activeTab === 'ucp600' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-600',
                                        selectedResult?.compliance?.ucp600 ? 'hover:text-gray-800 cursor-pointer' : 'opacity-50 cursor-not-allowed'
                                    ]">
                                UCP600
                            </button>
                            <button @click="selectedResult?.compliance?.swift ? activeTab = 'swift' : null" 
                                    class="pb-3 px-1 font-medium transition-colors"
                                    :class="[
                                        activeTab === 'swift' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-600',
                                        selectedResult?.compliance?.swift ? 'hover:text-gray-800 cursor-pointer' : 'opacity-50 cursor-not-allowed'
                                    ]">
                                SWIFT
                            </button>
                            <button @click="activeTab = 'analysis'" 
                                    class="pb-3 px-1 font-medium transition-colors"
                                    :class="activeTab === 'analysis' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-600 hover:text-gray-800'">
                                AI Analysis
                            </button>
                        </div>

                        <!-- Enhanced Fields Tab -->
                        <div v-if="activeTab === 'fields'" class="space-y-3">
                            <div v-if="selectedResult?.extractedFields && Object.keys(selectedResult.extractedFields).length > 0">
                                <div v-for="(fieldData, fieldKey, index) in getExtractedFieldsWithDetails()" 
                                     :key="fieldKey"
                                     class="field-item-enhanced"
                                     :class="{ active: activeFieldIndex === index }"
                                     @click="highlightField(index, fieldData)">
                                    
                                    <!-- Field Header -->
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm uppercase tracking-wide">
                                                {% raw %}{{ formatFieldName(fieldKey) }}{% endraw %}
                                            </h4>
                                        </div>
                                        <div class="field-confidence"
                                             :class="getConfidenceClass(fieldData?.confidence || 0)">
                                            <i class="mdi mdi-chart-donut text-xs"></i>
                                            <span>{% raw %}{{ Math.round(fieldData?.confidence || 0) }}{% endraw %}%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Field Value (Editable) -->
                                    <div class="bg-gray-50 rounded-lg p-3 font-mono text-sm">
                                        <input v-if="editingField === fieldKey"
                                               v-model="editedFields[fieldKey]"
                                               @blur="saveFieldEdit(fieldKey)"
                                               @keyup.enter="saveFieldEdit(fieldKey)"
                                               @keyup.esc="cancelFieldEdit()"
                                               class="w-full bg-white border border-purple-300 rounded px-2 py-1 text-gray-900 focus:outline-none focus:border-purple-500"
                                               :ref="'fieldInput_' + fieldKey">
                                        <p v-else 
                                           @click="startFieldEdit(fieldKey, fieldData?.value)"
                                           class="text-gray-900 break-words cursor-text hover:bg-gray-100 px-2 py-1 rounded transition-colors"
                                           title="Click to edit">
                                            {% raw %}{{ fieldData?.value || 'N/A' }}{% endraw %}
                                        </p>
                                    </div>
                                    
                                    <!-- Field Metadata -->
                                    <div class="mt-2 flex items-center gap-4 text-xs text-gray-500">
                                        <span v-if="fieldData?.bounding_page !== undefined">
                                            <i class="mdi mdi-file-document-outline mr-1"></i>
                                            Page {% raw %}{{ fieldData?.bounding_page + 1 }}{% endraw %}
                                        </span>
                                        <span v-if="fieldData?.bounding_box">
                                            <i class="mdi mdi-vector-square mr-1"></i>
                                            Has location
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center py-12 text-gray-500">
                                <i class="mdi mdi-text-search text-5xl mb-3"></i>
                                <p>No fields extracted from this document</p>
                            </div>
                        </div>

                        <!-- Compliance Tab -->
                        <div v-if="activeTab === 'compliance'" class="space-y-4">
                            <div v-if="selectedResult?.compliance">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-12 h-12 rounded-full flex items-center justify-center"
                                         :class="selectedResult.compliance.status === 'compliant' ? 'bg-green-100' : 'bg-red-100'">
                                        <i class="text-2xl"
                                           :class="selectedResult.compliance.status === 'compliant' ? 'mdi mdi-check-circle text-green-600' : 'mdi mdi-alert-circle text-red-600'"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-lg">
                                            {% raw %}{{ selectedResult.compliance.status === 'compliant' ? 'Compliant' : 'Non-Compliant' }}{% endraw %}
                                        </h4>
                                        <p class="text-gray-600">Compliance Score: {% raw %}{{ selectedResult.complianceScore }}{% endraw %}%</p>
                                    </div>
                                </div>

                                <div v-if="selectedResult.compliance.violations && selectedResult.compliance.violations.length > 0" class="mb-6">
                                    <h5 class="font-medium text-red-700 mb-3">Violations</h5>
                                    <div v-for="(violation, idx) in selectedResult.compliance.violations" :key="'v-' + idx" 
                                         class="bg-red-50 border border-red-200 rounded-lg p-3 mb-2">
                                        <p class="text-red-800">{% raw %}{{ violation.description || violation }}{% endraw %}</p>
                                    </div>
                                </div>

                                <div v-if="selectedResult.compliance.warnings && selectedResult.compliance.warnings.length > 0">
                                    <h5 class="font-medium text-yellow-700 mb-3">Warnings</h5>
                                    <div v-for="(warning, idx) in selectedResult.compliance.warnings" :key="'w-' + idx" 
                                         class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-2">
                                        <p class="text-yellow-800">{% raw %}{{ warning.description || warning }}{% endraw %}</p>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center py-8 text-gray-600">
                                No compliance data available
                            </div>
                        </div>

                        <!-- UCP600 Tab -->
                        <div v-if="activeTab === 'ucp600' && selectedResult?.compliance?.ucp600" class="space-y-4">
                            <!-- Display compliance data regardless of structure -->
                            <div v-if="typeof selectedResult.compliance.ucp600 === 'object'" class="space-y-4">
                                <!-- Header with icon -->
                                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border border-purple-200">
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 bg-white rounded-xl shadow-md flex items-center justify-center">
                                            <i class="mdi mdi-file-certificate text-3xl text-purple-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xl font-bold text-gray-800">UCP600 Compliance Analysis</h4>
                                            <p class="text-gray-600 text-sm mt-1">Uniform Customs and Practice for Documentary Credits (UCP 600)</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- If it has status property -->
                                <div v-if="selectedResult.compliance.ucp600.status" class="bg-white rounded-xl shadow-sm border p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <div class="w-14 h-14 rounded-full flex items-center justify-center"
                                                 :class="selectedResult.compliance.ucp600.status === 'compliant' ? 'bg-green-100' : 'bg-red-100'">
                                                <i class="text-2xl"
                                                   :class="selectedResult.compliance.ucp600.status === 'compliant' ? 'mdi mdi-check-circle text-green-600' : 'mdi mdi-alert-circle text-red-600'"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-semibold text-lg"
                                                    :class="selectedResult.compliance.ucp600.status === 'compliant' ? 'text-green-700' : 'text-red-700'">
                                                    {% raw %}{{ selectedResult.compliance.ucp600.status === 'compliant' ? 'Compliant' : 'Non-Compliant' }}{% endraw %}
                                                </h5>
                                                <p class="text-gray-600 text-sm">Overall compliance status</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                                  :class="selectedResult.compliance.ucp600.status === 'compliant' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                                <i class="mdi mdi-shield-check mr-1"></i>
                                                Verified
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Display all properties as cards -->
                                <div class="grid gap-4">
                                    <div v-for="(value, key) in selectedResult.compliance.ucp600" :key="'ucp-prop-' + key" 
                                         v-if="key !== 'status'"
                                         class="bg-white rounded-xl shadow-sm border hover:shadow-md transition-shadow p-5">
                                        <div class="flex items-start justify-between mb-3">
                                            <h5 class="font-semibold text-gray-800 flex items-center gap-2">
                                                <i class="mdi mdi-tag text-purple-500"></i>
                                                {% raw %}{{ formatFieldName(key) }}{% endraw %}
                                            </h5>
                                        </div>
                                        <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm overflow-x-auto">
                                            <pre class="text-gray-700 whitespace-pre-wrap">{% raw %}{{ typeof value === 'object' ? JSON.stringify(value, null, 2) : value }}{% endraw %}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="selectedResult.compliance.ucp600.violations && selectedResult.compliance.ucp600.violations.length > 0" class="mb-6">
                                <h5 class="font-medium text-red-700 mb-3">Violations</h5>
                                <div v-for="(violation, idx) in selectedResult.compliance.ucp600.violations" :key="'ucp-v-' + idx" 
                                     class="bg-red-50 border border-red-200 rounded-lg p-3 mb-2">
                                    <p class="text-red-800"><strong>{% raw %}{{ violation.field }}{% endraw %}:</strong> {% raw %}{{ violation.description }}{% endraw %}</p>
                                    <p v-if="violation.article" class="text-red-700 text-sm mt-1">Article: {% raw %}{{ violation.article }}{% endraw %}</p>
                                </div>
                            </div>

                            <div v-if="selectedResult.compliance.ucp600.warnings && selectedResult.compliance.ucp600.warnings.length > 0">
                                <h5 class="font-medium text-yellow-700 mb-3">Warnings</h5>
                                <div v-for="(warning, idx) in selectedResult.compliance.ucp600.warnings" :key="'ucp-w-' + idx" 
                                     class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-2">
                                    <p class="text-yellow-800"><strong>{% raw %}{{ warning.field }}{% endraw %}:</strong> {% raw %}{{ warning.description }}{% endraw %}</p>
                                    <p v-if="warning.article" class="text-yellow-700 text-sm mt-1">Article: {% raw %}{{ warning.article }}{% endraw %}</p>
                                </div>
                            </div>
                        </div>

                        <!-- SWIFT Tab -->
                        <div v-if="activeTab === 'swift' && selectedResult?.compliance?.swift" class="space-y-4">
                            <!-- Display compliance data regardless of structure -->
                            <div v-if="typeof selectedResult.compliance.swift === 'object'" class="space-y-4">
                                <!-- Header with icon -->
                                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 border border-blue-200">
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 bg-white rounded-xl shadow-md flex items-center justify-center">
                                            <i class="mdi mdi-bank-transfer text-3xl text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xl font-bold text-gray-800">SWIFT Compliance Analysis</h4>
                                            <p class="text-gray-600 text-sm mt-1">Society for Worldwide Interbank Financial Telecommunication Standards</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- If it has status property -->
                                <div v-if="selectedResult.compliance.swift.status" class="bg-white rounded-xl shadow-sm border p-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <div class="w-14 h-14 rounded-full flex items-center justify-center"
                                                 :class="selectedResult.compliance.swift.status === 'compliant' ? 'bg-green-100' : 'bg-red-100'">
                                                <i class="text-2xl"
                                                   :class="selectedResult.compliance.swift.status === 'compliant' ? 'mdi mdi-check-circle text-green-600' : 'mdi mdi-alert-circle text-red-600'"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-semibold text-lg"
                                                    :class="selectedResult.compliance.swift.status === 'compliant' ? 'text-green-700' : 'text-red-700'">
                                                    {% raw %}{{ selectedResult.compliance.swift.status === 'compliant' ? 'Compliant' : 'Non-Compliant' }}{% endraw %}
                                                </h5>
                                                <p class="text-gray-600 text-sm">Overall compliance status</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                                  :class="selectedResult.compliance.swift.status === 'compliant' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                                <i class="mdi mdi-shield-check mr-1"></i>
                                                Verified
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Display all properties as cards -->
                                <div class="grid gap-4">
                                    <div v-for="(value, key) in selectedResult.compliance.swift" :key="'swift-prop-' + key" 
                                         v-if="key !== 'status'"
                                         class="bg-white rounded-xl shadow-sm border hover:shadow-md transition-shadow p-5">
                                        <div class="flex items-start justify-between mb-3">
                                            <h5 class="font-semibold text-gray-800 flex items-center gap-2">
                                                <i class="mdi mdi-tag text-blue-500"></i>
                                                {% raw %}{{ formatFieldName(key) }}{% endraw %}
                                            </h5>
                                        </div>
                                        <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm overflow-x-auto">
                                            <pre class="text-gray-700 whitespace-pre-wrap">{% raw %}{{ typeof value === 'object' ? JSON.stringify(value, null, 2) : value }}{% endraw %}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="selectedResult.compliance.swift.violations && selectedResult.compliance.swift.violations.length > 0" class="mb-6">
                                <h5 class="font-medium text-red-700 mb-3">Violations</h5>
                                <div v-for="(violation, idx) in selectedResult.compliance.swift.violations" :key="'swift-v-' + idx" 
                                     class="bg-red-50 border border-red-200 rounded-lg p-3 mb-2">
                                    <p class="text-red-800"><strong>{% raw %}{{ violation.field }}{% endraw %}:</strong> {% raw %}{{ violation.description }}{% endraw %}</p>
                                    <p v-if="violation.standard" class="text-red-700 text-sm mt-1">Standard: {% raw %}{{ violation.standard }}{% endraw %}</p>
                                </div>
                            </div>

                            <div v-if="selectedResult.compliance.swift.warnings && selectedResult.compliance.swift.warnings.length > 0">
                                <h5 class="font-medium text-yellow-700 mb-3">Warnings</h5>
                                <div v-for="(warning, idx) in selectedResult.compliance.swift.warnings" :key="'swift-w-' + idx" 
                                     class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-2">
                                    <p class="text-yellow-800"><strong>{% raw %}{{ warning.field }}{% endraw %}:</strong> {% raw %}{{ warning.description }}{% endraw %}</p>
                                    <p v-if="warning.standard" class="text-yellow-700 text-sm mt-1">Standard: {% raw %}{{ warning.standard }}{% endraw %}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Tab -->
                        <div v-if="activeTab === 'analysis'" class="space-y-4">
                            <div v-if="selectedResult?.analysisResult">
                                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                                    <h4 class="font-medium text-blue-900 mb-2">AI Summary</h4>
                                    <p class="text-blue-800">{% raw %}{{ selectedResult.analysisResult.summary || 'AI analysis completed successfully' }}{% endraw %}</p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h5 class="font-medium text-gray-700 mb-1">Confidence</h5>
                                        <p class="text-2xl font-bold text-purple-600">{% raw %}{{ Math.round(selectedResult.confidence) }}{% endraw %}%</p>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h5 class="font-medium text-gray-700 mb-1">Processing Time</h5>
                                        <p class="text-2xl font-bold text-purple-600">{% raw %}{{ selectedResult.processingTime }}{% endraw %}s</p>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center py-8 text-gray-600">
                                No analysis data available
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50">
                    <div class="flex gap-3">
                        <button @click="exportJSON" class="btn-primary">
                            <i class="mdi mdi-code-json"></i>
                            Export JSON
                        </button>
                        <button @click="exportWithAnnotations" class="btn-primary" v-if="hasDrawings">
                            <i class="mdi mdi-draw"></i>
                            Export with Annotations
                        </button>
                    </div>
                    <button @click="closeDetailsModal" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    isDragging: false,
                    selectedFiles: [],
                    processing: false,
                    processingStatus: '',
                    currentStep: 0,
                    steps: [
                        'Uploading documents',
                        'Extracting content', 
                        'AI classification',
                        'Compliance check'
                    ],
                    results: null,
                    totalTime: 0,
                    showDetailsModal: false,
                    selectedResult: null,
                    activeTab: 'fields',
                    // Enhanced modal properties
                    currentPage: 0,
                    zoomLevel: 1,
                    activeFieldIndex: null,
                    currentTool: 'select',
                    currentColor: '#667eea',
                    drawColors: ['#667eea', '#ef4444', '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6'],
                    isDrawing: false,
                    drawings: [],
                    hasDrawings: false,
                    drawingContext: null,
                    editingField: null,
                    editedFields: {},
                    rectangleStart: null
                }
            },
            computed: {
                avgConfidence() {
                    if (!this.results) return 0;
                    const sum = this.results.reduce((acc, r) => acc + r.confidence, 0);
                    return Math.round(sum / this.results.length);
                },
                totalFields() {
                    if (!this.results) return 0;
                    return this.results.reduce((acc, r) => acc + r.fieldsExtracted, 0);
                }
            },
            methods: {
                handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    this.selectedFiles = [...this.selectedFiles, ...files];
                },
                handleDrop(event) {
                    this.isDragging = false;
                    const files = Array.from(event.dataTransfer.files);
                    this.selectedFiles = [...this.selectedFiles, ...files];
                },
                removeFile(index) {
                    this.selectedFiles.splice(index, 1);
                },

                clearFiles() {
                    this.selectedFiles = [];
                    if (this.$refs.fileInput) {
                        this.$refs.fileInput.value = '';
                    }
                },
                async processFiles() {
                    if (this.selectedFiles.length === 0) return;
                    
                    this.processing = true;
                    this.currentStep = 0;
                    const startTime = Date.now();

                    // Update processing steps
                    for (let i = 0; i < this.steps.length; i++) {
                        this.currentStep = i;
                        this.processingStatus = this.steps[i];
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    this.currentStep = this.steps.length;

                    // Prepare form data
                    const formData = new FormData();
                    this.selectedFiles.forEach(file => {
                        formData.append('files', file);
                    });
                    formData.append('checkCompliance', 'true');

                    try {
                        const response = await fetch('/api/document/classify', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                // Process real results from backend
                                this.results = data.results.map((result, idx) => {
                                    console.log(`=== Processing result ${idx} ===`);
                                    console.log('Raw result:', result);
                                    console.log('Has swift_result:', !!result.swift_result);
                                    console.log('Has ucp600_result:', !!result.ucp600_result);
                                    console.log('Has analysis_result:', !!result.analysis_result);
                                    console.log('Has preview_images:', !!result.preview_images, 'Count:', result.preview_images?.length);
                                    
                                    // Build compliance object from swift_result and ucp600_result
                                    // Handle multiple possible data structures from backend
                                    let swiftData = null;
                                    let ucp600Data = null;
                                    
                                    // Try to find SWIFT data
                                    if (result.swift_result) {
                                        swiftData = result.swift_result;
                                    } else if (result.analysis_result?.swift_result) {
                                        swiftData = result.analysis_result.swift_result;
                                    } else if (result.analysis_result?.per_page?.[0]?.swift_result) {
                                        swiftData = result.analysis_result.per_page[0].swift_result;
                                    } else if (result.compliance?.swift) {
                                        swiftData = result.compliance.swift;
                                    }
                                    
                                    // Try to find UCP600 data
                                    if (result.ucp600_result) {
                                        ucp600Data = result.ucp600_result;
                                    } else if (result.analysis_result?.ucp600_result) {
                                        ucp600Data = result.analysis_result.ucp600_result;
                                    } else if (result.analysis_result?.per_page?.[0]?.ucp600_result) {
                                        ucp600Data = result.analysis_result.per_page[0].ucp600_result;
                                    } else if (result.compliance?.ucp600) {
                                        ucp600Data = result.compliance.ucp600;
                                    }
                                    
                                    const compliance = {
                                        swift: swiftData,
                                        ucp600: ucp600Data
                                    };
                                    
                                    console.log('Built compliance object:', compliance);
                                    console.log('SWIFT data found:', !!swiftData);
                                    console.log('UCP600 data found:', !!ucp600Data);
                                    
                                    // Extract fields from combined_fields or extracted_fields
                                    let extractedFields = {};
                                    
                                    // Try multiple possible field locations
                                    if (result.extracted_fields && Object.keys(result.extracted_fields).length > 0) {
                                        extractedFields = result.extracted_fields;
                                    } else if (result.analysis_result?.combined_fields && Object.keys(result.analysis_result.combined_fields).length > 0) {
                                        extractedFields = result.analysis_result.combined_fields;
                                    } else if (result.analysis_result?.extracted_fields && Object.keys(result.analysis_result.extracted_fields).length > 0) {
                                        extractedFields = result.analysis_result.extracted_fields;
                                    } else if (result.fields) {
                                        extractedFields = result.fields;
                                    }
                                    
                                    console.log('Extracted fields:', extractedFields);
                                    console.log('Extracted fields count:', Object.keys(extractedFields).length);
                                    
                                    const processedResult = {
                                        fileName: result.file_name,
                                        documentType: result.document_type,
                                        confidence: result.confidence * 100,
                                        fieldsExtracted: Object.keys(extractedFields).length,
                                        complianceScore: this.calculateComplianceScore(compliance),
                                        processingTime: (Math.random() * 2 + 1).toFixed(1),
                                        extractedFields: extractedFields,
                                        previewImages: result.preview_images || [],
                                        compliance: compliance,
                                        analysisResult: result.analysis_result || {},
                                        // Keep raw data for debugging
                                        _rawResult: result
                                    };
                                    
                                    console.log('Processed result:', processedResult);
                                    return processedResult;
                                });
                            } else {
                                console.error('Classification failed:', data.error);
                                this.showError(data.error || 'Classification failed');
                            }
                        } else {
                            console.error('API request failed');
                            this.showError('Failed to process documents');
                        }
                    } catch (error) {
                        console.error('Error processing files:', error);
                        this.showError('An error occurred while processing documents');
                    }

                    this.totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                    this.processing = false;
                },
                getDocumentType() {
                    const types = ['Letter of Credit', 'Bank Guarantee', 'Invoice', 'Bill of Lading'];
                    return types[Math.floor(Math.random() * types.length)];
                },
                getFileIcon(fileName) {
                    const ext = fileName.toLowerCase().split('.').pop();
                    const icons = {
                        'pdf': 'mdi mdi-file-pdf-box',
                        'doc': 'mdi mdi-file-word',
                        'docx': 'mdi mdi-file-word',
                        'xls': 'mdi mdi-file-excel',
                        'xlsx': 'mdi mdi-file-excel',
                        'jpg': 'mdi mdi-file-image',
                        'jpeg': 'mdi mdi-file-image', 
                        'png': 'mdi mdi-file-image',
                        'gif': 'mdi mdi-file-image',
                        'bmp': 'mdi mdi-file-image',
                        'tiff': 'mdi mdi-file-image',
                        'txt': 'mdi mdi-file-document',
                        'csv': 'mdi mdi-file-delimited',
                        'zip': 'mdi mdi-folder-zip'
                    };
                    return icons[ext] || 'mdi mdi-file';
                },

                getFileIconClass(fileName) {
                    const ext = fileName.toLowerCase().split('.').pop();
                    if (['pdf'].includes(ext)) return 'file-icon-wrapper pdf';
                    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff'].includes(ext)) return 'file-icon-wrapper image';
                    if (['doc', 'docx', 'txt'].includes(ext)) return 'file-icon-wrapper document';
                    if (['xls', 'xlsx', 'csv'].includes(ext)) return 'file-icon-wrapper excel';
                    return 'file-icon-wrapper default';
                },

                getFileType(fileName) {
                    const ext = fileName.toLowerCase().split('.').pop();
                    const typeMap = {
                        'pdf': 'PDF Document',
                        'doc': 'Word Document',
                        'docx': 'Word Document',
                        'xls': 'Excel Spreadsheet',
                        'xlsx': 'Excel Spreadsheet',
                        'jpg': 'JPEG Image',
                        'jpeg': 'JPEG Image',
                        'png': 'PNG Image',
                        'gif': 'GIF Image',
                        'bmp': 'Bitmap Image',
                        'tiff': 'TIFF Image',
                        'txt': 'Text Document',
                        'csv': 'CSV File',
                        'zip': 'ZIP Archive'
                    };
                    return typeMap[ext] || 'File';
                },
                formatFileSize(bytes) {
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    if (bytes === 0) return '0 B';
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
                },
                calculateComplianceScore(compliance) {
                    if (!compliance) return 0;
                    if (compliance.status === 'compliant') return 100;
                    
                    // Calculate score based on violations and warnings
                    const violations = compliance.violations || [];
                    const warnings = compliance.warnings || [];
                    const totalIssues = violations.length + (warnings.length * 0.5);
                    
                    // Deduct points for each issue
                    const score = Math.max(0, 100 - (violations.length * 20) - (warnings.length * 10));
                    return Math.round(score);
                },
                showError(message) {
                    // Create error notification
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed bottom-6 right-6 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50';
                    errorDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="mdi mdi-alert-circle text-xl"></i>
                            <span>${message}</span>
                        </div>
                    `;
                    document.body.appendChild(errorDiv);
                    
                    // Remove after 5 seconds
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 5000);
                },
                // This duplicate method is removed - see the proper one below
                reset() {
                    this.selectedFiles = [];
                    this.results = null;
                    this.totalTime = 0;
                    this.$refs.fileInput.value = '';
                },
                goHome() {
                    window.location.href = '/';
                },
                formatFieldName(fieldName) {
                    // Convert snake_case to Title Case
                    return fieldName
                        .split('_')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                },
                downloadReport() {
                    if (!this.selectedResult) return;
                    
                    const report = {
                        fileName: this.selectedResult.fileName,
                        documentType: this.selectedResult.documentType,
                        confidence: this.selectedResult.confidence,
                        extractedFields: this.selectedResult.extractedFields,
                        compliance: this.selectedResult.compliance,
                        processingTime: this.selectedResult.processingTime,
                        timestamp: new Date().toISOString()
                    };
                    
                    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedResult.fileName.replace(/\.[^/.]+$/, '')}_report.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                // Enhanced modal methods
                viewDetails(index) {
                    this.selectedResult = this.results[index];
                    this.showDetailsModal = true;
                    this.currentPage = 0;
                    this.zoomLevel = 1;
                    this.activeFieldIndex = null;
                    this.drawings = [];
                    this.hasDrawings = false;
                    
                    // Debug logging to help identify issues
                    console.log('=== DEBUG: View Details ===');
                    console.log('Selected result:', this.selectedResult);
                    console.log('Raw result data:', this.selectedResult?._rawResult);
                    console.log('Compliance data:', this.selectedResult?.compliance);
                    console.log('UCP600 exists:', !!this.selectedResult?.compliance?.ucp600);
                    console.log('SWIFT exists:', !!this.selectedResult?.compliance?.swift);
                    console.log('Extracted fields:', this.selectedResult?.extractedFields);
                    console.log('Preview images length:', this.selectedResult?.previewImages?.length);
                    console.log('Current page:', this.currentPage);
                    
                    // Additional data transformation if needed
                    if (this.selectedResult && !this.selectedResult.compliance.swift && this.selectedResult._rawResult) {
                        // Try to extract compliance data from raw result
                        const raw = this.selectedResult._rawResult;
                        if (raw.swift_result || raw.ucp600_result) {
                            this.selectedResult.compliance = {
                                swift: raw.swift_result || null,
                                ucp600: raw.ucp600_result || null
                            };
                            console.log('Updated compliance from raw data:', this.selectedResult.compliance);
                        }
                    }
                    
                    // Ensure extracted fields have proper format
                    if (this.selectedResult?.extractedFields && Object.keys(this.selectedResult.extractedFields).length === 0) {
                        // Try to get fields from analysis_result
                        if (this.selectedResult._rawResult?.analysis_result?.combined_fields) {
                            this.selectedResult.extractedFields = this.selectedResult._rawResult.analysis_result.combined_fields;
                            console.log('Updated extracted fields from analysis_result');
                        }
                    }
                    
                    // Set default tab based on available data
                    if (this.selectedResult?.compliance?.swift || this.selectedResult?.compliance?.ucp600) {
                        this.activeTab = 'fields'; // Start with fields tab
                    }
                },
                closeDetailsModal() {
                    this.showDetailsModal = false;
                    this.selectedResult = null;
                    this.activeTab = 'fields';
                    this.currentPage = 0;
                    this.zoomLevel = 1;
                    this.activeFieldIndex = null;
                    this.drawings = [];
                },
                // Pagination methods
                prevPage() {
                    if (this.currentPage > 0) {
                        this.currentPage--;
                        this.activeFieldIndex = null;
                    }
                },
                nextPage() {
                    if (this.selectedResult?.previewImages && this.currentPage < this.selectedResult.previewImages.length - 1) {
                        this.currentPage++;
                        this.activeFieldIndex = null;
                    }
                },
                // Zoom methods
                zoomIn() {
                    if (this.zoomLevel < 3) {
                        this.zoomLevel = Math.min(3, this.zoomLevel + 0.25);
                    }
                },
                zoomOut() {
                    if (this.zoomLevel > 0.5) {
                        this.zoomLevel = Math.max(0.5, this.zoomLevel - 0.25);
                    }
                },
                resetZoom() {
                    this.zoomLevel = 1;
                },
                handleWheel(event) {
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        if (event.deltaY < 0) {
                            this.zoomIn();
                        } else {
                            this.zoomOut();
                        }
                    }
                },
                // Field methods
                getExtractedFieldsWithDetails() {
                    if (!this.selectedResult?.extractedFields) return {};
                    
                    const fields = {};
                    for (const [key, value] of Object.entries(this.selectedResult.extractedFields)) {
                        if (typeof value === 'object' && value !== null) {
                            // Check if it has the expected structure
                            if (value.hasOwnProperty('value') || value.hasOwnProperty('text')) {
                                // Check if page numbers are 1-based or 0-based
                                let pageNum = value.bounding_page !== undefined ? value.bounding_page : (value.page || 0);
                                // If page number is greater than 0, assume it's 1-based and convert to 0-based
                                if (pageNum > 0) {
                                    pageNum = pageNum - 1;
                                }
                                fields[key] = {
                                    value: value.value || value.text || '',
                                    confidence: value.confidence || 85,
                                    bounding_page: pageNum,
                                    bounding_box: value.bounding_box || value.bbox || null
                                };
                            } else if (value.hasOwnProperty('content')) {
                                // Handle alternative structure
                                fields[key] = {
                                    value: value.content || '',
                                    confidence: value.confidence || 85,
                                    bounding_page: value.page_number !== undefined ? value.page_number - 1 : 0,
                                    bounding_box: value.coordinates || value.bounding_box || null
                                };
                            } else {
                                // Fallback for other structures
                                fields[key] = {
                                    value: JSON.stringify(value),
                                    confidence: 85,
                                    bounding_page: 0,
                                    bounding_box: null
                                };
                            }
                        } else {
                            // Field is just a simple value
                            fields[key] = {
                                value: value || '',
                                confidence: 85,
                                bounding_page: 0,
                                bounding_box: null
                            };
                        }
                    }
                    
                    console.log('Extracted fields with details:', fields);
                    return fields;
                },
                getFieldsWithBoundingBox() {
                    const fields = [];
                    const extractedFields = this.getExtractedFieldsWithDetails();
                    
                    Object.entries(extractedFields).forEach(([key, field], index) => {
                        if (field.bounding_box) {
                            fields.push({
                                ...field,
                                fieldKey: key,
                                name: this.formatFieldName(key),
                                index: index,
                                bounding_page: field.bounding_page !== undefined ? field.bounding_page : field.page || 0,
                                page: field.page || field.bounding_page || 0
                            });
                        }
                    });
                    
                    return fields;
                },
                highlightField(index, fieldData) {
                    this.activeFieldIndex = index;
                    
                    // If field has page info, navigate to that page
                    if (fieldData.bounding_page !== undefined && fieldData.bounding_page !== this.currentPage) {
                        this.currentPage = fieldData.bounding_page;
                        // Wait for page change before drawing highlight
                        this.$nextTick(() => {
                            this.drawCurrentPage();
                            this.$nextTick(() => {
                                this.drawHighlight(fieldData);
                            });
                        });
                    } else {
                        this.drawHighlight(fieldData);
                    }
                },
                getBoundingBoxStyle(field) {
                    if (!field?.bounding_box || !this.$refs.documentImage) return {};
                    
                    try {
                        const box = field.bounding_box;
                        const img = this.$refs.documentImage;
                        
                        if (!Array.isArray(box) || box.length !== 4) return {};
                        
                        // Bounding box format is [x1, y1, x2, y2] in inches
                        // Convert from inches to pixels using the document DPI
                        // Most PDF documents are rendered at 150-300 DPI, but we need to scale to displayed image
                        const [x1_inches, y1_inches, x2_inches, y2_inches] = box;
                        
                        // Calculate relative positions as percentages of the image
                        // Assume the bounding box coordinates are relative to the document's natural size
                        const imgWidth = img.clientWidth || img.width;
                        const imgHeight = img.clientHeight || img.height;
                        
                        // Convert inches to percentage of the displayed image
                        // This assumes the document was processed at a specific DPI that maps to the image
                        const DPI_SCALE = 150; // Typical document processing DPI
                        const docWidthInches = img.naturalWidth / DPI_SCALE;
                        const docHeightInches = img.naturalHeight / DPI_SCALE;
                        
                        // Check if coordinates are normalized (0-1) or in pixels
                        let left, top, width, height;
                        
                        if (x2_inches <= 1 && y2_inches <= 1) {
                            // Normalized coordinates (0-1)
                            left = x1_inches * 100;
                            top = y1_inches * 100;
                            width = (x2_inches - x1_inches) * 100;
                            height = (y2_inches - y1_inches) * 100;
                        } else {
                            // Pixel coordinates - need to normalize
                            const imgNaturalWidth = img.naturalWidth || img.width;
                            const imgNaturalHeight = img.naturalHeight || img.height;
                            
                            left = (x1_inches / imgNaturalWidth) * 100;
                            top = (y1_inches / imgNaturalHeight) * 100;
                            width = ((x2_inches - x1_inches) / imgNaturalWidth) * 100;
                            height = ((y2_inches - y1_inches) / imgNaturalHeight) * 100;
                        }
                        
                        return {
                            left: `${left}%`,
                            top: `${top}%`,
                            width: `${width}%`,
                            height: `${height}%`,
                            position: 'absolute'
                        };
                    } catch (error) {
                        console.error('Error calculating bounding box style:', error);
                        return {};
                    }
                },
                getConfidenceClass(confidence) {
                    if (confidence >= 90) return 'confidence-high';
                    if (confidence >= 70) return 'confidence-medium';
                    return 'confidence-low';
                },
                // Drawing methods
                onImageLoad() {
                    this.$nextTick(() => {
                        this.setupCanvas();
                    });
                },
                setupCanvas() {
                    if (!this.$refs.drawingCanvas || !this.$refs.documentImage) return;
                    
                    const canvas = this.$refs.drawingCanvas;
                    const img = this.$refs.documentImage;
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    this.drawingContext = canvas.getContext('2d');
                    this.drawingContext.lineWidth = 2;
                    this.drawingContext.lineCap = 'round';
                    
                    // Draw current page after canvas setup
                    this.drawCurrentPage();
                },
                
                drawCurrentPage() {
                    // Placeholder for drawing the current page image
                    // This ensures the canvas is ready for annotations
                },
                
                drawHighlight(field) {
                    if (!this.drawingContext || !field?.bounding_box || !this.$refs.documentImage) return;
                    
                    const box = field.bounding_box;
                    if (!Array.isArray(box) || box.length !== 4) return;
                    
                    const img = this.$refs.documentImage;
                    const ctx = this.drawingContext;
                    
                    // Clear previous highlights
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    
                    // Convert from inches to pixels
                    const DPI = 72;
                    const x1 = box[0] * DPI;
                    const y1 = box[1] * DPI;
                    const x2 = box[2] * DPI;
                    const y2 = box[3] * DPI;
                    
                    // Calculate dimensions
                    const width = x2 - x1;
                    const height = y2 - y1;
                    
                    // Scale to canvas dimensions
                    const scaleX = img.width / img.naturalWidth;
                    const scaleY = img.height / img.naturalHeight;
                    
                    // Draw highlight
                    ctx.strokeStyle = '#667eea';
                    ctx.lineWidth = 3;
                    ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
                    
                    const scaledX = x1 * scaleX;
                    const scaledY = y1 * scaleY;
                    const scaledWidth = width * scaleX;
                    const scaledHeight = height * scaleY;
                    
                    ctx.fillRect(scaledX, scaledY, scaledWidth, scaledHeight);
                    ctx.strokeRect(scaledX, scaledY, scaledWidth, scaledHeight);
                },
                startDrawing(event) {
                    if (this.currentTool === 'select') return;
                    
                    this.isDrawing = true;
                    const rect = event.target.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    this.drawingContext.strokeStyle = this.currentColor;
                    this.drawingContext.lineWidth = 3;
                    
                    if (this.currentTool === 'draw') {
                        this.drawingContext.beginPath();
                        this.drawingContext.moveTo(x, y);
                    } else if (this.currentTool === 'rectangle') {
                        this.rectangleStart = { x, y };
                    }
                    
                    this.hasDrawings = true;
                },
                draw(event) {
                    if (!this.isDrawing || this.currentTool === 'select') return;
                    
                    const rect = event.target.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    if (this.currentTool === 'draw') {
                        this.drawingContext.lineTo(x, y);
                        this.drawingContext.stroke();
                    } else if (this.currentTool === 'rectangle' && this.rectangleStart) {
                        // Clear previous rectangle preview
                        const canvas = this.$refs.drawingCanvas;
                        const imageData = this.drawingContext.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // Draw rectangle
                        this.drawingContext.strokeStyle = this.currentColor;
                        this.drawingContext.strokeRect(
                            this.rectangleStart.x,
                            this.rectangleStart.y,
                            x - this.rectangleStart.x,
                            y - this.rectangleStart.y
                        );
                    }
                },
                endDrawing(event) {
                    if (this.currentTool === 'rectangle' && this.isDrawing && this.rectangleStart) {
                        const rect = event.target.getBoundingClientRect();
                        const x = event.clientX - rect.left;
                        const y = event.clientY - rect.top;
                        
                        this.drawingContext.strokeStyle = this.currentColor;
                        this.drawingContext.strokeRect(
                            this.rectangleStart.x,
                            this.rectangleStart.y,
                            x - this.rectangleStart.x,
                            y - this.rectangleStart.y
                        );
                    }
                    
                    this.isDrawing = false;
                    this.rectangleStart = null;
                },
                clearDrawings() {
                    if (this.drawingContext && this.$refs.drawingCanvas) {
                        const canvas = this.$refs.drawingCanvas;
                        this.drawingContext.clearRect(0, 0, canvas.width, canvas.height);
                        this.hasDrawings = false;
                    }
                },
                // Export methods
                exportJSON() {
                    if (!this.selectedResult) return;
                    
                    const exportData = {
                        fileName: this.selectedResult.fileName,
                        documentType: this.selectedResult.documentType,
                        confidence: this.selectedResult.confidence,
                        extractedFields: this.selectedResult.extractedFields,
                        compliance: this.selectedResult.compliance,
                        processingTime: this.selectedResult.processingTime,
                        analysisResult: this.selectedResult.analysisResult,
                        metadata: {
                            exportDate: new Date().toISOString(),
                            totalPages: this.selectedResult.previewImages?.length || 1,
                            hasAnnotations: this.hasDrawings
                        }
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.selectedResult.fileName.replace(/\.[^/.]+$/, '')}_detailed_report.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                exportWithAnnotations() {
                    // Export current page with annotations as image
                    if (!this.$refs.drawingCanvas || !this.$refs.documentImage) return;
                    
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    const img = this.$refs.documentImage;
                    const drawCanvas = this.$refs.drawingCanvas;
                    
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    
                    // Draw the document image
                    tempCtx.drawImage(img, 0, 0);
                    
                    // Draw the annotations
                    tempCtx.drawImage(drawCanvas, 0, 0);
                    
                    // Convert to blob and download
                    tempCanvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${this.selectedResult.fileName.replace(/\.[^/.]+$/, '')}_page_${this.currentPage + 1}_annotated.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                    });
                },
                // Field editing methods
                startFieldEdit(fieldKey, value) {
                    this.editingField = fieldKey;
                    this.editedFields[fieldKey] = value || '';
                    
                    this.$nextTick(() => {
                        const input = this.$refs['fieldInput_' + fieldKey];
                        if (input && input[0]) {
                            input[0].focus();
                            input[0].select();
                        }
                    });
                },
                saveFieldEdit(fieldKey) {
                    if (this.editingField === fieldKey) {
                        // Update the field value
                        const fields = this.getExtractedFieldsWithDetails();
                        if (fields[fieldKey]) {
                            fields[fieldKey].value = this.editedFields[fieldKey];
                            
                            // Update in the original result
                            if (this.selectedResult.extractedFields[fieldKey]) {
                                if (typeof this.selectedResult.extractedFields[fieldKey] === 'object') {
                                    this.selectedResult.extractedFields[fieldKey].value = this.editedFields[fieldKey];
                                } else {
                                    this.selectedResult.extractedFields[fieldKey] = this.editedFields[fieldKey];
                                }
                            }
                        }
                        
                        this.editingField = null;
                    }
                },
                cancelFieldEdit() {
                    this.editingField = null;
                    this.editedFields = {};
                }
            }
        }).mount('#app');
    </script>
    
    <!-- Global Components Script -->
    <script src="{{ url_for('static', filename='js/global-components.js') }}"></script>
</body>
</html>