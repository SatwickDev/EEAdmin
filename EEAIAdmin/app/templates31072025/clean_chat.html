<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - Clean Version</title>
    
    <!-- CSS -->
    
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/floating-header-unified.css') }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.6.10/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/unified-design.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
  <style>
    body {
      padding-top: 100px;
    }
    @media (max-width: 768px) {
      body {
        padding-top: 80px;
      }
    }
  </style>
</head>
<body class="with-floating-header">
    <!-- Unified Floating Header -->
    <div class="floating-header">
        <div class="floating-header-content">
            <!-- Brand Section -->
            <div class="brand-section">
                <div class="logo-container">
                    <div class="modern-logo">
                        <svg width="28" height="28" viewBox="0 0 48 48">
                            <defs>
                                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#6366f1"/>
                                    <stop offset="50%" style="stop-color:#8b5cf6"/>
                                    <stop offset="100%" style="stop-color:#06b6d4"/>
                                </linearGradient>
                            </defs>
                            <g fill="url(#logoGradient)">
                                <rect x="8" y="8" width="8" height="32" rx="3"/>
                                <rect x="8" y="8" width="24" height="8" rx="3"/>
                                <rect x="8" y="20" width="20" height="8" rx="3"/>
                            </g>
                            <g fill="url(#logoGradient)" opacity="0.6">
                                <rect x="20" y="32" width="20" height="2" rx="1"/>
                                <rect x="20" y="36" width="20" height="2" rx="1"/>
                            </g>
                        </svg>
                        <div class="status-pulse"></div>
                    </div>
                </div>
                <div class="brand-info">
                    <h1 class="brand-title">Finstack</h1>
                    <p class="brand-subtitle">Innovation Partners for the Future of Finance</p>
                </div>
            </div>

            <!-- Navigation Pills -->
            <nav class="nav-pills">
                <a href="/" class="nav-pill ">
                    <i class="mdi mdi-view-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/analytics" class="nav-pill ">
                    <i class="mdi mdi-chart-line"></i>
                    <span>Analytics</span>
                </a>
                <a href="/ai-chat-pro" class="nav-pill active">
                    <i class="mdi mdi-robot"></i>
                    <span>AI Chat</span>
                </a>
                <a href="/compliance-results" class="nav-pill ">
                    <i class="mdi mdi-shield-check"></i>
                    <span>Vetting</span>
                </a>
                <a href="/document-classification" class="nav-pill ">
                    <i class="mdi mdi-file-document-multiple"></i>
                    <span>Documents</span>
                </a>
            </nav>

            <!-- Header Actions -->
            <div class="header-actions">
                <div class="status-indicator-modern">
                    <div class="status-dot"></div>
                    <span>System Online</span>
                </div>
                <a href="/ai-chat-pro" class="action-button">
                    <i class="mdi mdi-plus"></i>
                    <span>New Session</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Hidden user ID field -->
    <input type="hidden" id="userId" value="{{ user_id }}">
    
    <!-- Toggle button for mobile -->
    <button class="toggle-sessions" id="toggleSessions">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sessions panel will be inserted here by JavaScript -->
    
    <!-- Main chat container -->
    <div class="chat-container">
        <div class="chat-header">
            <h1>AI Assistant</h1>
            <p>Chat without manual functionality</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be displayed here -->
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            AI is typing...
        </div>
        
        <div class="chat-input-container">
            <form class="chat-input-form" id="chatForm">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Type your message..."
                    autocomplete="off"
                    required
                >
                <button type="submit" class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </form>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/session-manager.js') }}"></script>
    <script>
        // Clean chat implementation without manual functionality
        class CleanChat {
            constructor() {
                this.chatMessages = document.getElementById('chatMessages');
                this.chatForm = document.getElementById('chatForm');
                this.chatInput = document.getElementById('chatInput');
                this.sendButton = document.getElementById('sendButton');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.userId = document.getElementById('userId').value;
                this.currentSessionId = localStorage.getItem('currentSessionId') || this.generateSessionId();
                
                this.init();
            }
            
            init() {
                // Form submission
                this.chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });
                
                // Listen for session events
                window.addEventListener('sessionLoaded', (e) => {
                    this.loadSessionMessages(e.detail.messages);
                });
                
                window.addEventListener('sessionDeleted', (e) => {
                    if (e.detail.sessionId === this.currentSessionId) {
                        this.clearChat();
                        this.currentSessionId = this.generateSessionId();
                    }
                });
                
                window.addEventListener('allSessionsDeleted', () => {
                    this.clearChat();
                    this.currentSessionId = this.generateSessionId();
                });
                
                // Mobile toggle
                document.getElementById('toggleSessions')?.addEventListener('click', () => {
                    document.querySelector('.sessions-panel')?.classList.toggle('open');
                });
            }
            
            generateSessionId() {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 9);
                const sessionId = `session_${timestamp}_${random}`;
                localStorage.setItem('currentSessionId', sessionId);
                return sessionId;
            }
            
            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message) return;
                
                // Disable input
                this.chatInput.disabled = true;
                this.sendButton.disabled = true;
                
                // Add user message to chat
                this.addMessage(message, 'user');
                
                // Clear input
                this.chatInput.value = '';
                
                // Show typing indicator
                this.typingIndicator.classList.add('show');
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            user_id: this.userId,
                            session_id: this.currentSessionId
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to send message');
                    }
                    
                    const data = await response.json();
                    
                    // Add assistant response
                    this.addMessage(data.response, 'assistant');
                    
                    // Refresh sessions list if needed
                    if (window.sessionManager) {
                        window.sessionManager.loadSessions();
                    }
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.addMessage('Sorry, an error occurred. Please try again.', 'assistant');
                } finally {
                    // Re-enable input
                    this.chatInput.disabled = false;
                    this.sendButton.disabled = false;
                    this.chatInput.focus();
                    
                    // Hide typing indicator
                    this.typingIndicator.classList.remove('show');
                }
            }
            
            addMessage(content, role) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                messageDiv.textContent = content;
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            loadSessionMessages(messages) {
                this.clearChat();
                messages.forEach(msg => {
                    this.addMessage(msg.message, msg.role);
                });
            }
            
            clearChat() {
                this.chatMessages.innerHTML = '';
            }
            
            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
        }
        
        // Initialize chat when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.cleanChat = new CleanChat();
        });
    </script>
</body>
</html>